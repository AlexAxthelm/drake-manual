<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>The User Manual of the drake R Package</title>
  <meta name="description" content="The User Manual of the drake R Package">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="The User Manual of the drake R Package" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="The User Manual of the drake R Package" />
  
  
  

<meta name="author" content="Will Landau">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="vis.html">
<link rel="next" href="time.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Installation</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#set-the-stage."><i class="fa fa-check"></i><b>2.1</b> Set the stage.</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#make-your-results."><i class="fa fa-check"></i><b>2.2</b> Make your results.</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#go-back-and-fix-things."><i class="fa fa-check"></i><b>2.3</b> Go back and fix things.</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#try-it-yourself"><i class="fa fa-check"></i><b>2.4</b> Try it yourself!</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="example-packages.html"><a href="example-packages.html"><i class="fa fa-check"></i><b>3</b> Example: R package download trends</a><ul>
<li class="chapter" data-level="3.1" data-path="example-packages.html"><a href="example-packages.html#get-the-code."><i class="fa fa-check"></i><b>3.1</b> Get the code.</a></li>
<li class="chapter" data-level="3.2" data-path="example-packages.html"><a href="example-packages.html#overview"><i class="fa fa-check"></i><b>3.2</b> Overview</a></li>
<li class="chapter" data-level="3.3" data-path="example-packages.html"><a href="example-packages.html#analysis"><i class="fa fa-check"></i><b>3.3</b> Analysis</a></li>
<li class="chapter" data-level="3.4" data-path="example-packages.html"><a href="example-packages.html#what-remote-data-sources-in-general"><i class="fa fa-check"></i><b>3.4</b> What remote data sources in general?</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="example-gsp.html"><a href="example-gsp.html"><i class="fa fa-check"></i><b>4</b> Example: gross state products</a><ul>
<li class="chapter" data-level="4.1" data-path="example-gsp.html"><a href="example-gsp.html#get-the-code.-1"><i class="fa fa-check"></i><b>4.1</b> Get the code.</a></li>
<li class="chapter" data-level="4.2" data-path="example-gsp.html"><a href="example-gsp.html#objective-and-methods"><i class="fa fa-check"></i><b>4.2</b> Objective and methods</a></li>
<li class="chapter" data-level="4.3" data-path="example-gsp.html"><a href="example-gsp.html#data"><i class="fa fa-check"></i><b>4.3</b> Data</a></li>
<li class="chapter" data-level="4.4" data-path="example-gsp.html"><a href="example-gsp.html#analysis-1"><i class="fa fa-check"></i><b>4.4</b> Analysis</a></li>
<li class="chapter" data-level="4.5" data-path="example-gsp.html"><a href="example-gsp.html#results"><i class="fa fa-check"></i><b>4.5</b> Results</a></li>
<li class="chapter" data-level="4.6" data-path="example-gsp.html"><a href="example-gsp.html#comparison-with-gnu-make"><i class="fa fa-check"></i><b>4.6</b> Comparison with GNU Make</a></li>
<li class="chapter" data-level="4.7" data-path="example-gsp.html"><a href="example-gsp.html#references"><i class="fa fa-check"></i><b>4.7</b> References</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="mtcars.html"><a href="mtcars.html"><i class="fa fa-check"></i><b>5</b> The mtcars example and workflow plan generation</a><ul>
<li class="chapter" data-level="5.1" data-path="mtcars.html"><a href="mtcars.html#get-the-code.-2"><i class="fa fa-check"></i><b>5.1</b> Get the code.</a></li>
<li class="chapter" data-level="5.2" data-path="mtcars.html"><a href="mtcars.html#quick-examples"><i class="fa fa-check"></i><b>5.2</b> Quick examples</a></li>
<li class="chapter" data-level="5.3" data-path="mtcars.html"><a href="mtcars.html#the-motivation-of-the-mtcars-example"><i class="fa fa-check"></i><b>5.3</b> The motivation of the mtcars example</a></li>
<li class="chapter" data-level="5.4" data-path="mtcars.html"><a href="mtcars.html#set-up-the-mtcars-example"><i class="fa fa-check"></i><b>5.4</b> Set up the mtcars example</a></li>
<li class="chapter" data-level="5.5" data-path="mtcars.html"><a href="mtcars.html#the-workflow-plan-data-frame"><i class="fa fa-check"></i><b>5.5</b> The workflow plan data frame</a></li>
<li class="chapter" data-level="5.6" data-path="mtcars.html"><a href="mtcars.html#generate-the-workflow-plan"><i class="fa fa-check"></i><b>5.6</b> Generate the workflow plan</a></li>
<li class="chapter" data-level="5.7" data-path="mtcars.html"><a href="mtcars.html#flexible-workflow-plan-generation"><i class="fa fa-check"></i><b>5.7</b> Flexible workflow plan generation</a></li>
<li class="chapter" data-level="5.8" data-path="mtcars.html"><a href="mtcars.html#run-the-workflow"><i class="fa fa-check"></i><b>5.8</b> Run the workflow</a></li>
<li class="chapter" data-level="5.9" data-path="mtcars.html"><a href="mtcars.html#automatic-watching-for-changed-dependencies"><i class="fa fa-check"></i><b>5.9</b> Automatic watching for changed dependencies</a></li>
<li class="chapter" data-level="5.10" data-path="mtcars.html"><a href="mtcars.html#a-note-on-tidy-evaluation"><i class="fa fa-check"></i><b>5.10</b> A note on tidy evaluation</a></li>
<li class="chapter" data-level="5.11" data-path="mtcars.html"><a href="mtcars.html#need-more-speed"><i class="fa fa-check"></i><b>5.11</b> Need more speed?</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="best-practices.html"><a href="best-practices.html"><i class="fa fa-check"></i><b>6</b> General best practices for drake projects</a><ul>
<li class="chapter" data-level="6.1" data-path="best-practices.html"><a href="best-practices.html#how-to-organize-your-files"><i class="fa fa-check"></i><b>6.1</b> How to organize your files</a><ul>
<li class="chapter" data-level="6.1.1" data-path="best-practices.html"><a href="best-practices.html#examples"><i class="fa fa-check"></i><b>6.1.1</b> Examples</a></li>
<li class="chapter" data-level="6.1.2" data-path="best-practices.html"><a href="best-practices.html#where-do-you-put-your-code"><i class="fa fa-check"></i><b>6.1.2</b> Where do you put your code?</a></li>
<li class="chapter" data-level="6.1.3" data-path="best-practices.html"><a href="best-practices.html#remember-your-commands-are-code-chunks-not-r-scripts"><i class="fa fa-check"></i><b>6.1.3</b> Remember: your commands are code chunks, not R scripts</a></li>
<li class="chapter" data-level="6.1.4" data-path="best-practices.html"><a href="best-practices.html#file-output-targets"><i class="fa fa-check"></i><b>6.1.4</b> File output targets</a></li>
<li class="chapter" data-level="6.1.5" data-path="best-practices.html"><a href="best-practices.html#r-markdown-and-knitr-reports"><i class="fa fa-check"></i><b>6.1.5</b> R Markdown and knitr reports</a></li>
<li class="chapter" data-level="6.1.6" data-path="best-practices.html"><a href="best-practices.html#workflows-as-r-packages"><i class="fa fa-check"></i><b>6.1.6</b> Workflows as R packages</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="best-practices.html"><a href="best-practices.html#generating-workflow-plan-data-frames"><i class="fa fa-check"></i><b>6.2</b> Generating workflow plan data frames</a></li>
<li class="chapter" data-level="6.3" data-path="best-practices.html"><a href="best-practices.html#remote-data-sources"><i class="fa fa-check"></i><b>6.3</b> Remote data sources</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="debug.html"><a href="debug.html"><i class="fa fa-check"></i><b>7</b> Debugging and testing drake projects</a><ul>
<li class="chapter" data-level="7.1" data-path="debug.html"><a href="debug.html#the-configuration-list"><i class="fa fa-check"></i><b>7.1</b> The configuration list</a></li>
<li class="chapter" data-level="7.2" data-path="debug.html"><a href="debug.html#plan-your-work."><i class="fa fa-check"></i><b>7.2</b> Plan your work.</a><ul>
<li class="chapter" data-level="7.2.1" data-path="debug.html"><a href="debug.html#workflow-plan-data-frames"><i class="fa fa-check"></i><b>7.2.1</b> Workflow plan data frames</a></li>
<li class="chapter" data-level="7.2.2" data-path="debug.html"><a href="debug.html#visualize-your-workflow."><i class="fa fa-check"></i><b>7.2.2</b> Visualize your workflow.</a></li>
<li class="chapter" data-level="7.2.3" data-path="debug.html"><a href="debug.html#check-dependency-relationships."><i class="fa fa-check"></i><b>7.2.3</b> Check dependency relationships.</a></li>
<li class="chapter" data-level="7.2.4" data-path="debug.html"><a href="debug.html#outdated-up-to-date-and-missing-items"><i class="fa fa-check"></i><b>7.2.4</b> Outdated, up to date, and missing items</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="debug.html"><a href="debug.html#test-with-triggers."><i class="fa fa-check"></i><b>7.3</b> Test with triggers.</a></li>
<li class="chapter" data-level="7.4" data-path="debug.html"><a href="debug.html#skipping-imports"><i class="fa fa-check"></i><b>7.4</b> Skipping imports</a></li>
<li class="chapter" data-level="7.5" data-path="debug.html"><a href="debug.html#impose-timeouts-and-retries"><i class="fa fa-check"></i><b>7.5</b> Impose timeouts and retries</a></li>
<li class="chapter" data-level="7.6" data-path="debug.html"><a href="debug.html#diagnose-failures."><i class="fa fa-check"></i><b>7.6</b> Diagnose failures.</a><ul>
<li class="chapter" data-level="7.6.1" data-path="debug.html"><a href="debug.html#tidy-evaluation-a-caveat-to-diagnosing-interactively"><i class="fa fa-check"></i><b>7.6.1</b> Tidy evaluation: a caveat to diagnosing interactively</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="debug.html"><a href="debug.html#debrief-a-build-session."><i class="fa fa-check"></i><b>7.7</b> Debrief a build session.</a></li>
<li class="chapter" data-level="7.8" data-path="debug.html"><a href="debug.html#start-tinkering."><i class="fa fa-check"></i><b>7.8</b> Start tinkering.</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="vis.html"><a href="vis.html"><i class="fa fa-check"></i><b>8</b> Visualization with drake</a><ul>
<li class="chapter" data-level="8.1" data-path="vis.html"><a href="vis.html#dependency-reactivity"><i class="fa fa-check"></i><b>8.1</b> Dependency reactivity</a></li>
<li class="chapter" data-level="8.2" data-path="vis.html"><a href="vis.html#subgraphs"><i class="fa fa-check"></i><b>8.2</b> Subgraphs</a></li>
<li class="chapter" data-level="8.3" data-path="vis.html"><a href="vis.html#parallel-computing-visualized"><i class="fa fa-check"></i><b>8.3</b> Parallel computing visualized</a></li>
<li class="chapter" data-level="8.4" data-path="vis.html"><a href="vis.html#control-the-legend."><i class="fa fa-check"></i><b>8.4</b> Control the legend.</a></li>
<li class="chapter" data-level="8.5" data-path="vis.html"><a href="vis.html#more-flexibility"><i class="fa fa-check"></i><b>8.5</b> More flexibility</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>9</b> High-performance computing with drake</a><ul>
<li class="chapter" data-level="9.1" data-path="hpc.html"><a href="hpc.html#batch-mode-for-long-workflows"><i class="fa fa-check"></i><b>9.1</b> Batch mode for long workflows</a></li>
<li class="chapter" data-level="9.2" data-path="hpc.html"><a href="hpc.html#let-drake-schedule-your-targets."><i class="fa fa-check"></i><b>9.2</b> Let drake schedule your targets.</a></li>
<li class="chapter" data-level="9.3" data-path="hpc.html"><a href="hpc.html#parallel-backends"><i class="fa fa-check"></i><b>9.3</b> Parallel backends</a></li>
<li class="chapter" data-level="9.4" data-path="hpc.html"><a href="hpc.html#local-workers"><i class="fa fa-check"></i><b>9.4</b> Local workers</a></li>
<li class="chapter" data-level="9.5" data-path="hpc.html"><a href="hpc.html#remote-workers"><i class="fa fa-check"></i><b>9.5</b> Remote workers</a><ul>
<li class="chapter" data-level="9.5.1" data-path="hpc.html"><a href="hpc.html#future-and-future_lapply"><i class="fa fa-check"></i><b>9.5.1</b> <code>&quot;future&quot;</code> and <code>&quot;future_lapply&quot;</code></a></li>
<li class="chapter" data-level="9.5.2" data-path="hpc.html"><a href="hpc.html#makefile"><i class="fa fa-check"></i><b>9.5.2</b> <code>&quot;Makefile&quot;</code></a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="hpc.html"><a href="hpc.html#scheduling-algorithms"><i class="fa fa-check"></i><b>9.6</b> Scheduling algorithms</a><ul>
<li class="chapter" data-level="9.6.1" data-path="hpc.html"><a href="hpc.html#persistent-scheduling"><i class="fa fa-check"></i><b>9.6.1</b> Persistent scheduling</a></li>
<li class="chapter" data-level="9.6.2" data-path="hpc.html"><a href="hpc.html#transient-scheduling"><i class="fa fa-check"></i><b>9.6.2</b> Transient scheduling</a></li>
<li class="chapter" data-level="9.6.3" data-path="hpc.html"><a href="hpc.html#staged-scheduling"><i class="fa fa-check"></i><b>9.6.3</b> Staged scheduling</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="hpc.html"><a href="hpc.html#final-thoughts"><i class="fa fa-check"></i><b>9.7</b> Final thoughts</a><ul>
<li class="chapter" data-level="9.7.1" data-path="hpc.html"><a href="hpc.html#debugging"><i class="fa fa-check"></i><b>9.7.1</b> Debugging</a></li>
<li class="chapter" data-level="9.7.2" data-path="hpc.html"><a href="hpc.html#drake-as-an-ordinary-job-scheduler"><i class="fa fa-check"></i><b>9.7.2</b> Drake as an ordinary job scheduler</a></li>
<li class="chapter" data-level="9.7.3" data-path="hpc.html"><a href="hpc.html#more-resources"><i class="fa fa-check"></i><b>9.7.3</b> More resources</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="hpc.html"><a href="hpc.html#footnotes"><i class="fa fa-check"></i><b>9.8</b> Footnotes</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="time.html"><a href="time.html"><i class="fa fa-check"></i><b>10</b> Time: logging, prediction, and strategy</a><ul>
<li class="chapter" data-level="10.1" data-path="time.html"><a href="time.html#predict-total-runtime"><i class="fa fa-check"></i><b>10.1</b> Predict total runtime</a></li>
<li class="chapter" data-level="10.2" data-path="time.html"><a href="time.html#strategize-your-high-performance-computing"><i class="fa fa-check"></i><b>10.2</b> Strategize your high-performance computing</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="store.html"><a href="store.html"><i class="fa fa-check"></i><b>11</b> Storage</a><ul>
<li class="chapter" data-level="11.1" data-path="store.html"><a href="store.html#caches"><i class="fa fa-check"></i><b>11.1</b> Caches</a></li>
<li class="chapter" data-level="11.2" data-path="store.html"><a href="store.html#hash-algorithms"><i class="fa fa-check"></i><b>11.2</b> Hash algorithms</a></li>
<li class="chapter" data-level="11.3" data-path="store.html"><a href="store.html#which-hash-algorithm-should-you-choose"><i class="fa fa-check"></i><b>11.3</b> Which hash algorithm should you choose?</a></li>
<li class="chapter" data-level="11.4" data-path="store.html"><a href="store.html#select-the-hash-algorithms-of-the-cache"><i class="fa fa-check"></i><b>11.4</b> Select the hash algorithms of the cache</a></li>
<li class="chapter" data-level="11.5" data-path="store.html"><a href="store.html#using-storr-directly"><i class="fa fa-check"></i><b>11.5</b> Using <code>storr</code> directly</a></li>
<li class="chapter" data-level="11.6" data-path="store.html"><a href="store.html#cleaning-up"><i class="fa fa-check"></i><b>11.6</b> Cleaning up</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="caution.html"><a href="caution.html"><i class="fa fa-check"></i><b>12</b> Cautionary notes</a><ul>
<li class="chapter" data-level="12.1" data-path="caution.html"><a href="caution.html#projects-built-with-drake-4.4.0-are-not-back-compatible-with-drake-4.4.0."><i class="fa fa-check"></i><b>12.1</b> Projects built with drake &lt;= 4.4.0 are not back compatible with drake &gt; 4.4.0.</a></li>
<li class="chapter" data-level="12.2" data-path="caution.html"><a href="caution.html#workflow-plans"><i class="fa fa-check"></i><b>12.2</b> Workflow plans</a><ul>
<li class="chapter" data-level="12.2.1" data-path="caution.html"><a href="caution.html#externalizing-commands-in-r-script-files"><i class="fa fa-check"></i><b>12.2.1</b> Externalizing commands in R script files</a></li>
<li class="chapter" data-level="12.2.2" data-path="caution.html"><a href="caution.html#commands-are-not-perfectly-flexible."><i class="fa fa-check"></i><b>12.2.2</b> Commands are NOT perfectly flexible.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="caution.html"><a href="caution.html#execution"><i class="fa fa-check"></i><b>12.3</b> Execution</a><ul>
<li class="chapter" data-level="12.3.1" data-path="caution.html"><a href="caution.html#install-drake-properly."><i class="fa fa-check"></i><b>12.3.1</b> Install <code>drake</code> properly.</a></li>
<li class="chapter" data-level="12.3.2" data-path="caution.html"><a href="caution.html#install-all-your-packages."><i class="fa fa-check"></i><b>12.3.2</b> Install all your packages.</a></li>
<li class="chapter" data-level="12.3.3" data-path="caution.html"><a href="caution.html#a-note-on-tidy-evaluation-1"><i class="fa fa-check"></i><b>12.3.3</b> A note on tidy evaluation</a></li>
<li class="chapter" data-level="12.3.4" data-path="caution.html"><a href="caution.html#find-and-diagnose-your-errors."><i class="fa fa-check"></i><b>12.3.4</b> Find and diagnose your errors.</a></li>
<li class="chapter" data-level="12.3.5" data-path="caution.html"><a href="caution.html#refresh-the-drake_config-list-early-and-often."><i class="fa fa-check"></i><b>12.3.5</b> Refresh the <code>drake_config()</code> list early and often.</a></li>
<li class="chapter" data-level="12.3.6" data-path="caution.html"><a href="caution.html#workflows-as-r-packages."><i class="fa fa-check"></i><b>12.3.6</b> Workflows as R packages.</a></li>
<li class="chapter" data-level="12.3.7" data-path="caution.html"><a href="caution.html#the-lazy_load-flag-does-not-work-with-parlapply-parallelism."><i class="fa fa-check"></i><b>12.3.7</b> The <code>lazy_load</code> flag does not work with <code>&quot;parLapply&quot;</code> parallelism.</a></li>
<li class="chapter" data-level="12.3.8" data-path="caution.html"><a href="caution.html#timeouts-may-be-unreliable."><i class="fa fa-check"></i><b>12.3.8</b> Timeouts may be unreliable.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="caution.html"><a href="caution.html#dependencies"><i class="fa fa-check"></i><b>12.4</b> Dependencies</a><ul>
<li class="chapter" data-level="12.4.1" data-path="caution.html"><a href="caution.html#dependency-objects-containing-functions-may-change-unexpectedly"><i class="fa fa-check"></i><b>12.4.1</b> Dependency objects containing functions may change unexpectedly</a></li>
<li class="chapter" data-level="12.4.2" data-path="caution.html"><a href="caution.html#the-magrittr-dot-.-is-always-ignored."><i class="fa fa-check"></i><b>12.4.2</b> The <code>magrittr</code> dot (<code>.</code>) is always ignored.</a></li>
<li class="chapter" data-level="12.4.3" data-path="caution.html"><a href="caution.html#triggers-and-skipped-imports"><i class="fa fa-check"></i><b>12.4.3</b> Triggers and skipped imports</a></li>
<li class="chapter" data-level="12.4.4" data-path="caution.html"><a href="caution.html#dependencies-are-not-tracked-in-some-edge-cases."><i class="fa fa-check"></i><b>12.4.4</b> Dependencies are not tracked in some edge cases.</a></li>
<li class="chapter" data-level="12.4.5" data-path="caution.html"><a href="caution.html#dependencies-of-knitr-reports"><i class="fa fa-check"></i><b>12.4.5</b> Dependencies of <code>knitr</code> reports</a></li>
<li class="chapter" data-level="12.4.6" data-path="caution.html"><a href="caution.html#knitr-inputs-and-file-outputs-in-imported-functions."><i class="fa fa-check"></i><b>12.4.6</b> Knitr inputs and file outputs in imported functions.</a></li>
<li class="chapter" data-level="12.4.7" data-path="caution.html"><a href="caution.html#functions-produced-by-vectorize"><i class="fa fa-check"></i><b>12.4.7</b> Functions produced by <code>Vectorize()</code></a></li>
<li class="chapter" data-level="12.4.8" data-path="caution.html"><a href="caution.html#compiled-code-is-not-reproducibly-tracked."><i class="fa fa-check"></i><b>12.4.8</b> Compiled code is not reproducibly tracked.</a></li>
<li class="chapter" data-level="12.4.9" data-path="caution.html"><a href="caution.html#directories-folders-are-not-reproducibly-tracked."><i class="fa fa-check"></i><b>12.4.9</b> Directories (folders) are not reproducibly tracked.</a></li>
<li class="chapter" data-level="12.4.10" data-path="caution.html"><a href="caution.html#packages-are-not-tracked-as-dependencies."><i class="fa fa-check"></i><b>12.4.10</b> Packages are not tracked as dependencies.</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="caution.html"><a href="caution.html#high-performance-computing"><i class="fa fa-check"></i><b>12.5</b> High-performance computing</a><ul>
<li class="chapter" data-level="12.5.1" data-path="caution.html"><a href="caution.html#the-practical-utility-of-parallel-computing"><i class="fa fa-check"></i><b>12.5.1</b> The practical utility of parallel computing</a></li>
<li class="chapter" data-level="12.5.2" data-path="caution.html"><a href="caution.html#maximum-number-of-simultaneous-jobs"><i class="fa fa-check"></i><b>12.5.2</b> Maximum number of simultaneous jobs</a></li>
<li class="chapter" data-level="12.5.3" data-path="caution.html"><a href="caution.html#parallel-computing-on-windows"><i class="fa fa-check"></i><b>12.5.3</b> Parallel computing on Windows</a></li>
<li class="chapter" data-level="12.5.4" data-path="caution.html"><a href="caution.html#configuring-futurebatchtools-parallelism-for-clusters"><i class="fa fa-check"></i><b>12.5.4</b> Configuring <a href="https://github.com/HenrikBengtsson/future">future</a>/<a href="https://github.com/mllg/batchtools">batchtools</a> parallelism for clusters</a></li>
<li class="chapter" data-level="12.5.5" data-path="caution.html"><a href="caution.html#proper-makefiles-are-not-standalone."><i class="fa fa-check"></i><b>12.5.5</b> Proper Makefiles are not standalone.</a></li>
<li class="chapter" data-level="12.5.6" data-path="caution.html"><a href="caution.html#makefile-level-parallelism-for-imported-objects-and-files"><i class="fa fa-check"></i><b>12.5.6</b> Makefile-level parallelism for imported objects and files</a></li>
<li class="chapter" data-level="12.5.7" data-path="caution.html"><a href="caution.html#zombie-processes"><i class="fa fa-check"></i><b>12.5.7</b> Zombie processes</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="caution.html"><a href="caution.html#storage"><i class="fa fa-check"></i><b>12.6</b> Storage</a><ul>
<li class="chapter" data-level="12.6.1" data-path="caution.html"><a href="caution.html#projects-hosted-on-dropbox-and-similar-platforms"><i class="fa fa-check"></i><b>12.6.1</b> Projects hosted on Dropbox and similar platforms</a></li>
<li class="chapter" data-level="12.6.2" data-path="caution.html"><a href="caution.html#cache-customization-is-limited"><i class="fa fa-check"></i><b>12.6.2</b> Cache customization is limited</a></li>
<li class="chapter" data-level="12.6.3" data-path="caution.html"><a href="caution.html#runtime-predictions"><i class="fa fa-check"></i><b>12.6.3</b> Runtime predictions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="faq.html"><a href="faq.html"><i class="fa fa-check"></i><b>13</b> Frequently-asked questions</a></li>
<li class="chapter" data-level="14" data-path="results-1.html"><a href="results-1.html"><i class="fa fa-check"></i><b>14</b> Results</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The User Manual of the drake R Package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hpc" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> High-performance computing with drake</h1>
<p><code>Drake</code> is not only a reproducibility tool, but also a high-performance computing engine. To activate parallel computing, just set the <code>jobs</code> argument of <code>make()</code> to a value greater than 1. Below, up to 2 targets can run simultaneously at any given time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(drake)
<span class="kw">load_mtcars_example</span>()
<span class="kw">make</span>(my_plan, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<div id="batch-mode-for-long-workflows" class="section level2">
<h2><span class="header-section-number">9.1</span> Batch mode for long workflows</h2>
<p>To deploy serious long workflows, we recommend putting the call to <code>make()</code> in a script (say, <code>drake_work.R</code>) and running it in an unobtrusive background process that persists after you log out. In the Linux command line, this is straightforward.</p>
<pre><code>nohup nice -19 R CMD BATCH drake_work.R &
</code></pre>
<p>Or, you could call <code>drake</code> inside an overarching <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> that chains multiple stages together in a larger reproducible pipeline. (See <a href="http://kbroman.org/minimal_make/">Karl Broman’s post</a> on <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a>s for reproducible research.)</p>
<pre><code>all: final_output.pdf

final_output.pdf: python_magic.py results_summary.csv
    python python_magic.py

results_summary.csv: drake_work.R
    Rscript drake_work.R

clean:
    rm -rf .drake
</code></pre>
<p>Then, run your whole pipleine in a persistent background process.</p>
<pre><code>nohup nice -19 R CMD BATCH make &
</code></pre>
<p>If you do write a custom <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> at the root of your project and you plan to use <code>make(parallelism = &quot;Makefile&quot;)</code>, please read about <code>make(parallelism = &quot;Makefile&quot;)</code> later in this document to avoid potential conflicts between your <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> and the one <code>drake</code> writes.</p>
</div>
<div id="let-drake-schedule-your-targets." class="section level2">
<h2><span class="header-section-number">9.2</span> Let drake schedule your targets.</h2>
<p>When you deploy your project, <code>drake</code> uses the dependency network to figure out how to run your work in parallel. You as the user do not have to micromanage when individual targets are built.</p>
<iframe src="https://ropensci.github.io/drake/images/outdated.html" width="100%" height="600px" allowtransparency="true" style="border: none; box-shadow: none">
</iframe>
</div>
<div id="parallel-backends" class="section level2">
<h2><span class="header-section-number">9.3</span> Parallel backends</h2>
<p>There are multiple ways to walk this graph and multiple ways to launch workers, and every project has its own needs. Thus, <code>drake</code> supports multiple parallel backends. Choose the backend with the <code>parallelism</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;parLapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>You can use a different backend for the imports than you select for the targets. If you do so, you force all the imports to be processed before any of the targets are built, but you might want to do so anyway. For example, staged scheduling could be great for imports even when it is not be the right choice for the targets (more on that later).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(
  my_plan,
  <span class="dt">parallelism =</span> <span class="kw">c</span>(<span class="dt">imports =</span> <span class="st">&quot;mclapply_staged&quot;</span>, <span class="dt">targets =</span> <span class="st">&quot;mclapply&quot;</span>),
  <span class="dt">jobs =</span> <span class="dv">2</span>
)</code></pre></div>
<p>List your options with <code>parallelism_choices()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parallelism_choices</span>()</code></pre></div>
<p>The backends vary widely in terms of how the workers deploy and how they are scheduled.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th align="center">Deploy: local</th>
<th align="right">Deploy: remote</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Schedule: persistent</td>
<td align="center">“mclapply”, “parLapply”</td>
<td align="right">“future_lapply”</td>
</tr>
<tr class="even">
<td>Schedule: transient</td>
<td align="center"></td>
<td align="right">“future”, “Makefile”</td>
</tr>
<tr class="odd">
<td>Schedule: staged</td>
<td align="center">“mclapply_staged”, “parLapply_staged”</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p>The next sections describe how and when to use each scheduling algorithm and deployment strategy.</p>
</div>
<div id="local-workers" class="section level2">
<h2><span class="header-section-number">9.4</span> Local workers</h2>
<p>Local workers deploy as separate forks or processes to you computer. The <code>&quot;mclapply&quot;</code> and <code>&quot;mclapply_staged&quot;</code> backends uses the <code>mclapply()</code> function from the <code>parallel</code> package to launch workers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;mclapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;mclapply_staged&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>Workers are quicker to launch than in any other <code>drake</code> backend, so these two choices are the lowest-overhead options. However, they have limitations: the <code>mclapply()</code> function is inefficient with respect to computer memory (see explanations <a href="https://github.com/tdhock/mclapply-memory">here</a> and <a href="http://lcolladotor.github.io/2013/11/14/Reducing-memory-overhead-when-using-mclapply/#.Wu8Fc9Yh1hE">here</a>) and it cannot launch multiple workers on Windows. For this reason, <code>drake</code> supports platform agnostic backends <code>&quot;parLapply&quot;</code> and <code>&quot;parLapply_staged&quot;</code>, both of which are based on the <code>parLapply()</code> function from the <code>parallel</code> package. These options work on Windows, but each <code>make()</code> requires extra overhead to create a <a href="http://gforge.se/2015/02/how-to-go-parallel-in-r-basics-tips/">parallel socket (PSOCK) cluster</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;parLapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;parLapply_staged&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>The default parallelism is <code>&quot;parLapply&quot;</code> on Windows and <code>&quot;mclapply&quot;</code> everywhere else.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">default_parallelism</span>()</code></pre></div>
</div>
<div id="remote-workers" class="section level2">
<h2><span class="header-section-number">9.5</span> Remote workers</h2>
<p>The <code>&quot;future_lapply&quot;</code>, <code>&quot;future&quot;</code>, and <code>&quot;Makefile&quot;</code> backends have the option to launch workers to remote resources such as nodes on a computing cluster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parallelism_choices</span>(<span class="dt">distributed_only =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Testing them out is straightforward.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future_lapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>For remote workers, the all the imports are processed with one of the local worker backends before any of the targets start. You can use different numbers of workers for the imports and the targets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="kw">c</span>(<span class="dt">imports =</span> <span class="dv">2</span>, <span class="dt">targets =</span> <span class="dv">4</span>))</code></pre></div>
<p>By default, these backends launch the workers on your local machine. It takes extra configuring to actually deploy them to a remote cluster. The next subsections have the details.</p>
<div id="future-and-future_lapply" class="section level3">
<h3><span class="header-section-number">9.5.1</span> <code>&quot;future&quot;</code> and <code>&quot;future_lapply&quot;</code></h3>
<p>The <code>plan()</code> function from the <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> package configures how and where the workers will deploy on the next <code>make()</code>. For example, the following code uses <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a>’s <code>multisession</code> backend, which is analogous to <code>drake</code>’s <code>&quot;parLapply&quot;</code> parallelism.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(future)
future<span class="op">::</span><span class="kw">plan</span>(multisession)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
## Same technology, different scheduling:
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future_lapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>To deploy to a cluster (say, a <a href="https://slurm.schedmd.com/">SLURM</a> cluster), you need the <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> and <a href="https://github.com/HenrikBengtsson/future.batchtools"><code>future.batchtools</code></a> packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(future.batchtools)</code></pre></div>
<p>You also need <a href="https://github.com/mllg/batchtools/tree/master/inst/templates">template file</a> to configure <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> the remote resources, such as the memory and wall time limits. Use <code>drake_batchtools_tmpl_file()</code> to write one of the examples from the <a href="https://github.com/ropensci/drake/tree/master/inst/examples"><code>drake_example()</code> files</a>. You will probably need to edit it manually to match your resources and needs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_batchtools_tmpl_file</span>(<span class="st">&quot;slurm&quot;</span>) <span class="co"># Write batchtools.slurm.tmpl.</span></code></pre></div>
<p>Load the template file your <code>future::plan()</code> and call <code>make()</code> to run the project.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">future<span class="op">::</span><span class="kw">plan</span>(batchtools_slurm, <span class="dt">template =</span> <span class="st">&quot;batchtools.slurm.tmpl&quot;</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
## Same technology, different scheduling:
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future_lapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>See packages <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a>, <a href="https://github.com/HenrikBengtsson/future.batchtools"><code>future.batchtools</code></a>, and <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> for more options. For example, the alternatives for <code>future::plan()</code> are listed <a href="https://github.com/HenrikBengtsson/future#controlling-how-futures-are-resolved">here</a> and <a href="https://github.com/HenrikBengtsson/future.batchtools#choosing-batchtools-backend">here</a>.</p>
</div>
<div id="makefile" class="section level3">
<h3><span class="header-section-number">9.5.2</span> <code>&quot;Makefile&quot;</code></h3>
<p>Here, <code>drake</code> actually writes, configures, and runs a proper <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> to run the targets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>You can configure both the Unix command that runs the <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> and the command line arguments passed to it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(
  my_plan,
  <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>,
  <span class="dt">command =</span> <span class="st">&quot;lsmake&quot;</span>,
  <span class="dt">args =</span> <span class="kw">c</span>(<span class="st">&quot;--touch&quot;</span>, <span class="st">&quot;--silent&quot;</span>)
)</code></pre></div>
<p>If <code>drake</code>’s <code>Makefile</code> conflicts with a <code>Makefile</code> you already wrote yourself, <code>drake</code> does not overwrite your <code>Makefile</code>. Instead, <code>make()</code> tells you about the conflict and then stops running. To force <code>drake</code> to use a different <code>Makefile</code> that does not conflict with yours, pass the file path to the <code>makefile_path</code> argument and set the <code>--file</code> argument in <code>args</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(
  my_plan,
  <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>,
  <span class="dt">makefile_path =</span> <span class="st">&quot;my_folder/my_makefile&quot;</span>,
  <span class="dt">args =</span> <span class="st">&quot;--file=my_folder/my_makefile&quot;</span>
)</code></pre></div>
<p>There are more customization options in <code>make()</code>, such as the <code>recipe_command</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,
  <span class="dt">recipe_command =</span> <span class="st">&quot;R -e &#39;R_RECIPE&#39; -q&quot;</span>)</code></pre></div>
<p>See the help files of individual functions for details.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">default_Makefile_command</span>()

<span class="kw">default_recipe_command</span>()

<span class="kw">r_recipe_wildcard</span>()

<span class="kw">Makefile_recipe</span>(
  <span class="dt">recipe_command =</span> <span class="st">&quot;R -e &#39;R_RECIPE&#39; -q&quot;</span>,
  <span class="dt">target =</span> <span class="st">&quot;this_target&quot;</span>,
  <span class="dt">cache_path =</span> <span class="st">&quot;custom_cache&quot;</span>
)</code></pre></div>
<p>To deploy workers to a cluster, you need to supply the <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> with a custom shell script that launches cluster jobs. Use the <code>shell_file()</code> function to write an example compatible with the <a href="http://www.univa.com/products/">Univa Grid Engine</a>. You will probably need to configure it manually. Suppose our file is <code>shell.sh</code>.</p>
<pre><code>#!/bin/bash
shift
echo "module load R; $*" | qsub -sync y -cwd -j y
</code></pre>
<p>You will need to set permissions to allow execution. In the Linux command line, this is straightforward.</p>
<pre><code>$ chmod +x shell.sh 
</code></pre>
<p>When you actually call <code>make()</code>, use the <code>prepend</code> argument to write a line at the top of the <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> to reference your shell file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>, <span class="dt">prepend =</span> <span class="st">&quot;SHELL=./shell.sh&quot;</span>)</code></pre></div>
<p><a href="https://slurm.schedmd.com/">SLURM</a> users may be able to <a href="http://plindenbaum.blogspot.com/2014/09/parallelizing-gnu-make-4-in-slurm.html">invoke <code>srun</code> and dispense with <code>shell.sh</code> altogether</a>, though success may vary depending on the SLURM system. You will probably also need to set resource allocation parameters governing memory, runtime, etc. See <code>man srun</code> for the possible <code>.SHELLFLAGS</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(
  my_plan,
  <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>,
  <span class="dt">jobs =</span> <span class="dv">2</span>,
  <span class="dt">prepend =</span> <span class="kw">c</span>(
    <span class="st">&quot;SHELL=srun&quot;</span>,
    <span class="st">&quot;.SHELLFLAGS=-N1 -n1 bash -c&quot;</span>
  )
)</code></pre></div>
</div>
</div>
<div id="scheduling-algorithms" class="section level2">
<h2><span class="header-section-number">9.6</span> Scheduling algorithms</h2>
<div id="persistent-scheduling" class="section level3">
<h3><span class="header-section-number">9.6.1</span> Persistent scheduling</h3>
<p>Backends “mclapply”, “parLapply”, and “future_lapply” launch persistent workers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;mclapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;parLapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
future<span class="op">::</span><span class="kw">plan</span>(future<span class="op">::</span>multisession)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future_lapply&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>In each of these calls to <code>make()</code>, three processes launch: two workers and one master. Whenever a worker is idle, the master assigns it the next available target (whose dependencies have been built). The workers keep running until there are no more targets to build. The following video demonstrates the concept.</p>
<div style="text-align: center">
<iframe width="700" height="434" src="https://www.powtoon.com/embed/bUfSIaXjrw5/" frameborder="0">
</iframe>
</div>
<p>For staged scheduling, you can micromanage which workers can run which targets. This column can be an integer vector or a list of integer vectors. Simply set an optional <code>workers</code> column in your <code>drake_plan()</code>. Why would you wish to do this? Consider the <code>mtcars</code> example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load_mtcars_example</span>()
my_plan<span class="op">$</span>workers &lt;-<span class="st"> </span><span class="dv">1</span>
my_plan<span class="op">$</span>workers[<span class="kw">grepl</span>(<span class="st">&quot;large&quot;</span>, my_plan<span class="op">$</span>target)] &lt;-<span class="st"> </span><span class="dv">2</span>
my_plan</code></pre></div>
<p>Here, one of the workers is in charge of all the targets that have to do with the <code>large</code> dataset. That way, we do not need other workers to read <code>large</code> from disk. If reads from disk take a long time, this could speed up your workflow. On the other hand, delegating all the <code>large</code> targets to worker 2 could prevent worker 1 from sharing the computational load, which could slow things down. Ultimately, you as the user need to make these tradeoffs. Also, the <code>workers</code> column only applies to the persistent scheduling backends.</p>
<p>Similarly, you can set an optional <code>priority</code> column for your <code>drake_plan()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(<span class="dt">A =</span> <span class="kw">build</span>(), <span class="dt">B =</span> <span class="kw">stuff</span>())
plan<span class="op">$</span>priority &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)
plan</code></pre></div>
<p>Because of the <code>priority</code> column, if targets <code>A</code> and <code>B</code> are both ready to build, then <code>A</code> will be assigned to a worker first. Custom priorities apply to the staged scheduling backends, plus the <code>&quot;future&quot;</code> backend.</p>
<p>The <code>predict_runtime()</code> and <code>predict_load_balancing()</code> functions emulate persistent workers, and the predictions also apply to transient workers. See the <a href="https://ropensci.github.io/drake/articles/timing.html">timing guide</a> for a demonstration. These functions also respond to the <code>workers</code> column.</p>
</div>
<div id="transient-scheduling" class="section level3">
<h3><span class="header-section-number">9.6.2</span> Transient scheduling</h3>
<p>Persistent workers are great because they minimize overhead: all the workers are created at the beginning, and then you never have to create any more for the rest of the runthrough. Unfortunately, computing clusters usually limit the amount of time each worker can stay running. That is why <code>drake</code> also supports transient workers in backends <code>&quot;future&quot;</code> and <code>&quot;Makefile&quot;</code>. Here, the master process creates a new worker for each target individually, and the worker dies after it finishes its single target. For the <code>&quot;future&quot;</code> backend, the master is just the existing process calling <code>make()</code>. The following video demonstrates the concept.</p>
<div style="text-align: center">
<iframe width="700" height="434" src="https://www.powtoon.com/embed/cHIdOqudELB/" frameborder="0">
</iframe>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">future<span class="op">::</span><span class="kw">plan</span>(future<span class="op">::</span>multisession)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;future&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;Makefile&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
</div>
<div id="staged-scheduling" class="section level3">
<h3><span class="header-section-number">9.6.3</span> Staged scheduling</h3>
<p>Backends <code>&quot;mclapply_staged&quot;</code> and <code>&quot;parLapply_staged&quot;</code> support staged scheduling.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;mclapply_staged&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)
<span class="kw">make</span>(my_plan, <span class="dt">parallelism =</span> <span class="st">&quot;parLapply_staged&quot;</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</code></pre></div>
<p>Here, the dependency network is divided into separate stages of conditionally independent targets. Within each stage, <code>drake</code> uses <code>mclapply()</code> or <code>parLapply()</code> to process the targets in parallel. Stages run one after the other, so the slowest target in the current stage needs to complete before the next stage begins. So we lose a lot of parallel efficiency. The following video demonstrates the major drawback.<sup><a href="hpc.html#note1" id="note1ref">[1]</a></sup></p>
<div style="text-align: center">
<iframe width="700" height="434" src="https://www.powtoon.com/embed/dQKbGttIYud/" frameborder="0">
</iframe>
</div>
<p>However, because there is no formal master process in each stage, overhead is extremely low. This lack of overhead can make staged parallelism a great choice for projects with a small number of large stages: tall dependency graphs with most of the work in the tallest stages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(drake)

N &lt;-<span class="st"> </span><span class="dv">500</span>

gen_data &lt;-<span class="st"> </span><span class="cf">function</span>() {
  <span class="kw">tibble</span>(<span class="dt">a =</span> <span class="kw">seq_len</span>(N), <span class="dt">b =</span> <span class="dv">1</span>, <span class="dt">c =</span> <span class="dv">2</span>, <span class="dt">d =</span> <span class="dv">3</span>)
}

plan_data &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">gen_data</span>()
)

plan_sub &lt;-
<span class="st">  </span><span class="kw">gen_data</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">transmute</span>(
    <span class="dt">target =</span> <span class="kw">paste0</span>(<span class="st">&quot;data&quot;</span>, a),
    <span class="dt">command =</span> <span class="kw">paste0</span>(<span class="st">&quot;data[&quot;</span>, a, <span class="st">&quot;, ]&quot;</span>)
  )

plan &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(plan_data, plan_sub)
plan</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(plan)</code></pre></div>
<div style="text-align: center">
<iframe src="https://ropensci.github.io/drake/images/staged.html" width="100%" height="600px" allowtransparency="true" style="border: none; box-shadow: none">
</iframe>
</div>
</div>
</div>
<div id="final-thoughts" class="section level2">
<h2><span class="header-section-number">9.7</span> Final thoughts</h2>
<div id="debugging" class="section level3">
<h3><span class="header-section-number">9.7.1</span> Debugging</h3>
<p>For large workflows, downsizing and debugging tools become super important. See the <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd">“debug” vignette</a> for help on diagnosing problems with a workflow. <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#test-with-triggers">Triggers</a> and <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#diagnose-failures">cached error logs</a> especially speed the development and testing process.</p>
</div>
<div id="drake-as-an-ordinary-job-scheduler" class="section level3">
<h3><span class="header-section-number">9.7.2</span> Drake as an ordinary job scheduler</h3>
<p>If you do not care about reproducibility and you want <code>drake</code> to be an ordinary job scheduler, consider using <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#test-with-triggers">alternative triggers</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load_mtcars_example</span>()
<span class="kw">make</span>(my_plan, <span class="dt">trigger =</span> <span class="st">&quot;missing&quot;</span>) <span class="co"># Also consider &quot;always&quot;.</span></code></pre></div>
<p>Above, <code>drake</code> only builds the missing targets. This skips much of the <a href="https://github.com/ropensci/drake/blob/master/vignettes/storage.Rmd#hash-algorithms">time-consuming hashing</a> that ordinarily detects which targets are out of date.</p>
</div>
<div id="more-resources" class="section level3">
<h3><span class="header-section-number">9.7.3</span> More resources</h3>
<p>See the <a href="https://github.com/ropensci/drake/blob/master/vignettes/timing.Rmd">timing vignette</a> for explanations of functions <code>predict_runtime()</code> and <code>predict_load_balancing()</code>, which can help you plan and strategize deployment.</p>
</div>
</div>
<div id="footnotes" class="section level2">
<h2><span class="header-section-number">9.8</span> Footnotes</h2>
<p><a id="note1" href="#note1ref">[1]</a> The video of staged parallelism is an oversimplification. It holds mostly true for <code>make(parallelism = &quot;parLapply_staged&quot;)</code>, but <code>make(parallelism = &quot;mclapply_staged&quot;)</code> is a bit different. In the former case, each stage is a call to <code>parLapply()</code>, which recycles existing workers on a pre-built parallel socket (PSOCK) cluster. But in the latter, every stage is a new call to <code>mclapply()</code>, which launches a brand new batch of workers. In that sense, workers in <code>make(parallelism = &quot;parLapply_staged&quot;)</code> are sort of persistent, and workers in <code>make(parallelism = &quot;mclapply_staged&quot;)</code> are sort of transient for some projects.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="vis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
