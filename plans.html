<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 drake plans | The drake R Package User Manual</title>
  <meta name="description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 drake plans | The drake R Package User Manual" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ropenscilabs.github.io/drake-manual" />
  <meta property="og:image" content="https://ropenscilabs.github.io/drake-manual/images/logo.png" />
  <meta property="og:description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="github-repo" content="ropenscilabs/drake-manual" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 drake plans | The drake R Package User Manual" />
  
  <meta name="twitter:description" content="In-depth walkthroughs and examples of drake, an R package for reproducible computation at scale." />
  <meta name="twitter:image" content="https://ropenscilabs.github.io/drake-manual/images/logo.png" />

<meta name="author" content="Will Landau, Kirill Müller, Alex Axthelm, Jasper Clarkberg, Lorenz Walthert" />
<meta name="author" content="Copyright Eli Lilly and Company" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="walkthrough.html">
<link rel="next" href="projects.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.7/visNetwork.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<script src="libs/sankey-1/sankey.js"></script>
<script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="https://ropensci.github.io/dev_guide/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The drake R Package User Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-drake-r-package"><i class="fa fa-check"></i><b>1.1</b> The drake R package</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#why-drake"><i class="fa fa-check"></i><b>1.3</b> Why drake?</a><ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#what-gets-done-stays-done."><i class="fa fa-check"></i><b>1.3.1</b> What gets done stays done.</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#reproducibility-with-confidence"><i class="fa fa-check"></i><b>1.3.2</b> Reproducibility with confidence</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#aggressively-scale-up."><i class="fa fa-check"></i><b>1.3.3</b> Aggressively scale up.</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#documentation"><i class="fa fa-check"></i><b>1.4</b> Documentation</a><ul>
<li class="chapter" data-level="1.4.1" data-path="index.html"><a href="index.html#shiny-app"><i class="fa fa-check"></i><b>1.4.1</b> Shiny app</a></li>
<li class="chapter" data-level="1.4.2" data-path="index.html"><a href="index.html#cheat-sheet"><i class="fa fa-check"></i><b>1.4.2</b> Cheat sheet</a></li>
<li class="chapter" data-level="1.4.3" data-path="index.html"><a href="index.html#frequently-asked-questions"><i class="fa fa-check"></i><b>1.4.3</b> Frequently asked questions</a></li>
<li class="chapter" data-level="1.4.4" data-path="index.html"><a href="index.html#function-reference"><i class="fa fa-check"></i><b>1.4.4</b> Function reference</a></li>
<li class="chapter" data-level="1.4.5" data-path="index.html"><a href="index.html#tutorials"><i class="fa fa-check"></i><b>1.4.5</b> Tutorials</a></li>
<li class="chapter" data-level="1.4.6" data-path="index.html"><a href="index.html#examples"><i class="fa fa-check"></i><b>1.4.6</b> Examples</a></li>
<li class="chapter" data-level="1.4.7" data-path="index.html"><a href="index.html#presentations"><i class="fa fa-check"></i><b>1.4.7</b> Presentations</a></li>
<li class="chapter" data-level="1.4.8" data-path="index.html"><a href="index.html#context-and-history"><i class="fa fa-check"></i><b>1.4.8</b> Context and history</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#help-and-troubleshooting"><i class="fa fa-check"></i><b>1.5</b> Help and troubleshooting</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#similar-work"><i class="fa fa-check"></i><b>1.6</b> Similar work</a><ul>
<li class="chapter" data-level="1.6.1" data-path="index.html"><a href="index.html#gnu-make"><i class="fa fa-check"></i><b>1.6.1</b> GNU Make</a></li>
<li class="chapter" data-level="1.6.2" data-path="index.html"><a href="index.html#remake"><i class="fa fa-check"></i><b>1.6.2</b> Remake</a></li>
<li class="chapter" data-level="1.6.3" data-path="index.html"><a href="index.html#memoise"><i class="fa fa-check"></i><b>1.6.3</b> Memoise</a></li>
<li class="chapter" data-level="1.6.4" data-path="index.html"><a href="index.html#knitr-and-r-markdown"><i class="fa fa-check"></i><b>1.6.4</b> Knitr and R Markdown</a></li>
<li class="chapter" data-level="1.6.5" data-path="index.html"><a href="index.html#factuals-drake"><i class="fa fa-check"></i><b>1.6.5</b> Factual’s Drake</a></li>
<li class="chapter" data-level="1.6.6" data-path="index.html"><a href="index.html#other-pipeline-toolkits"><i class="fa fa-check"></i><b>1.6.6</b> Other pipeline toolkits</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i><b>1.7</b> Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Getting started</b></span></li>
<li class="chapter" data-level="2" data-path="walkthrough.html"><a href="walkthrough.html"><i class="fa fa-check"></i><b>2</b> Walkthrough</a><ul>
<li class="chapter" data-level="2.1" data-path="walkthrough.html"><a href="walkthrough.html#set-the-stage."><i class="fa fa-check"></i><b>2.1</b> Set the stage.</a></li>
<li class="chapter" data-level="2.2" data-path="walkthrough.html"><a href="walkthrough.html#make-your-results."><i class="fa fa-check"></i><b>2.2</b> Make your results.</a></li>
<li class="chapter" data-level="2.3" data-path="walkthrough.html"><a href="walkthrough.html#go-back-and-fix-things."><i class="fa fa-check"></i><b>2.3</b> Go back and fix things.</a></li>
<li class="chapter" data-level="2.4" data-path="walkthrough.html"><a href="walkthrough.html#try-it-yourself"><i class="fa fa-check"></i><b>2.4</b> Try it yourself!</a></li>
<li class="chapter" data-level="2.5" data-path="walkthrough.html"><a href="walkthrough.html#thanks"><i class="fa fa-check"></i><b>2.5</b> Thanks</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="plans.html"><a href="plans.html"><i class="fa fa-check"></i><b>3</b> <code>drake</code> plans</a><ul>
<li class="chapter" data-level="3.1" data-path="plans.html"><a href="plans.html#what-is-a-drake-plan"><i class="fa fa-check"></i><b>3.1</b> What is a <code>drake</code> plan?</a></li>
<li class="chapter" data-level="3.2" data-path="plans.html"><a href="plans.html#plans-are-similar-to-r-scripts."><i class="fa fa-check"></i><b>3.2</b> Plans are similar to R scripts.</a></li>
<li class="chapter" data-level="3.3" data-path="plans.html"><a href="plans.html#so-why-do-we-use-plans"><i class="fa fa-check"></i><b>3.3</b> So why do we use plans?</a><ul>
<li class="chapter" data-level="3.3.1" data-path="plans.html"><a href="plans.html#plans-chop-up-the-work-into-pieces."><i class="fa fa-check"></i><b>3.3.1</b> Plans chop up the work into pieces.</a></li>
<li class="chapter" data-level="3.3.2" data-path="plans.html"><a href="plans.html#drake-uses-plans-to-schedule-you-work."><i class="fa fa-check"></i><b>3.3.2</b> <code>drake</code> uses plans to schedule you work.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="plans.html"><a href="plans.html#special-custom-columns-in-your-plan"><i class="fa fa-check"></i><b>3.4</b> Special custom columns in your plan</a></li>
<li class="chapter" data-level="3.5" data-path="plans.html"><a href="plans.html#large-plans"><i class="fa fa-check"></i><b>3.5</b> Large plans</a><ul>
<li class="chapter" data-level="3.5.1" data-path="plans.html"><a href="plans.html#how-to-create-large-plans"><i class="fa fa-check"></i><b>3.5.1</b> How to create large plans</a></li>
<li class="chapter" data-level="3.5.2" data-path="plans.html"><a href="plans.html#start-small"><i class="fa fa-check"></i><b>3.5.2</b> Start small</a></li>
<li class="chapter" data-level="3.5.3" data-path="plans.html"><a href="plans.html#the-types-of-transformations"><i class="fa fa-check"></i><b>3.5.3</b> The types of transformations</a></li>
<li class="chapter" data-level="3.5.4" data-path="plans.html"><a href="plans.html#grouping-variables"><i class="fa fa-check"></i><b>3.5.4</b> Grouping variables</a></li>
<li class="chapter" data-level="3.5.5" data-path="plans.html"><a href="plans.html#tags"><i class="fa fa-check"></i><b>3.5.5</b> Tags</a></li>
<li class="chapter" data-level="3.5.6" data-path="plans.html"><a href="plans.html#target-names"><i class="fa fa-check"></i><b>3.5.6</b> Target names</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="projects.html"><a href="projects.html"><i class="fa fa-check"></i><b>4</b> <code>drake</code> projects</a><ul>
<li class="chapter" data-level="4.1" data-path="projects.html"><a href="projects.html#code-files"><i class="fa fa-check"></i><b>4.1</b> Code files</a></li>
<li class="chapter" data-level="4.2" data-path="projects.html"><a href="projects.html#safer-interactivity"><i class="fa fa-check"></i><b>4.2</b> Safer interactivity</a><ul>
<li class="chapter" data-level="4.2.1" data-path="projects.html"><a href="projects.html#motivation"><i class="fa fa-check"></i><b>4.2.1</b> Motivation</a></li>
<li class="chapter" data-level="4.2.2" data-path="projects.html"><a href="projects.html#usage"><i class="fa fa-check"></i><b>4.2.2</b> Usage</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="projects.html"><a href="projects.html#script-file-pitfalls"><i class="fa fa-check"></i><b>4.3</b> Script file pitfalls</a></li>
<li class="chapter" data-level="4.4" data-path="projects.html"><a href="projects.html#workflows-as-r-packages"><i class="fa fa-check"></i><b>4.4</b> Workflows as R packages</a></li>
<li class="chapter" data-level="4.5" data-path="projects.html"><a href="projects.html#other-tools"><i class="fa fa-check"></i><b>4.5</b> Other tools</a></li>
</ul></li>
<li class="part"><span><b>II Examples</b></span></li>
<li class="chapter" data-level="5" data-path="churn.html"><a href="churn.html"><i class="fa fa-check"></i><b>5</b> Customer churn and deep learning</a><ul>
<li class="chapter" data-level="5.1" data-path="churn.html"><a href="churn.html#packages"><i class="fa fa-check"></i><b>5.1</b> Packages</a></li>
<li class="chapter" data-level="5.2" data-path="churn.html"><a href="churn.html#functions"><i class="fa fa-check"></i><b>5.2</b> Functions</a></li>
<li class="chapter" data-level="5.3" data-path="churn.html"><a href="churn.html#plan"><i class="fa fa-check"></i><b>5.3</b> Plan</a></li>
<li class="chapter" data-level="5.4" data-path="churn.html"><a href="churn.html#dependency-graph"><i class="fa fa-check"></i><b>5.4</b> Dependency graph</a></li>
<li class="chapter" data-level="5.5" data-path="churn.html"><a href="churn.html#run-the-models"><i class="fa fa-check"></i><b>5.5</b> Run the models</a></li>
<li class="chapter" data-level="5.6" data-path="churn.html"><a href="churn.html#inspect-the-results"><i class="fa fa-check"></i><b>5.6</b> Inspect the results</a></li>
<li class="chapter" data-level="5.7" data-path="churn.html"><a href="churn.html#add-models"><i class="fa fa-check"></i><b>5.7</b> Add models</a></li>
<li class="chapter" data-level="5.8" data-path="churn.html"><a href="churn.html#inspect-the-results-again"><i class="fa fa-check"></i><b>5.8</b> Inspect the results again</a></li>
<li class="chapter" data-level="5.9" data-path="churn.html"><a href="churn.html#possible-slowness"><i class="fa fa-check"></i><b>5.9</b> Possible slowness</a></li>
<li class="chapter" data-level="5.10" data-path="churn.html"><a href="churn.html#models-in-hdf5-files"><i class="fa fa-check"></i><b>5.10</b> Models in HDF5 files</a></li>
<li class="chapter" data-level="5.11" data-path="churn.html"><a href="churn.html#tips"><i class="fa fa-check"></i><b>5.11</b> Tips</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="churn.html"><a href="churn.html#packages"><i class="fa fa-check"></i><b>6</b> An analysis of R package download trends</a><ul>
<li class="chapter" data-level="6.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>6.1</b> Get the code.</a></li>
<li class="chapter" data-level="6.2" data-path="packages.html"><a href="packages.html#overview"><i class="fa fa-check"></i><b>6.2</b> Overview</a></li>
<li class="chapter" data-level="6.3" data-path="packages.html"><a href="packages.html#analysis"><i class="fa fa-check"></i><b>6.3</b> Analysis</a></li>
<li class="chapter" data-level="6.4" data-path="packages.html"><a href="packages.html#other-ways-to-trigger-downloads"><i class="fa fa-check"></i><b>6.4</b> Other ways to trigger downloads</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="gsp.html"><a href="gsp.html"><i class="fa fa-check"></i><b>7</b> Finding the best model of gross state product</a><ul>
<li class="chapter" data-level="7.1" data-path="gsp.html"><a href="gsp.html#get-the-code.-1"><i class="fa fa-check"></i><b>7.1</b> Get the code.</a></li>
<li class="chapter" data-level="7.2" data-path="gsp.html"><a href="gsp.html#objective-and-methods"><i class="fa fa-check"></i><b>7.2</b> Objective and methods</a></li>
<li class="chapter" data-level="7.3" data-path="gsp.html"><a href="gsp.html#data"><i class="fa fa-check"></i><b>7.3</b> Data</a></li>
<li class="chapter" data-level="7.4" data-path="gsp.html"><a href="gsp.html#analysis-1"><i class="fa fa-check"></i><b>7.4</b> Analysis</a></li>
<li class="chapter" data-level="7.5" data-path="gsp.html"><a href="gsp.html#results"><i class="fa fa-check"></i><b>7.5</b> Results</a></li>
<li class="chapter" data-level="7.6" data-path="gsp.html"><a href="gsp.html#comparison-with-gnu-make"><i class="fa fa-check"></i><b>7.6</b> Comparison with GNU Make</a></li>
<li class="chapter" data-level="7.7" data-path="gsp.html"><a href="gsp.html#references"><i class="fa fa-check"></i><b>7.7</b> References</a></li>
</ul></li>
<li class="part"><span><b>III Functionality</b></span></li>
<li class="chapter" data-level="8" data-path="visuals.html"><a href="visuals.html"><i class="fa fa-check"></i><b>8</b> Visualization with drake</a><ul>
<li class="chapter" data-level="8.0.1" data-path="visuals.html"><a href="visuals.html#vis_drake_graph"><i class="fa fa-check"></i><b>8.0.1</b> <code>vis_drake_graph()</code></a></li>
<li class="chapter" data-level="8.0.2" data-path="visuals.html"><a href="visuals.html#sankey_drake_graph"><i class="fa fa-check"></i><b>8.0.2</b> <code>sankey_drake_graph()</code></a></li>
<li class="chapter" data-level="8.0.3" data-path="visuals.html"><a href="visuals.html#drake_ggraph"><i class="fa fa-check"></i><b>8.0.3</b> <code>drake_ggraph()</code></a></li>
<li class="chapter" data-level="8.0.4" data-path="visuals.html"><a href="visuals.html#text_drake_graph"><i class="fa fa-check"></i><b>8.0.4</b> <code>text_drake_graph()</code></a></li>
<li class="chapter" data-level="8.1" data-path="visuals.html"><a href="visuals.html#underlying-graph-data-node-and-edge-data-frames"><i class="fa fa-check"></i><b>8.1</b> Underlying graph data: node and edge data frames</a></li>
<li class="chapter" data-level="8.2" data-path="visuals.html"><a href="visuals.html#visualizing-target-status"><i class="fa fa-check"></i><b>8.2</b> Visualizing target status</a></li>
<li class="chapter" data-level="8.3" data-path="visuals.html"><a href="visuals.html#subgraphs"><i class="fa fa-check"></i><b>8.3</b> Subgraphs</a></li>
<li class="chapter" data-level="8.4" data-path="visuals.html"><a href="visuals.html#control-the-vis_drake_graph-legend."><i class="fa fa-check"></i><b>8.4</b> Control the <code>vis_drake_graph()</code> legend.</a></li>
<li class="chapter" data-level="8.5" data-path="visuals.html"><a href="visuals.html#clusters"><i class="fa fa-check"></i><b>8.5</b> Clusters</a></li>
<li class="chapter" data-level="8.6" data-path="visuals.html"><a href="visuals.html#output-files"><i class="fa fa-check"></i><b>8.6</b> Output files</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="debug.html"><a href="debug.html"><i class="fa fa-check"></i><b>9</b> Debugging and testing drake projects</a><ul>
<li class="chapter" data-level="9.0.1" data-path="debug.html"><a href="debug.html#start-small-1"><i class="fa fa-check"></i><b>9.0.1</b> Start small</a></li>
<li class="chapter" data-level="9.1" data-path="debug.html"><a href="debug.html#dependencies"><i class="fa fa-check"></i><b>9.1</b> Dependencies</a><ul>
<li class="chapter" data-level="9.1.1" data-path="debug.html"><a href="debug.html#visualize-your-dependency-graph."><i class="fa fa-check"></i><b>9.1.1</b> Visualize your dependency graph.</a></li>
<li class="chapter" data-level="9.1.2" data-path="debug.html"><a href="debug.html#check-specific-dependency-information."><i class="fa fa-check"></i><b>9.1.2</b> Check specific dependency information.</a></li>
<li class="chapter" data-level="9.1.3" data-path="debug.html"><a href="debug.html#outdated-targets-and-missing-dependencies"><i class="fa fa-check"></i><b>9.1.3</b> Outdated targets and missing dependencies</a></li>
<li class="chapter" data-level="9.1.4" data-path="debug.html"><a href="debug.html#but-why-are-my-targets-out-of-date"><i class="fa fa-check"></i><b>9.1.4</b> But <em>why</em> are my targets out of date?</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="debug.html"><a href="debug.html#diagnose-failures."><i class="fa fa-check"></i><b>9.2</b> Diagnose failures.</a></li>
<li class="chapter" data-level="9.3" data-path="debug.html"><a href="debug.html#timeouts-and-retries"><i class="fa fa-check"></i><b>9.3</b> Timeouts and retries</a></li>
<li class="chapter" data-level="9.4" data-path="debug.html"><a href="debug.html#more-help"><i class="fa fa-check"></i><b>9.4</b> More help</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>10</b> High-performance computing</a><ul>
<li class="chapter" data-level="10.1" data-path="hpc.html"><a href="hpc.html#start-small-2"><i class="fa fa-check"></i><b>10.1</b> Start small</a></li>
<li class="chapter" data-level="10.2" data-path="hpc.html"><a href="hpc.html#batch-mode-for-long-workflows"><i class="fa fa-check"></i><b>10.2</b> Batch mode for long workflows</a></li>
<li class="chapter" data-level="10.3" data-path="hpc.html"><a href="hpc.html#let-make-schedule-your-targets."><i class="fa fa-check"></i><b>10.3</b> Let <code>make()</code> schedule your targets.</a></li>
<li class="chapter" data-level="10.4" data-path="hpc.html"><a href="hpc.html#parallel-backends"><i class="fa fa-check"></i><b>10.4</b> Parallel backends</a></li>
<li class="chapter" data-level="10.5" data-path="hpc.html"><a href="hpc.html#the-clustermq-backend"><i class="fa fa-check"></i><b>10.5</b> The <code>clustermq</code> backend</a><ul>
<li class="chapter" data-level="10.5.1" data-path="hpc.html"><a href="hpc.html#persistent-workers"><i class="fa fa-check"></i><b>10.5.1</b> Persistent workers</a></li>
<li class="chapter" data-level="10.5.2" data-path="hpc.html"><a href="hpc.html#installation-1"><i class="fa fa-check"></i><b>10.5.2</b> Installation</a></li>
<li class="chapter" data-level="10.5.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine"><i class="fa fa-check"></i><b>10.5.3</b> On your local machine</a></li>
<li class="chapter" data-level="10.5.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster"><i class="fa fa-check"></i><b>10.5.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="hpc.html"><a href="hpc.html#the-future-backend"><i class="fa fa-check"></i><b>10.6</b> The <code>future</code> backend</a><ul>
<li class="chapter" data-level="10.6.1" data-path="hpc.html"><a href="hpc.html#transient-workers"><i class="fa fa-check"></i><b>10.6.1</b> Transient workers</a></li>
<li class="chapter" data-level="10.6.2" data-path="hpc.html"><a href="hpc.html#installation-2"><i class="fa fa-check"></i><b>10.6.2</b> Installation</a></li>
<li class="chapter" data-level="10.6.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine-1"><i class="fa fa-check"></i><b>10.6.3</b> On your local machine</a></li>
<li class="chapter" data-level="10.6.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster-1"><i class="fa fa-check"></i><b>10.6.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="10.7" data-path="hpc.html"><a href="hpc.html#advanced-options"><i class="fa fa-check"></i><b>10.7</b> Advanced options</a><ul>
<li class="chapter" data-level="10.7.1" data-path="hpc.html"><a href="hpc.html#selectivity"><i class="fa fa-check"></i><b>10.7.1</b> Selectivity</a></li>
<li class="chapter" data-level="10.7.2" data-path="hpc.html"><a href="hpc.html#memory"><i class="fa fa-check"></i><b>10.7.2</b> Memory</a></li>
<li class="chapter" data-level="10.7.3" data-path="hpc.html"><a href="hpc.html#storage"><i class="fa fa-check"></i><b>10.7.3</b> Storage</a></li>
<li class="chapter" data-level="10.7.4" data-path="hpc.html"><a href="hpc.html#the-template-argument-for-persistent-workers"><i class="fa fa-check"></i><b>10.7.4</b> The <code>template</code> argument for persistent workers</a></li>
<li class="chapter" data-level="10.7.5" data-path="hpc.html"><a href="hpc.html#the-resources-column-for-transient-workers"><i class="fa fa-check"></i><b>10.7.5</b> The <code>resources</code> column for transient workers</a></li>
<li class="chapter" data-level="10.7.6" data-path="hpc.html"><a href="hpc.html#parallel-computing-within-targets"><i class="fa fa-check"></i><b>10.7.6</b> Parallel computing <em>within</em> targets</a></li>
<li class="chapter" data-level="10.7.7" data-path="hpc.html"><a href="hpc.html#custom-job-schedulers"><i class="fa fa-check"></i><b>10.7.7</b> Custom job schedulers</a></li>
<li class="chapter" data-level="10.7.8" data-path="hpc.html"><a href="hpc.html#hasty-mode"><i class="fa fa-check"></i><b>10.7.8</b> Hasty mode</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="triggers.html"><a href="triggers.html"><i class="fa fa-check"></i><b>11</b> Triggers: decision rules for building targets</a><ul>
<li class="chapter" data-level="11.1" data-path="triggers.html"><a href="triggers.html#what-are-triggers"><i class="fa fa-check"></i><b>11.1</b> What are triggers?</a></li>
<li class="chapter" data-level="11.2" data-path="triggers.html"><a href="triggers.html#customization"><i class="fa fa-check"></i><b>11.2</b> Customization</a></li>
<li class="chapter" data-level="11.3" data-path="triggers.html"><a href="triggers.html#alternative-trigger-modes"><i class="fa fa-check"></i><b>11.3</b> Alternative trigger modes</a></li>
<li class="chapter" data-level="11.4" data-path="triggers.html"><a href="triggers.html#consider-hasty-mode"><i class="fa fa-check"></i><b>11.4</b> Consider hasty mode</a></li>
<li class="chapter" data-level="11.5" data-path="triggers.html"><a href="triggers.html#a-more-practical-example"><i class="fa fa-check"></i><b>11.5</b> A more practical example</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="time.html"><a href="time.html"><i class="fa fa-check"></i><b>12</b> Time: logging, prediction, and strategy</a><ul>
<li class="chapter" data-level="12.1" data-path="time.html"><a href="time.html#predict-total-runtime"><i class="fa fa-check"></i><b>12.1</b> Predict total runtime</a></li>
<li class="chapter" data-level="12.2" data-path="time.html"><a href="time.html#strategize-your-high-performance-computing"><i class="fa fa-check"></i><b>12.2</b> Strategize your high-performance computing</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="store.html"><a href="store.html"><i class="fa fa-check"></i><b>13</b> Storage</a><ul>
<li class="chapter" data-level="13.1" data-path="store.html"><a href="store.html#cache-formats"><i class="fa fa-check"></i><b>13.1</b> Cache formats</a><ul>
<li class="chapter" data-level="13.1.1" data-path="store.html"><a href="store.html#rds-caches"><i class="fa fa-check"></i><b>13.1.1</b> RDS caches</a></li>
<li class="chapter" data-level="13.1.2" data-path="store.html"><a href="store.html#database-caches"><i class="fa fa-check"></i><b>13.1.2</b> Database caches</a></li>
<li class="chapter" data-level="13.1.3" data-path="store.html"><a href="store.html#environment-caches"><i class="fa fa-check"></i><b>13.1.3</b> Environment caches</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="store.html"><a href="store.html#hash-algorithms"><i class="fa fa-check"></i><b>13.2</b> Hash algorithms</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="faq.html"><a href="faq.html"><i class="fa fa-check"></i><b>A</b> Frequently-asked questions</a></li>
<li class="chapter" data-level="B" data-path="caution.html"><a href="caution.html"><i class="fa fa-check"></i><b>B</b> Cautionary notes</a><ul>
<li class="chapter" data-level="B.1" data-path="caution.html"><a href="caution.html#workflow-plans"><i class="fa fa-check"></i><b>B.1</b> Workflow plans</a><ul>
<li class="chapter" data-level="B.1.1" data-path="caution.html"><a href="caution.html#externalizing-commands-in-r-script-files"><i class="fa fa-check"></i><b>B.1.1</b> Externalizing commands in R script files</a></li>
<li class="chapter" data-level="B.1.2" data-path="caution.html"><a href="caution.html#commands-are-not-perfectly-flexible."><i class="fa fa-check"></i><b>B.1.2</b> Commands are NOT perfectly flexible.</a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="caution.html"><a href="caution.html#execution"><i class="fa fa-check"></i><b>B.2</b> Execution</a><ul>
<li class="chapter" data-level="B.2.1" data-path="caution.html"><a href="caution.html#install-drake-properly."><i class="fa fa-check"></i><b>B.2.1</b> Install <code>drake</code> properly.</a></li>
<li class="chapter" data-level="B.2.2" data-path="caution.html"><a href="caution.html#install-all-your-packages."><i class="fa fa-check"></i><b>B.2.2</b> Install all your packages.</a></li>
<li class="chapter" data-level="B.2.3" data-path="caution.html"><a href="caution.html#a-note-on-tidy-evaluation"><i class="fa fa-check"></i><b>B.2.3</b> A note on tidy evaluation</a></li>
<li class="chapter" data-level="B.2.4" data-path="caution.html"><a href="caution.html#find-and-diagnose-your-errors."><i class="fa fa-check"></i><b>B.2.4</b> Find and diagnose your errors.</a></li>
<li class="chapter" data-level="B.2.5" data-path="caution.html"><a href="caution.html#refresh-the-drake_config-list-early-and-often."><i class="fa fa-check"></i><b>B.2.5</b> Refresh the <code>drake_config()</code> list early and often.</a></li>
<li class="chapter" data-level="B.2.6" data-path="caution.html"><a href="caution.html#workflows-as-r-packages."><i class="fa fa-check"></i><b>B.2.6</b> Workflows as R packages.</a></li>
<li class="chapter" data-level="B.2.7" data-path="caution.html"><a href="caution.html#the-lazy_load-flag-does-not-work-with-parlapply-parallelism."><i class="fa fa-check"></i><b>B.2.7</b> The <code>lazy_load</code> flag does not work with <code>&quot;parLapply&quot;</code> parallelism.</a></li>
<li class="chapter" data-level="B.2.8" data-path="caution.html"><a href="caution.html#timeouts-may-be-unreliable."><i class="fa fa-check"></i><b>B.2.8</b> Timeouts may be unreliable.</a></li>
</ul></li>
<li class="chapter" data-level="B.3" data-path="caution.html"><a href="caution.html#dependencies-1"><i class="fa fa-check"></i><b>B.3</b> Dependencies</a><ul>
<li class="chapter" data-level="B.3.1" data-path="caution.html"><a href="caution.html#objects-that-contain-functions-may-rebuild-too-often"><i class="fa fa-check"></i><b>B.3.1</b> Objects that contain functions may rebuild too often</a></li>
<li class="chapter" data-level="B.3.2" data-path="caution.html"><a href="caution.html#dependencies-are-not-tracked-in-some-edge-cases."><i class="fa fa-check"></i><b>B.3.2</b> Dependencies are not tracked in some edge cases.</a></li>
<li class="chapter" data-level="B.3.3" data-path="caution.html"><a href="caution.html#dependencies-of-knitr-reports"><i class="fa fa-check"></i><b>B.3.3</b> Dependencies of <code>knitr</code> reports</a></li>
<li class="chapter" data-level="B.3.4" data-path="caution.html"><a href="caution.html#s3-and-generic-methods"><i class="fa fa-check"></i><b>B.3.4</b> S3 and generic methods</a></li>
<li class="chapter" data-level="B.3.5" data-path="caution.html"><a href="caution.html#file-outputs-in-imported-functions."><i class="fa fa-check"></i><b>B.3.5</b> File outputs in imported functions.</a></li>
<li class="chapter" data-level="B.3.6" data-path="caution.html"><a href="caution.html#functions-produced-by-vectorize"><i class="fa fa-check"></i><b>B.3.6</b> Functions produced by <code>Vectorize()</code></a></li>
<li class="chapter" data-level="B.3.7" data-path="caution.html"><a href="caution.html#compiled-code-is-not-reproducibly-tracked."><i class="fa fa-check"></i><b>B.3.7</b> Compiled code is not reproducibly tracked.</a></li>
<li class="chapter" data-level="B.3.8" data-path="caution.html"><a href="caution.html#directories-folders-are-not-reproducibly-tracked."><i class="fa fa-check"></i><b>B.3.8</b> Directories (folders) are not reproducibly tracked.</a></li>
<li class="chapter" data-level="B.3.9" data-path="caution.html"><a href="caution.html#packages-are-not-tracked-as-dependencies."><i class="fa fa-check"></i><b>B.3.9</b> Packages are not tracked as dependencies.</a></li>
</ul></li>
<li class="chapter" data-level="B.4" data-path="caution.html"><a href="caution.html#high-performance-computing"><i class="fa fa-check"></i><b>B.4</b> High-performance computing</a><ul>
<li class="chapter" data-level="B.4.1" data-path="caution.html"><a href="caution.html#calling-mclapply-within-targets"><i class="fa fa-check"></i><b>B.4.1</b> Calling <code>mclapply()</code> <em>within</em> targets</a></li>
<li class="chapter" data-level="B.4.2" data-path="caution.html"><a href="caution.html#zombie-processes"><i class="fa fa-check"></i><b>B.4.2</b> Zombie processes</a></li>
</ul></li>
<li class="chapter" data-level="B.5" data-path="caution.html"><a href="caution.html#storage-1"><i class="fa fa-check"></i><b>B.5</b> Storage</a><ul>
<li class="chapter" data-level="B.5.1" data-path="caution.html"><a href="caution.html#projects-hosted-on-dropbox-and-similar-platforms"><i class="fa fa-check"></i><b>B.5.1</b> Projects hosted on Dropbox and similar platforms</a></li>
<li class="chapter" data-level="B.5.2" data-path="caution.html"><a href="caution.html#cache-customization-is-limited"><i class="fa fa-check"></i><b>B.5.2</b> Cache customization is limited</a></li>
<li class="chapter" data-level="B.5.3" data-path="caution.html"><a href="caution.html#runtime-predictions"><i class="fa fa-check"></i><b>B.5.3</b> Runtime predictions</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The drake R Package User Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="plans" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> <code>drake</code> plans</h1>
<div id="what-is-a-drake-plan" class="section level2">
<h2><span class="header-section-number">3.1</span> What is a <code>drake</code> plan?</h2>
<p>A <code>drake</code> plan is a data frame with columns named <code>target</code> and <code>command</code>. Each target is an R object, and each command is an <a href="http://adv-r.had.co.nz/Expressions.html">expression</a> to produce it.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> The <code>drake_plan()</code> function is the best way to set up plans.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> Recall the plan from the <a href="walkthrough.html#walkthrough">walkthrough</a>:</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">raw_data =</span> readxl<span class="op">::</span><span class="kw">read_excel</span>(<span class="kw">file_in</span>(<span class="st">&quot;raw_data.xlsx&quot;</span>)),
  <span class="dt">data =</span> raw_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Species =</span> forcats<span class="op">::</span><span class="kw">fct_inorder</span>(Species)),
  <span class="dt">hist =</span> <span class="kw">create_plot</span>(data),
  <span class="dt">fit =</span> <span class="kw">lm</span>(Sepal.Width <span class="op">~</span><span class="st"> </span>Petal.Width <span class="op">+</span><span class="st"> </span>Species, data),
  <span class="dt">report =</span> rmarkdown<span class="op">::</span><span class="kw">render</span>(
    <span class="kw">knitr_in</span>(<span class="st">&quot;report.Rmd&quot;</span>),
    <span class="dt">output_file =</span> <span class="kw">file_out</span>(<span class="st">&quot;report.html&quot;</span>),
    <span class="dt">quiet =</span> <span class="ot">TRUE</span>
  )
)

plan
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 4 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
<p><code>drake_plan()</code> does not run the workflow, it only creates the plan. To build the actual targets, we need to run <code>make()</code>. Creating the plan is like writing an R script, and running <code>make(your_plan)</code> is like calling <a href="https://www.rdocumentation.org/packages/base/versions/3.5.2/topics/source"><code>source(&quot;your_script.R&quot;)</code></a>.</p>
</div>
<div id="plans-are-similar-to-r-scripts." class="section level2">
<h2><span class="header-section-number">3.2</span> Plans are similar to R scripts.</h2>
<p>Your <code>drake</code> plan is like a top-level R script that runs everything from end to end. In fact, you can convert back and forth between plans and scripts using functions <a href="https://ropensci.github.io/drake/reference/plan_to_code.html"><code>plan_to_code()</code></a> and <a href="https://ropensci.github.io/drake/reference/code_to_plan.html"><code>code_to_plan()</code></a> (with some <a href="https://ropensci.github.io/drake/reference/code_to_plan.html#details">caveats</a>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plan_to_code</span>(plan, <span class="st">&quot;new_script.R&quot;</span>)
<span class="co">#&gt; Loading required namespace: styler</span>
<span class="kw">cat</span>(<span class="kw">readLines</span>(<span class="st">&quot;new_script.R&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
<span class="co">#&gt; raw_data &lt;- readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))</span>
<span class="co">#&gt; data &lt;- raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))</span>
<span class="co">#&gt; fit &lt;- lm(Sepal.Width ~ Petal.Width + Species, data)</span>
<span class="co">#&gt; hist &lt;- create_plot(data)</span>
<span class="co">#&gt; report &lt;- rmarkdown::render(knitr_in(&quot;report.Rmd&quot;),</span>
<span class="co">#&gt;   output_file = file_out(&quot;report.html&quot;),</span>
<span class="co">#&gt;   quiet = TRUE</span>
<span class="co">#&gt; )</span>

<span class="kw">code_to_plan</span>(<span class="st">&quot;new_script.R&quot;</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 4 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
<p>And <a href="https://ropensci.github.io/drake/reference/plan_to_notebook.html"><code>plan_to_notebook()</code></a> turns plans into <a href="https://bookdown.org/yihui/rmarkdown/notebook.html">R notebooks</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plan_to_notebook</span>(plan, <span class="st">&quot;new_notebook.Rmd&quot;</span>)
<span class="kw">cat</span>(<span class="kw">readLines</span>(<span class="st">&quot;new_notebook.Rmd&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
<span class="co">#&gt; ---</span>
<span class="co">#&gt; title: &quot;My Notebook&quot;</span>
<span class="co">#&gt; output: html_notebook</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ```{r my_code}</span>
<span class="co">#&gt; raw_data &lt;- readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))</span>
<span class="co">#&gt; data &lt;- raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))</span>
<span class="co">#&gt; fit &lt;- lm(Sepal.Width ~ Petal.Width + Species, data)</span>
<span class="co">#&gt; hist &lt;- create_plot(data)</span>
<span class="co">#&gt; report &lt;- rmarkdown::render(knitr_in(&quot;report.Rmd&quot;),</span>
<span class="co">#&gt;   output_file = file_out(&quot;report.html&quot;),</span>
<span class="co">#&gt;   quiet = TRUE</span>
<span class="co">#&gt; )</span>
<span class="co">#&gt; ```</span>

<span class="kw">code_to_plan</span>(<span class="st">&quot;new_notebook.Rmd&quot;</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 4 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
</div>
<div id="so-why-do-we-use-plans" class="section level2">
<h2><span class="header-section-number">3.3</span> So why do we use plans?</h2>
<p>If you have ever waited more than 10 minutes for an R script to finish, then you know the frustration of having to rerun the whole thing every time you make a change. Plans make life easier.</p>
<div id="plans-chop-up-the-work-into-pieces." class="section level3">
<h3><span class="header-section-number">3.3.1</span> Plans chop up the work into pieces.</h3>
<p>Some targets may need an update while others may not. In the <a href="walkthrough.html#walkthrough">walkthrough</a>, <code>make()</code> was smart enough to skip the data cleaning step and just rebuild the plot and report. <code>drake</code> and its plans compartmentalize the work, and this can save you from wasted effort in the long run.</p>
</div>
<div id="drake-uses-plans-to-schedule-you-work." class="section level3">
<h3><span class="header-section-number">3.3.2</span> <code>drake</code> uses plans to schedule you work.</h3>
<p><code>make()</code> automatically learns the build order of your targets and <a href="hpc.html#hpc">how to run them in parallel</a>. The underlying magic is <a href="http://adv-r.had.co.nz/Expressions.html#ast-funs"><em>static code analysis</em></a>, which automatically detects the dependencies of each target without having to run its command.</p>
<pre class="sourceCode r"><code class="sourceCode r">create_plot &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="kw">ggplot</span>(data, <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">&quot;Petal.Width&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;Species&quot;</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">20</span>)
}

<span class="kw">deps_code</span>(create_plot)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   name           type   </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;  </span>
<span class="co">#&gt; 1 geom_histogram globals</span>
<span class="co">#&gt; 2 ggplot         globals</span>
<span class="co">#&gt; 3 aes_string     globals</span>

<span class="kw">deps_code</span>(<span class="kw">quote</span>(<span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   name           type      </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;     </span>
<span class="co">#&gt; 1 create_plot    globals   </span>
<span class="co">#&gt; 2 datasets::iris namespaced</span></code></pre>
<p>Because of the dependency relationships, row order does not matter once the plan is fully defined. The following plan declares <code>file</code> before <code>plot</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">small_plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">file =</span> <span class="kw">ggsave</span>(<span class="kw">file_out</span>(<span class="st">&quot;plot.png&quot;</span>), plot, <span class="dt">width =</span> <span class="dv">7</span>, <span class="dt">height =</span> <span class="dv">5</span>),
  <span class="dt">plot =</span> <span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)
)</code></pre>
<p>But <code>file</code> actually depends on <code>plot</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">small_config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(small_plan)
<span class="kw">vis_drake_graph</span>(small_config)</code></pre>
<div id="htmlwidget-437c9b36fe661843587a" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-437c9b36fe661843587a">{"x":{"nodes":{"id":["create_plot","n-MRQXIYLTMV2HGOR2NFZGS4Y","plot","file","p-OBWG65BOOBXGO"],"imported":[true,true,false,false,false],"label":["create_plot","datasets::iris","plot","file","file plot.png"],"status":["imported","imported","outdated","outdated","outdated"],"type":["function","object","object","object","file"],"font.size":[20,20,20,20,20],"color":["#1874CD","#1874CD","#000000","#000000","#000000"],"shape":["triangle","dot","dot","dot","square"],"level":[1,1,2,3,4],"x":[-1,-1,-0.333333333333333,0.333333333333333,1],"y":[-1,1,2.22044604925031e-16,2.22044604925031e-16,2.22044604925031e-16]},"edges":{"from":["create_plot","plot","file","n-MRQXIYLTMV2HGOR2NFZGS4Y"],"to":["plot","file","p-OBWG65BOOBXGO","plot"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","File"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,5,7,8,9]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>So <code>make()</code> builds <code>plot</code> first.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">make</span>(small_plan)
<span class="co">#&gt; target plot</span>
<span class="co">#&gt; target file</span></code></pre>
</div>
</div>
<div id="special-custom-columns-in-your-plan" class="section level2">
<h2><span class="header-section-number">3.4</span> Special custom columns in your plan</h2>
<p>You can add other columns besides the required <code>target</code> and <code>command</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cbind</span>(small_plan, <span class="dt">cpu =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="co">#&gt;   target                                                   command cpu</span>
<span class="co">#&gt; 1   file ggsave(file_out(&quot;plot.png&quot;), plot, width = 7, height = 5)   1</span>
<span class="co">#&gt; 2   plot                               create_plot(datasets::iris)   2</span></code></pre>
<p>Within <code>drake_plan()</code>, <code>target()</code> lets you create any custom column except <code>target</code>, <code>command</code>, and <code>transform</code>, the last of which <a href="https://ropenscilabs.github.io/drake-manual/plans.html#create-large-plans-the-easy-way">has a special meaning</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">file =</span> <span class="kw">target</span>(
    <span class="kw">ggsave</span>(<span class="kw">file_out</span>(<span class="st">&quot;plot.png&quot;</span>), plot),
    <span class="dt">elapsed =</span> <span class="dv">10</span>
  ),
  <span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)
)
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   target         command                            elapsed</span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                               &lt;dbl&gt;</span>
<span class="co">#&gt; 1 file           ggsave(file_out(&quot;plot.png&quot;), plot)      10</span>
<span class="co">#&gt; 2 drake_target_1 create_plot(datasets::iris)             NA</span></code></pre>
<p>The following columns have special meanings for <code>make()</code>.</p>
<ul>
<li><code>elapsed</code> and <code>cpu</code>: number of seconds to wait for the target to build before timing out (<code>elapsed</code> for elapsed time and <code>cpu</code> for CPU time).</li>
<li><code>hpc</code>: logical values (<code>TRUE</code>/<code>FALSE</code>/<code>NA</code>) whether to send each target to parallel workers. <a href="https://ropenscilabs.github.io/drake-manual/hpc.html#selectivity">Click here</a> to learn more.</li>
<li><code>resources</code>: target-specific lists of resources for a computing cluster. See the advanced options in the <a href="hpc.html#hpc">parallel computing</a> chapter for details.</li>
<li><code>retries</code>: number of times to retry building a target in the event of an error.</li>
<li><code>trigger</code>: rule to decide whether a target needs to run. See the <a href="triggers.html#triggers">trigger chapter</a> to learn more.</li>
</ul>
</div>
<div id="large-plans" class="section level2">
<h2><span class="header-section-number">3.5</span> Large plans</h2>
<p><code>drake</code> version 7.0.0 introduced new syntax to make it easier to create plans. To try it out before the next <a href="http://cran.r-project.org">CRAN</a> release, install the <a href="https://github.com/ropensci/drake">current development version</a> from GitHub.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)
<span class="kw">library</span>(remotes)
<span class="kw">install_github</span>(<span class="st">&quot;ropensci/drake&quot;</span>)</code></pre>
<div id="how-to-create-large-plans" class="section level3">
<h3><span class="header-section-number">3.5.1</span> How to create large plans</h3>
<p>Ordinarily, <code>drake_plan()</code> requires you to write out all the targets one-by-one. This is a literal pain.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis_1_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_2_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_5_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_10_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">10</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_100_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">100</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_1000_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1000</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_1_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_2_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_5_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_10_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">10</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_100_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">100</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_1000_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1000</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="co"># UUUGGGHH my wrists are cramping! :( ...</span>
)</code></pre>
<p>Transformations reduce typing, especially when combined with tidy evaluation (<code>!!</code>).</p>
<pre class="sourceCode r"><code class="sourceCode r">lots_of_sds &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="dv">1</span><span class="op">:</span><span class="fl">1e3</span>)

<span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">fun</span>(data, <span class="dt">mean =</span> mean_val, <span class="dt">sd =</span> sd_val),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">mean_val =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>), <span class="dt">sd_val =</span> <span class="op">!!</span>lots_of_sds)
  )
)
<span class="co">#&gt; # A tibble: 5,001 x 2</span>
<span class="co">#&gt;    target          command                       </span>
<span class="co">#&gt;    &lt;chr&gt;           &lt;expr&gt;                        </span>
<span class="co">#&gt;  1 data            get_data()                    </span>
<span class="co">#&gt;  2 analysis_2_1    fun(data, mean = 2, sd = 1)   </span>
<span class="co">#&gt;  3 analysis_5_1    fun(data, mean = 5, sd = 1)   </span>
<span class="co">#&gt;  4 analysis_10_1   fun(data, mean = 10, sd = 1)  </span>
<span class="co">#&gt;  5 analysis_100_1  fun(data, mean = 100, sd = 1) </span>
<span class="co">#&gt;  6 analysis_1000_1 fun(data, mean = 1000, sd = 1)</span>
<span class="co">#&gt;  7 analysis_2_2    fun(data, mean = 2, sd = 2)   </span>
<span class="co">#&gt;  8 analysis_5_2    fun(data, mean = 5, sd = 2)   </span>
<span class="co">#&gt;  9 analysis_10_2   fun(data, mean = 10, sd = 2)  </span>
<span class="co">#&gt; 10 analysis_100_2  fun(data, mean = 100, sd = 2) </span>
<span class="co">#&gt; # … with 4,991 more rows</span></code></pre>
<p>Behind the scenes during a transformation, <code>drake_plan()</code> creates new columns to track what is happening. You can see them with <code>trace = TRUE</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">analyze</span>(data, mean, sd),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="dt">sd =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   target       command             mean  sd    analysis    </span>
<span class="co">#&gt;   &lt;chr&gt;        &lt;expr&gt;              &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1 data         get_data()          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;        </span>
<span class="co">#&gt; 2 analysis_3_1 analyze(data, 3, 1) 3     1     analysis_3_1</span>
<span class="co">#&gt; 3 analysis_4_2 analyze(data, 4, 2) 4     2     analysis_4_2</span></code></pre>
<p>Because of those columns, you can chain transformations together in complex pipelines.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan1 &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">small =</span> <span class="kw">get_small_data</span>(),
  <span class="dt">large =</span> <span class="kw">get_large_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>( <span class="co"># Analyze each dataset once with a different mean.</span>
    <span class="kw">analyze</span>(data, mean),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">data =</span> <span class="kw">c</span>(small, large), <span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="co"># Calculate 2 different performance metrics on every model fit.</span>
  <span class="dt">metric =</span> <span class="kw">target</span>(
    <span class="kw">metric_fun</span>(analysis),
    <span class="co"># mse = mean squared error, mae = mean absolute error.</span>
    <span class="co"># Assume these are functions you write.</span>
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">metric_fun =</span> <span class="kw">c</span>(mse, mae), analysis)
  ),
  <span class="co"># Summarize the performance metrics for each dataset.</span>
  <span class="dt">summ_data =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> data)
  ),
  <span class="co"># Same, but for each metric type.</span>
  <span class="dt">summ_metric =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> metric_fun)
  )
)

plan1
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target                 command                                          </span>
<span class="co">#&gt;    &lt;chr&gt;                  &lt;expr&gt;                                           </span>
<span class="co">#&gt;  1 small                  get_small_data()                                …</span>
<span class="co">#&gt;  2 large                  get_large_data()                                …</span>
<span class="co">#&gt;  3 analysis_small_1       analyze(small, 1)                               …</span>
<span class="co">#&gt;  4 analysis_large_2       analyze(large, 2)                               …</span>
<span class="co">#&gt;  5 metric_mse_analysis_s… mse(analysis_small_1)                           …</span>
<span class="co">#&gt;  6 metric_mae_analysis_s… mae(analysis_small_1)                           …</span>
<span class="co">#&gt;  7 metric_mse_analysis_l… mse(analysis_large_2)                           …</span>
<span class="co">#&gt;  8 metric_mae_analysis_l… mae(analysis_large_2)                           …</span>
<span class="co">#&gt;  9 summ_data_large        summary(metric_mse_analysis_large_2, metric_mae_…</span>
<span class="co">#&gt; 10 summ_data_small        summary(metric_mse_analysis_small_1, metric_mae_…</span>
<span class="co">#&gt; 11 summ_metric_mae        summary(metric_mae_analysis_small_1, metric_mae_…</span>
<span class="co">#&gt; 12 summ_metric_mse        summary(metric_mse_analysis_small_1, metric_mse_…</span>

config1 &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan1)
<span class="kw">vis_drake_graph</span>(config1)</code></pre>
<div id="htmlwidget-52077144b47bb6e4b9dc" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-52077144b47bb6e4b9dc">{"x":{"nodes":{"id":["small","large","analysis_small_1","analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","summ_data_small","summ_metric_mae","summ_data_large","summ_metric_mse"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["small","large","analysis_small_1","analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","summ_data_small","summ_metric_mae","summ_data_large","summ_metric_mse"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[1,1,2,2,3,3,3,3,4,4,4,4],"x":[-1,-1,-0.333333333333333,-0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,1,1,1,1],"y":[-0.555555555555556,0.555555555555555,-0.555555555555556,0.555555555555555,-1,-0.333333333333333,0.333333333333333,1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["small","large","analysis_small_1","analysis_small_1","analysis_large_2","analysis_large_2","metric_mae_analysis_large_2","metric_mae_analysis_large_2","metric_mse_analysis_large_2","metric_mse_analysis_large_2","metric_mae_analysis_small_1","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mse_analysis_small_1"],"to":["analysis_small_1","analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","summ_data_large","summ_metric_mae","summ_data_large","summ_metric_mse","summ_data_small","summ_metric_mae","summ_data_small","summ_metric_mse"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>And you can write the transformations in any order. The following plan is equivalent to <code>plan1</code> despite the rearranged rows.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan2 &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="co"># Calculate 2 different performance metrics on every model fit.</span>
  <span class="dt">summ_metric =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> metric_fun)
  ),
  <span class="dt">metric =</span> <span class="kw">target</span>(
    <span class="kw">metric_fun</span>(analysis),
    <span class="co"># mse = mean squared error, mae = mean absolute error.</span>
    <span class="co"># Assume these are functions you write.</span>
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">metric_fun =</span> <span class="kw">c</span>(mse, mae), analysis)
  ),
  <span class="dt">small =</span> <span class="kw">get_small_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>( <span class="co"># Analyze each dataset once with a different mean.</span>
    <span class="kw">analyze</span>(data, mean),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">data =</span> <span class="kw">c</span>(small, large), <span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="co"># Summarize the performance metrics for each dataset.</span>
  <span class="dt">summ_data =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> data)
  ),
  <span class="dt">large =</span> <span class="kw">get_large_data</span>()
  <span class="co"># Same, but for each metric type.</span>
)

plan2
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target                 command                                          </span>
<span class="co">#&gt;    &lt;chr&gt;                  &lt;expr&gt;                                           </span>
<span class="co">#&gt;  1 summ_metric_mae        summary(metric_mae_analysis_small_1, metric_mae_…</span>
<span class="co">#&gt;  2 summ_metric_mse        summary(metric_mse_analysis_small_1, metric_mse_…</span>
<span class="co">#&gt;  3 metric_mse_analysis_s… mse(analysis_small_1)                           …</span>
<span class="co">#&gt;  4 metric_mae_analysis_s… mae(analysis_small_1)                           …</span>
<span class="co">#&gt;  5 metric_mse_analysis_l… mse(analysis_large_2)                           …</span>
<span class="co">#&gt;  6 metric_mae_analysis_l… mae(analysis_large_2)                           …</span>
<span class="co">#&gt;  7 small                  get_small_data()                                …</span>
<span class="co">#&gt;  8 analysis_small_1       analyze(small, 1)                               …</span>
<span class="co">#&gt;  9 analysis_large_2       analyze(large, 2)                               …</span>
<span class="co">#&gt; 10 summ_data_large        summary(metric_mse_analysis_large_2, metric_mae_…</span>
<span class="co">#&gt; 11 summ_data_small        summary(metric_mse_analysis_small_1, metric_mae_…</span>
<span class="co">#&gt; 12 large                  get_large_data()                                …</span>

config2 &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan2)
<span class="kw">vis_drake_graph</span>(config2)</code></pre>
<div id="htmlwidget-5b2f3f64e2ae588c1146" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-5b2f3f64e2ae588c1146">{"x":{"nodes":{"id":["small","large","analysis_small_1","analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","summ_data_small","summ_metric_mae","summ_metric_mse","summ_data_large"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["small","large","analysis_small_1","analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","summ_data_small","summ_metric_mae","summ_metric_mse","summ_data_large"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[1,1,2,2,3,3,3,3,4,4,4,4],"x":[-1,-1,-0.333333333333333,-0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,1,1,1,1],"y":[-0.555555555555556,0.555555555555555,-0.555555555555556,0.555555555555555,-1,-0.333333333333333,0.333333333333333,1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["metric_mae_analysis_large_2","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_large_2","metric_mse_analysis_small_1","metric_mse_analysis_small_1","analysis_small_1","analysis_small_1","analysis_large_2","analysis_large_2","small","large"],"to":["summ_metric_mae","summ_data_large","summ_metric_mae","summ_data_small","summ_metric_mse","summ_data_large","summ_metric_mse","summ_data_small","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mae_analysis_large_2","metric_mse_analysis_large_2","analysis_small_1","analysis_large_2"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="start-small" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Start small</h3>
<p>Some plans are too large to deploy right away.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(source),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">source =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>))
  ),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">fn</span>(data, param),
    <span class="dt">transform =</span> <span class="kw">cross</span>(
      data,
      <span class="dt">fn =</span> <span class="op">!!</span>letters,
      <span class="dt">param =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>)
    ),
  ),
  <span class="dt">result =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(analysis),
    <span class="dt">transform =</span> <span class="kw">combine</span>(analysis, <span class="dt">.by =</span> fn)
  )
)

<span class="kw">dim</span>(plan)
<span class="co">#&gt; [1] 16301     2</span></code></pre>
<p>It is extremely difficult to understand, visualize, test, and debug a workflow with so many targets. <code>make()</code>, <code>drake_config()</code>, and <code>vis_drake_graph()</code> simply take too long if you are not ready for production.</p>
<p>To speed up initial testing and experimentation, you may want to limit the number of extra targets created by the <code>map()</code> and <code>cross()</code> transformations. Simply set <code>max_expand</code> in <code>drake_plan()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">max_expand =</span> <span class="dv">2</span>,
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(source),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">source =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>))
  ),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">fn</span>(data, param),
    <span class="dt">transform =</span> <span class="kw">cross</span>(
      data,
      <span class="dt">fn =</span> <span class="op">!!</span>letters,
      <span class="dt">param =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>)
    ),
  ),
  <span class="dt">result =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(analysis),
    <span class="dt">transform =</span> <span class="kw">combine</span>(analysis, <span class="dt">.by =</span> fn)
  )
)

plan
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target              command                                             </span>
<span class="co">#&gt;    &lt;chr&gt;               &lt;expr&gt;                                              </span>
<span class="co">#&gt;  1 data_1L             get_data(1L)                                       …</span>
<span class="co">#&gt;  2 data_25L            get_data(25L)                                      …</span>
<span class="co">#&gt;  3 analysis_a_1L_data… a(data_1L, 1L)                                     …</span>
<span class="co">#&gt;  4 analysis_z_1L_data… z(data_1L, 1L)                                     …</span>
<span class="co">#&gt;  5 analysis_a_25L_dat… a(data_1L, 25L)                                    …</span>
<span class="co">#&gt;  6 analysis_z_25L_dat… z(data_1L, 25L)                                    …</span>
<span class="co">#&gt;  7 analysis_a_1L_data… a(data_25L, 1L)                                    …</span>
<span class="co">#&gt;  8 analysis_z_1L_data… z(data_25L, 1L)                                    …</span>
<span class="co">#&gt;  9 analysis_a_25L_dat… a(data_25L, 25L)                                   …</span>
<span class="co">#&gt; 10 analysis_z_25L_dat… z(data_25L, 25L)                                   …</span>
<span class="co">#&gt; 11 result_a            bind_rows(analysis_a_1L_data_1L, analysis_a_25L_dat…</span>
<span class="co">#&gt; 12 result_z            bind_rows(analysis_z_1L_data_1L, analysis_z_25L_dat…</span></code></pre>
<p>With a downsized plan, we can inspect the graph to make sure the dependencies line up correctly.</p>
<pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-4bd26251e3510f85efcc" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-4bd26251e3510f85efcc">{"x":{"nodes":{"id":["data_1L","data_25L","analysis_a_25L_data_1L","analysis_a_1L_data_1L","analysis_z_1L_data_1L","analysis_z_25L_data_1L","analysis_a_1L_data_25L","analysis_a_25L_data_25L","analysis_z_1L_data_25L","analysis_z_25L_data_25L","result_a","result_z"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["data_1L","data_25L","analysis_a_25L_data_1L","analysis_a_1L_data_1L","analysis_z_1L_data_1L","analysis_z_25L_data_1L","analysis_a_1L_data_25L","analysis_a_25L_data_25L","analysis_z_1L_data_25L","analysis_z_25L_data_25L","result_a","result_z"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[1,1,2,2,2,2,2,2,2,2,3,3],"x":[-1,-1,0,0,0,0,0,0,0,0,1,1],"y":[-0.428571428571428,0.428571428571429,-1,-0.714285714285714,-0.428571428571428,-0.142857142857143,0.142857142857143,0.428571428571429,0.714285714285714,1,-0.428571428571428,0.428571428571429]},"edges":{"from":["data_1L","data_1L","data_1L","data_1L","data_25L","data_25L","data_25L","data_25L","analysis_a_25L_data_1L","analysis_a_1L_data_25L","analysis_a_25L_data_25L","analysis_a_1L_data_1L","analysis_z_1L_data_25L","analysis_z_1L_data_1L","analysis_z_25L_data_1L","analysis_z_25L_data_25L"],"to":["analysis_a_25L_data_1L","analysis_a_1L_data_1L","analysis_z_1L_data_1L","analysis_z_25L_data_1L","analysis_a_1L_data_25L","analysis_a_25L_data_25L","analysis_z_1L_data_25L","analysis_z_25L_data_25L","result_a","result_a","result_a","result_a","result_z","result_z","result_z","result_z"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>We can even run <code>make(plan)</code> and check a strategic subset of targets.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(plan)                       <span class="co"># Run the small subset of targets we kept.</span>
<span class="kw">loadd</span>()                          <span class="co"># Load all those targets into memory.</span>
<span class="kw">summary</span>(analysis_z_25L_data_13L) <span class="co"># Look at the values of those targets</span>
                                 <span class="co"># and decide if we are ready to scale up.</span></code></pre>
<p>When we are ready to scale back up, we simply remove <code>max_expand</code> from the call to <code>drake_plan()</code>. Nothing else needs to change.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(source),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">source =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>))
  ),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">fn</span>(data, param),
    <span class="dt">transform =</span> <span class="kw">cross</span>(
      data,
      <span class="dt">fn =</span> <span class="op">!!</span>letters,
      <span class="dt">param =</span> <span class="op">!!</span><span class="kw">seq_len</span>(<span class="dv">25</span>)
    ),
  ),
  <span class="dt">result =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(analysis),
    <span class="dt">transform =</span> <span class="kw">combine</span>(analysis, <span class="dt">.by =</span> fn)
  )
)

<span class="kw">nrow</span>(plan)
<span class="co">#&gt; [1] 16301</span></code></pre>
</div>
<div id="the-types-of-transformations" class="section level3">
<h3><span class="header-section-number">3.5.3</span> The types of transformations</h3>
<p><code>drake</code> supports three types of transformations: <code>map()</code>, <code>cross()</code>, <code>split()</code> (unsupported in <code>drake</code> &lt;= 7.3.0), and <code>combine()</code>. These are not actual functions, but you can treat them as functions when you use them in <code>drake_plan()</code>. Each transformation takes after a function from the <a href="https://www.tidyverse.org/">Tidyverse</a>.</p>
<table>
<thead>
<tr class="header">
<th><code>drake</code></th>
<th>Tidyverse analogue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>map()</code></td>
<td><code>pmap()</code> from <code>purrr</code></td>
</tr>
<tr class="even">
<td><code>cross()</code></td>
<td><code>crossing()</code> from <code>tidyr</code></td>
</tr>
<tr class="odd">
<td><code>split()</code></td>
<td><code>group_map()</code> from <code>dplyr</code></td>
</tr>
<tr class="even">
<td><code>combine()</code></td>
<td><code>summarize()</code> from <code>dplyr</code></td>
</tr>
</tbody>
</table>
<div id="map" class="section level4">
<h4><span class="header-section-number">3.5.3.1</span> <code>map()</code></h4>
<p><code>map()</code> creates a new target for each row in a grid.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center, scale),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="dt">scale =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))
  )
)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_2_3  simulate_data(2, 3)</span>
<span class="co">#&gt; 2 x_1_2  simulate_data(1, 2)</span>
<span class="co">#&gt; 3 x_0_1  simulate_data(0, 1)</span></code></pre>
<p>You can supply your own custom grid using the <code>.data</code> argument. Note the use of <code>!!</code> below.</p>
<pre class="sourceCode r"><code class="sourceCode r">my_grid &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">sim_function =</span> <span class="kw">c</span>(<span class="st">&quot;rnrom&quot;</span>, <span class="st">&quot;rt&quot;</span>, <span class="st">&quot;rcauchy&quot;</span>),
  <span class="dt">title =</span> <span class="kw">c</span>(<span class="st">&quot;Normal&quot;</span>, <span class="st">&quot;Student t&quot;</span>, <span class="st">&quot;Cauchy&quot;</span>)
)
my_grid<span class="op">$</span>sim_function &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">syms</span>(my_grid<span class="op">$</span>sim_function)

<span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(sim_function, title, center, scale),
    <span class="dt">transform =</span> <span class="kw">map</span>(
      <span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>),
      <span class="dt">scale =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>),
      <span class="dt">.data =</span> <span class="op">!!</span>my_grid,
      <span class="co"># In `.id`, you can select one or more grouping variables</span>
      <span class="co"># for pretty target names.</span>
      <span class="co"># Set to FALSE to use short numeric suffixes.</span>
      <span class="dt">.id =</span> sim_function <span class="co"># Try `.id = c(sim_function, center)` yourself.</span>
    )
  )
)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target    command                               </span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;expr&gt;                                </span>
<span class="co">#&gt; 1 x_rnrom   simulate_data(rnrom, &quot;Normal&quot;, 2, 3)  </span>
<span class="co">#&gt; 2 x_rt      simulate_data(rt, &quot;Student t&quot;, 1, 2)  </span>
<span class="co">#&gt; 3 x_rcauchy simulate_data(rcauchy, &quot;Cauchy&quot;, 0, 1)</span></code></pre>
</div>
<div id="special-considerations-in-map" class="section level4">
<h4><span class="header-section-number">3.5.3.2</span> Special considerations in <code>map()</code></h4>
<p><code>map()</code> column-binds variables together to create a grid. The lengths of those variables need to be conformable just as with <code>data.frame()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center, scale),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="dt">scale =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))
  )
)
<span class="co">#&gt; Error: Failed to make a grid of grouping variables for map().</span>
<span class="co">#&gt; Grouping variables in map() must have suitable lengths for coercion to a data frame.</span>
<span class="co">#&gt; Possibly uneven groupings detected in map(center = c(2, 1, 0), scale = c(3, 2)):</span>
<span class="co">#&gt;   c(&quot;2&quot;, &quot;1&quot;, &quot;0&quot;)</span>
<span class="co">#&gt;   c(&quot;3&quot;, &quot;2&quot;)</span></code></pre>
<p>Sometimes, the results are sensible when grouping variable lengths are multiples of each other, but be careful.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center, scale),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="dt">scale =</span> <span class="dv">4</span>)
  )
)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_2_4  simulate_data(2, 4)</span>
<span class="co">#&gt; 2 x_1_4  simulate_data(1, 4)</span>
<span class="co">#&gt; 3 x_0_4  simulate_data(0, 4)</span></code></pre>
<p>Things get tricker when <code>drake</code> reuses grouping variables from previous transformations. For example, below, each <code>x_*</code> target has an associated <code>nrow</code> value. So if you write <code>transform = map(x)</code>, then <code>nrow</code> goes along for the ride.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="dt">y =</span> <span class="kw">target</span>(
    <span class="kw">process_data</span>(x, center),
    <span class="dt">transform =</span> <span class="kw">map</span>(x)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span> <span class="co"># Adds extra columns for the grouping variables.</span>
)
<span class="co">#&gt; # A tibble: 4 x 5</span>
<span class="co">#&gt;   target command              center x     y    </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;               &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x_1    simulate_data(1)     1      x_1   &lt;NA&gt; </span>
<span class="co">#&gt; 2 x_2    simulate_data(2)     2      x_2   &lt;NA&gt; </span>
<span class="co">#&gt; 3 y_x_1  process_data(x_1, 1) 1      x_1   y_x_1</span>
<span class="co">#&gt; 4 y_x_2  process_data(x_2, 2) 2      x_2   y_x_2</span></code></pre>
<p>But if other targets have <code>centers</code>’s of their own, <code>drake_plan()</code> may not know what to do with them.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">w =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data_2</span>(center),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="dt">y =</span> <span class="kw">target</span>(
    <span class="kw">process_data</span>(w, x, center),
    <span class="dt">transform =</span> <span class="kw">map</span>(w, x)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   target    command                    center w     x     y        </span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;expr&gt;                     &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    </span>
<span class="co">#&gt; 1 w_3       simulate_data(3)           3      w_3   &lt;NA&gt;  &lt;NA&gt;     </span>
<span class="co">#&gt; 2 w_4       simulate_data(4)           4      w_4   &lt;NA&gt;  &lt;NA&gt;     </span>
<span class="co">#&gt; 3 x_1       simulate_data_2(1)         1      &lt;NA&gt;  x_1   &lt;NA&gt;     </span>
<span class="co">#&gt; 4 x_2       simulate_data_2(2)         2      &lt;NA&gt;  x_2   &lt;NA&gt;     </span>
<span class="co">#&gt; 5 y_w_3_x_1 process_data(w_3, x_1, NA) &lt;NA&gt;   w_3   x_1   y_w_3_x_1</span>
<span class="co">#&gt; 6 y_w_4_x_2 process_data(w_4, x_2, NA) &lt;NA&gt;   w_4   x_2   y_w_4_x_2</span></code></pre>
<p>The problems is that there are 4 values of <code>center</code> and only two <code>x_*</code> targets (and two <code>y_*</code> targets). Even if you explicitly supply <code>center</code> to the transformation, <code>map()</code> can only takes the first two values.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">w =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(center),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data_2</span>(center),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">center =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="dt">y =</span> <span class="kw">target</span>(
    <span class="kw">process_data</span>(w, x, center),
    <span class="dt">transform =</span> <span class="kw">map</span>(w, x, center)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   target      command                   center w     x     y          </span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;expr&gt;                    &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      </span>
<span class="co">#&gt; 1 w_3         simulate_data(3)          3      w_3   &lt;NA&gt;  &lt;NA&gt;       </span>
<span class="co">#&gt; 2 w_4         simulate_data(4)          4      w_4   &lt;NA&gt;  &lt;NA&gt;       </span>
<span class="co">#&gt; 3 x_1         simulate_data_2(1)        1      &lt;NA&gt;  x_1   &lt;NA&gt;       </span>
<span class="co">#&gt; 4 x_2         simulate_data_2(2)        2      &lt;NA&gt;  x_2   &lt;NA&gt;       </span>
<span class="co">#&gt; 5 y_w_3_x_1_3 process_data(w_3, x_1, 3) 3      w_3   x_1   y_w_3_x_1_3</span>
<span class="co">#&gt; 6 y_w_4_x_2_4 process_data(w_4, x_2, 4) 4      w_4   x_2   y_w_4_x_2_4</span></code></pre>
<p>So please inspect the plan before you run it with <code>make()</code>. Once you have a <code>drake_config()</code> object, <code>vis_drake_graph()</code> and <code>deps_target()</code> can help.</p>
</div>
<div id="cross" class="section level4">
<h4><span class="header-section-number">3.5.3.3</span> <code>cross()</code></h4>
<p><code>cross()</code> creates a new target for each combination of argument values.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(nrow, ncol),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">nrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))
  )
)
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_1_4  simulate_data(1, 4)</span>
<span class="co">#&gt; 2 x_2_4  simulate_data(2, 4)</span>
<span class="co">#&gt; 3 x_3_4  simulate_data(3, 4)</span>
<span class="co">#&gt; 4 x_1_5  simulate_data(1, 5)</span>
<span class="co">#&gt; 5 x_2_5  simulate_data(2, 5)</span>
<span class="co">#&gt; 6 x_3_5  simulate_data(3, 5)</span></code></pre>
</div>
<div id="split" class="section level4">
<h4><span class="header-section-number">3.5.3.4</span> <code>split()</code></h4>
<p><code>split()</code> is not supported in <code>drake</code> 7.3.0 and below. It should reach the next CRAN release in June 2019.</p>
<p>The <code>split()</code> transformation distributes a dataset as uniformly as possible across multiple targets.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">large_data =</span> <span class="kw">get_data</span>(),
  <span class="dt">slice_analysis =</span> <span class="kw">target</span>(
    large_data <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">analyze</span>(),
    <span class="dt">transform =</span> <span class="kw">split</span>(large_data, <span class="dt">slices =</span> <span class="dv">4</span>)
  ),
  <span class="dt">results =</span> <span class="kw">target</span>(
    dplyr<span class="op">::</span><span class="kw">bind_rows</span>(slice_analysis),
    <span class="dt">transform =</span> <span class="kw">combine</span>(slice_analysis)
  )
)

plan
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   target         command                                                   </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                                                    </span>
<span class="co">#&gt; 1 large_data     get_data()                                               …</span>
<span class="co">#&gt; 2 slice_analysi… drake_slice(data = large_data, slices = 4, index = 1) %&gt;%…</span>
<span class="co">#&gt; 3 slice_analysi… drake_slice(data = large_data, slices = 4, index = 2) %&gt;%…</span>
<span class="co">#&gt; 4 slice_analysi… drake_slice(data = large_data, slices = 4, index = 3) %&gt;%…</span>
<span class="co">#&gt; 5 slice_analysi… drake_slice(data = large_data, slices = 4, index = 4) %&gt;%…</span>
<span class="co">#&gt; 6 results        dplyr::bind_rows(slice_analysis_1, slice_analysis_2, slic…</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-c8c2efd752b3f9f48dc8" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-c8c2efd752b3f9f48dc8">{"x":{"nodes":{"id":["large_data","n-MRYGY6LSHI5GE2LOMRPXE33XOM","slice_analysis_1","slice_analysis_2","slice_analysis_3","slice_analysis_4","results"],"imported":[false,true,false,false,false,false,false],"label":["large_data","dplyr::bind_rows","slice_analysis_1","slice_analysis_2","slice_analysis_3","slice_analysis_4","results"],"status":["outdated","imported","outdated","outdated","outdated","outdated","outdated"],"type":["object","function","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20],"color":["#000000","#1874CD","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","triangle","dot","dot","dot","dot","dot"],"level":[1,1,2,2,2,2,3],"x":[-1,-1,0,0,0,0,1],"y":[-0.555555555555556,0.555555555555555,-1,-0.333333333333333,0.333333333333333,1,-2.22044604925031e-16]},"edges":{"from":["large_data","large_data","large_data","large_data","slice_analysis_1","slice_analysis_2","slice_analysis_3","slice_analysis_4","n-MRYGY6LSHI5GE2LOMRPXE33XOM"],"to":["slice_analysis_1","slice_analysis_2","slice_analysis_3","slice_analysis_4","results","results","results","results","results"],"arrows":["to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function"],"color":["#000000","#1874CD","#888888","#888888"],"shape":["dot","dot","dot","triangle"],"font.color":["black","black","black","black"],"font.size":[20,20,20,20],"id":[2,5,7,8]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>Here, <code>drake_slice()</code> takes a single subset of the data at runtime.</p>
<pre class="sourceCode r"><code class="sourceCode r">dataset &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw">as_tibble</span>(iris)
<span class="kw">dim</span>(dataset)
<span class="co">#&gt; [1] 150   5</span>

<span class="kw">drake_slice</span>(dataset, <span class="dt">slices =</span> <span class="dv">50</span>, <span class="dt">index =</span> <span class="dv">1</span>)
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class="co">#&gt; 1          5.1         3.5          1.4         0.2 setosa </span>
<span class="co">#&gt; 2          4.9         3            1.4         0.2 setosa </span>
<span class="co">#&gt; 3          4.7         3.2          1.3         0.2 setosa</span>

<span class="kw">drake_slice</span>(dataset, <span class="dt">slices =</span> <span class="dv">50</span>, <span class="dt">index =</span> <span class="dv">2</span>)
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class="co">#&gt;          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  </span>
<span class="co">#&gt; 1          4.6         3.1          1.5         0.2 setosa </span>
<span class="co">#&gt; 2          5           3.6          1.4         0.2 setosa </span>
<span class="co">#&gt; 3          5.4         3.9          1.7         0.4 setosa</span>

<span class="kw">drake_slice</span>(dataset, <span class="dt">slices =</span> <span class="dv">3</span>, <span class="dt">index =</span> <span class="dv">1</span>, <span class="dt">margin =</span> <span class="dv">2</span>)
<span class="co">#&gt; # A tibble: 150 x 2</span>
<span class="co">#&gt;    Sepal.Length Sepal.Width</span>
<span class="co">#&gt;           &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1          5.1         3.5</span>
<span class="co">#&gt;  2          4.9         3  </span>
<span class="co">#&gt;  3          4.7         3.2</span>
<span class="co">#&gt;  4          4.6         3.1</span>
<span class="co">#&gt;  5          5           3.6</span>
<span class="co">#&gt;  6          5.4         3.9</span>
<span class="co">#&gt;  7          4.6         3.4</span>
<span class="co">#&gt;  8          5           3.4</span>
<span class="co">#&gt;  9          4.4         2.9</span>
<span class="co">#&gt; 10          4.9         3.1</span>
<span class="co">#&gt; # … with 140 more rows</span></code></pre>
<p><code>drake_slice()</code> supports data frames, matrices, and arbitrary arrays, and you can subset on any margin (rows, columns, etc). Even better, you can split up ordinary vectors and lists. Instead of taking slices of the actual dataset, you can split up a set of indices. Combined with <a href="hpc.html#hpc">high-performance computing</a>, this should help you avoid loading an entire big data file into memory on a single compute node.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">all_rows =</span> <span class="kw">file_in</span>(<span class="st">&quot;huge.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">number_of_rows</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">seq_len</span>(),
  <span class="dt">rows =</span> <span class="kw">target</span>(
    all_rows,
    <span class="dt">transform =</span> <span class="kw">split</span>(all_rows, <span class="dt">slices =</span> <span class="dv">3</span>)
  ),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">read_rows</span>( <span class="co"># custom function</span>
      <span class="dt">file =</span> <span class="kw">file_in</span>(<span class="st">&quot;huge.csv&quot;</span>),
      <span class="dt">rows =</span> rows
    ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">analyze_data</span>(),
    <span class="dt">transform =</span> <span class="kw">map</span>(rows, <span class="dt">.id =</span> rows_index) <span class="co"># an internal trick</span>
  )
)

<span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   all_rows = file_in(&quot;huge.csv&quot;) %&gt;%</span>
<span class="co">#&gt;     number_of_rows() %&gt;%</span>
<span class="co">#&gt;     seq_len(),</span>
<span class="co">#&gt;   rows_1 = drake_slice(data = all_rows, slices = 3, index = 1),</span>
<span class="co">#&gt;   rows_2 = drake_slice(data = all_rows, slices = 3, index = 2),</span>
<span class="co">#&gt;   rows_3 = drake_slice(data = all_rows, slices = 3, index = 3),</span>
<span class="co">#&gt;   analysis_1 = read_rows(file = file_in(&quot;huge.csv&quot;), rows = rows_1) %&gt;% analyze_data(),</span>
<span class="co">#&gt;   analysis_2 = read_rows(file = file_in(&quot;huge.csv&quot;), rows = rows_2) %&gt;% analyze_data(),</span>
<span class="co">#&gt;   analysis_3 = read_rows(file = file_in(&quot;huge.csv&quot;), rows = rows_3) %&gt;% analyze_data()</span>
<span class="co">#&gt; )</span></code></pre>
</div>
<div id="combine" class="section level4">
<h4><span class="header-section-number">3.5.3.5</span> <code>combine()</code></h4>
<p>In <code>combine()</code>, you can insert multiple targets into individual commands. The closest comparison is the unquote-splice operator <code>!!!</code> from the Tidyverse.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">larger =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(data, <span class="dt">.id =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">arrange</span>(sd) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">400</span>),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data)
  )
)

plan
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 data_1_3 sim_data(mean = 1, sd = 3)                                     …</span>
<span class="co">#&gt; 2 data_2_4 sim_data(mean = 2, sd = 4)                                     …</span>
<span class="co">#&gt; 3 larger   bind_rows(data_1_3, data_2_4, .id = &quot;id&quot;) %&gt;% arrange(sd) %&gt;%  …</span>

<span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   data_1_3 = sim_data(mean = 1, sd = 3),</span>
<span class="co">#&gt;   data_2_4 = sim_data(mean = 2, sd = 4),</span>
<span class="co">#&gt;   larger = bind_rows(data_1_3, data_2_4, .id = &quot;id&quot;) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400)</span>
<span class="co">#&gt; )</span>

config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-094a7ca09aea0953f3fb" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-094a7ca09aea0953f3fb">{"x":{"nodes":{"id":["data_1_3","data_2_4","larger"],"imported":[false,false,false],"label":["data_1_3","data_2_4","larger"],"status":["outdated","outdated","outdated"],"type":["object","object","object"],"font.size":[20,20,20],"color":["#000000","#000000","#000000"],"shape":["dot","dot","dot"],"level":[1,1,2],"x":[-1,-1,1],"y":[-1,1,2.22044604925031e-16]},"edges":{"from":["data_1_3","data_2_4"],"to":["larger","larger"],"arrows":["to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>You can different groups of targets in the same command.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data_group1 =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">data_group2 =</span> <span class="kw">target</span>(
    <span class="kw">pull_data</span>(url),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">url =</span> <span class="kw">c</span>(<span class="st">&quot;example1.com&quot;</span>, <span class="st">&quot;example2.com&quot;</span>))
  ),
  <span class="dt">larger =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(data_group1, data_group2, <span class="dt">.id =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">arrange</span>(sd) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">400</span>),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data_group1, data_group2)
  )
)

<span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   data_group1_1_3 = sim_data(mean = 1, sd = 3),</span>
<span class="co">#&gt;   data_group1_2_4 = sim_data(mean = 2, sd = 4),</span>
<span class="co">#&gt;   data_group2_example1.com = pull_data(&quot;example1.com&quot;),</span>
<span class="co">#&gt;   data_group2_example2.com = pull_data(&quot;example2.com&quot;),</span>
<span class="co">#&gt;   larger = bind_rows(data_group1_1_3, data_group1_2_4, data_group2_example1.com,</span>
<span class="co">#&gt;     data_group2_example2.com,</span>
<span class="co">#&gt;     .id = &quot;id&quot;</span>
<span class="co">#&gt;   ) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400)</span>
<span class="co">#&gt; )</span></code></pre>
<p>And as with <code>group_by()</code> from <code>dplyr</code>, you can create a separate aggregate for each combination of levels of the arguments. Just pass a symbol or vector of symbols to the optional <code>.by</code> argument of <code>combine()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y, <span class="dt">skew =</span> z),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="dt">z =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>))
  ),
  <span class="dt">combined =</span> <span class="kw">target</span>(
    <span class="kw">bind_rows</span>(data, <span class="dt">.id =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">arrange</span>(sd) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">400</span>),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> <span class="kw">c</span>(x, y))
  )
)

<span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   data_1_3_5 = sim_data(mean = 1, sd = 3, skew = 5),</span>
<span class="co">#&gt;   data_2_3_5 = sim_data(mean = 2, sd = 3, skew = 5),</span>
<span class="co">#&gt;   data_1_4_5 = sim_data(mean = 1, sd = 4, skew = 5),</span>
<span class="co">#&gt;   data_2_4_5 = sim_data(mean = 2, sd = 4, skew = 5),</span>
<span class="co">#&gt;   data_1_3_6 = sim_data(mean = 1, sd = 3, skew = 6),</span>
<span class="co">#&gt;   data_2_3_6 = sim_data(mean = 2, sd = 3, skew = 6),</span>
<span class="co">#&gt;   data_1_4_6 = sim_data(mean = 1, sd = 4, skew = 6),</span>
<span class="co">#&gt;   data_2_4_6 = sim_data(mean = 2, sd = 4, skew = 6),</span>
<span class="co">#&gt;   combined_1_3 = bind_rows(data_1_3_5, data_1_3_6, .id = &quot;id&quot;) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400),</span>
<span class="co">#&gt;   combined_2_3 = bind_rows(data_2_3_5, data_2_3_6, .id = &quot;id&quot;) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400),</span>
<span class="co">#&gt;   combined_1_4 = bind_rows(data_1_4_5, data_1_4_6, .id = &quot;id&quot;) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400),</span>
<span class="co">#&gt;   combined_2_4 = bind_rows(data_2_4_5, data_2_4_6, .id = &quot;id&quot;) %&gt;%</span>
<span class="co">#&gt;     arrange(sd) %&gt;%</span>
<span class="co">#&gt;     head(n = 400)</span>
<span class="co">#&gt; )</span></code></pre>
<p>In your post-processing, you may need the values of <code>x</code> and <code>y</code> that underly <code>data_1_3</code> and <code>data_2_4</code>. Solution: get the trace and the target names. We define a new plan</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">larger =</span> <span class="kw">target</span>(
    <span class="kw">post_process</span>(data, <span class="dt">plan =</span> <span class="kw">ignore</span>(plan)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">arrange</span>(sd) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">400</span>),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)

<span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   data_1_3 = target(</span>
<span class="co">#&gt;     command = sim_data(mean = 1, sd = 3),</span>
<span class="co">#&gt;     x = &quot;1&quot;,</span>
<span class="co">#&gt;     y = &quot;3&quot;,</span>
<span class="co">#&gt;     data = &quot;data_1_3&quot;</span>
<span class="co">#&gt;   ),</span>
<span class="co">#&gt;   data_2_4 = target(</span>
<span class="co">#&gt;     command = sim_data(mean = 2, sd = 4),</span>
<span class="co">#&gt;     x = &quot;2&quot;,</span>
<span class="co">#&gt;     y = &quot;4&quot;,</span>
<span class="co">#&gt;     data = &quot;data_2_4&quot;</span>
<span class="co">#&gt;   ),</span>
<span class="co">#&gt;   larger = target(</span>
<span class="co">#&gt;     command = post_process(data_1_3, data_2_4, plan = ignore(plan)) %&gt;%</span>
<span class="co">#&gt;       arrange(sd) %&gt;%</span>
<span class="co">#&gt;       head(n = 400),</span>
<span class="co">#&gt;     larger = &quot;larger&quot;</span>
<span class="co">#&gt;   )</span>
<span class="co">#&gt; )</span></code></pre>
<p>and a new function</p>
<pre class="sourceCode r"><code class="sourceCode r">post_process &lt;-<span class="st"> </span><span class="cf">function</span>(..., plan) {
  args &lt;-<span class="st"> </span><span class="kw">list</span>(...)
  <span class="kw">names</span>(args) &lt;-<span class="st"> </span><span class="kw">all.vars</span>(<span class="kw">substitute</span>(<span class="kw">list</span>(...)))
  trace &lt;-<span class="st"> </span><span class="kw">filter</span>(plan, target <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(args))
  <span class="co"># Do post-processing with args and trace.</span>
}</code></pre>
</div>
</div>
<div id="grouping-variables" class="section level3">
<h3><span class="header-section-number">3.5.4</span> Grouping variables</h3>
<p>A grouping variable is an argument to <code>map()</code>, <code>cross()</code>, or <code>combine()</code> that identifies a sub-collection of target names. Grouping variables can be either literals or symbols. Symbols can be scalars or vectors, and you can pass them to transformations with or without argument names.</p>
<div id="literal-arguments" class="section level4">
<h4><span class="header-section-number">3.5.4.1</span> Literal arguments</h4>
<p>When you pass a grouping variable of literals, you must use an explicit argument name. One does not simply write <code>map(c(1, 2))</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_2    sqrt(2)</span></code></pre>
<p>And if you supply integer sequences the usual way, you may notice some rows are missing.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_3    sqrt(3)</span></code></pre>
<p>Tidy evaluation and <code>as.numeric()</code> make sure all the data points show up.</p>
<pre class="sourceCode r"><code class="sourceCode r">y_vals &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>y_vals)))
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_2    sqrt(2)</span>
<span class="co">#&gt; 3 x_3    sqrt(3)</span></code></pre>
<p>Character vectors usually work without a hitch, and quotes are converted into dots to make valid target names.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))))
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command      </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;       </span>
<span class="co">#&gt; 1 x_a    get_data(&quot;a&quot;)</span>
<span class="co">#&gt; 2 x_b    get_data(&quot;b&quot;)</span>
<span class="co">#&gt; 3 x_c    get_data(&quot;c&quot;)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r">y_vals &lt;-<span class="st"> </span>letters
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>y_vals)))
<span class="co">#&gt; # A tibble: 26 x 2</span>
<span class="co">#&gt;    target command      </span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;expr&gt;       </span>
<span class="co">#&gt;  1 x_a    get_data(&quot;a&quot;)</span>
<span class="co">#&gt;  2 x_b    get_data(&quot;b&quot;)</span>
<span class="co">#&gt;  3 x_c    get_data(&quot;c&quot;)</span>
<span class="co">#&gt;  4 x_d    get_data(&quot;d&quot;)</span>
<span class="co">#&gt;  5 x_e    get_data(&quot;e&quot;)</span>
<span class="co">#&gt;  6 x_f    get_data(&quot;f&quot;)</span>
<span class="co">#&gt;  7 x_g    get_data(&quot;g&quot;)</span>
<span class="co">#&gt;  8 x_h    get_data(&quot;h&quot;)</span>
<span class="co">#&gt;  9 x_i    get_data(&quot;i&quot;)</span>
<span class="co">#&gt; 10 x_j    get_data(&quot;j&quot;)</span>
<span class="co">#&gt; # … with 16 more rows</span></code></pre>
</div>
<div id="named-symbol-arguments" class="section level4">
<h4><span class="header-section-number">3.5.4.2</span> Named symbol arguments</h4>
<p>Symbols passed with explicit argument names define new groupings of existing targets on the fly, and only the <code>map()</code> and <code>cross()</code> transformations can accept them this ways. To generate long symbol lists, use the <code>syms()</code> function from the <code>rlang</code> package. Remember to use the tidy evaluation operator <code>!!</code> inside the transformation.</p>
<pre class="sourceCode r"><code class="sourceCode r">vals &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">syms</span>(letters)
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>vals)))
<span class="co">#&gt; # A tibble: 26 x 2</span>
<span class="co">#&gt;    target command    </span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;expr&gt;     </span>
<span class="co">#&gt;  1 x_a    get_data(a)</span>
<span class="co">#&gt;  2 x_b    get_data(b)</span>
<span class="co">#&gt;  3 x_c    get_data(c)</span>
<span class="co">#&gt;  4 x_d    get_data(d)</span>
<span class="co">#&gt;  5 x_e    get_data(e)</span>
<span class="co">#&gt;  6 x_f    get_data(f)</span>
<span class="co">#&gt;  7 x_g    get_data(g)</span>
<span class="co">#&gt;  8 x_h    get_data(h)</span>
<span class="co">#&gt;  9 x_i    get_data(i)</span>
<span class="co">#&gt; 10 x_j    get_data(j)</span>
<span class="co">#&gt; # … with 16 more rows</span></code></pre>
<p>The new groupings carry over to downstream targets by default, which you can see with <code>trace = TRUE</code>. Below, the rows for targets <code>w_x</code> and <code>w_y</code> have entries in the and <code>z</code> column.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">10</span>))),
  <span class="dt">y =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="dv">1</span>))),
  <span class="dt">z =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(val), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">w =</span> <span class="kw">target</span>(val <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">transform =</span> <span class="kw">map</span>(val)),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   target command                  val   z     w    </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;                   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x      abs(mean(rnorm(10)))     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 2 y      abs(mean(rnorm(100, 1))) &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 3 z_x    sqrt(x)                  x     z_x   &lt;NA&gt; </span>
<span class="co">#&gt; 4 z_y    sqrt(y)                  y     z_y   &lt;NA&gt; </span>
<span class="co">#&gt; 5 w_x    x + 1                    x     z_x   w_x  </span>
<span class="co">#&gt; 6 w_y    y + 1                    y     z_y   w_y</span></code></pre>
<p>However, this is <em>incorrect</em> because <code>w</code> does not depend on <code>z_x</code> or <code>z_y</code>. So for <code>w</code>, you should write <code>map(val = c(x, y))</code> instead of <code>map(val)</code> to tell <code>drake</code> to clear the trace. Then, you will see <code>NA</code>s in the <code>z</code> column for <code>w_x</code> and <code>w_y</code>, which is right and proper.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">10</span>))),
  <span class="dt">y =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="dv">1</span>))),
  <span class="dt">z =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(val), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">w =</span> <span class="kw">target</span>(val <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   target command                  val   z     w    </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;                   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x      abs(mean(rnorm(10)))     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 2 y      abs(mean(rnorm(100, 1))) &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 3 z_x    sqrt(x)                  x     z_x   &lt;NA&gt; </span>
<span class="co">#&gt; 4 z_y    sqrt(y)                  y     z_y   &lt;NA&gt; </span>
<span class="co">#&gt; 5 w_x    x + 1                    x     &lt;NA&gt;  w_x  </span>
<span class="co">#&gt; 6 w_y    y + 1                    y     &lt;NA&gt;  w_y</span></code></pre>
</div>
</div>
<div id="tags" class="section level3">
<h3><span class="header-section-number">3.5.5</span> Tags</h3>
<p>Tags are special optional grouping variables. They are ignored while the transformation is happening and then added to the plan to help subsequent transformations. There are two types of tags:</p>
<ol style="list-style-type: decimal">
<li>In-tags, which contain the target name you start with, and</li>
<li>Out-tags, which contain the target names generated by the transformations.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    command,
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> from, <span class="dt">.tag_out =</span> <span class="kw">c</span>(to, out))
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 2 x 7</span>
<span class="co">#&gt;   target command y     x     from  to    out  </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x_1    command 1     x_1   x     x_1   x_1  </span>
<span class="co">#&gt; 2 x_2    command 2     x_2   x     x_2   x_2</span></code></pre>
<p>Subsequent transformations can use tags as grouping variables and add to existing tags.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">prep_work =</span> <span class="kw">do_prep_work</span>(),
  <span class="dt">local =</span> <span class="kw">target</span>(
    <span class="kw">get_local_data</span>(n, prep_work),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> data_source, <span class="dt">.tag_out =</span> data)
  ),
  <span class="dt">online =</span> <span class="kw">target</span>(
    <span class="kw">get_online_data</span>(n, prep_work, <span class="dt">port =</span> <span class="st">&quot;8080&quot;</span>),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> data_source, <span class="dt">.tag_out =</span> data)
  ),
  <span class="dt">summary =</span> <span class="kw">target</span>(
    <span class="kw">summarize</span>(<span class="kw">bind_rows</span>(data, <span class="dt">.id =</span> <span class="st">&quot;data&quot;</span>)),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> data_source)
  ),
  <span class="dt">munged =</span> <span class="kw">target</span>(
    <span class="kw">munge</span>(<span class="kw">bind_rows</span>(data, <span class="dt">.id =</span> <span class="st">&quot;data&quot;</span>)),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> n)
  )
)

plan
<span class="co">#&gt; # A tibble: 9 x 2</span>
<span class="co">#&gt;   target         command                                               </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                                                </span>
<span class="co">#&gt; 1 prep_work      do_prep_work()                                        </span>
<span class="co">#&gt; 2 local_1        get_local_data(1, prep_work)                          </span>
<span class="co">#&gt; 3 local_2        get_local_data(2, prep_work)                          </span>
<span class="co">#&gt; 4 online_1       get_online_data(1, prep_work, port = &quot;8080&quot;)          </span>
<span class="co">#&gt; 5 online_2       get_online_data(2, prep_work, port = &quot;8080&quot;)          </span>
<span class="co">#&gt; 6 summary_local  summarize(bind_rows(local_1, local_2, .id = &quot;data&quot;))  </span>
<span class="co">#&gt; 7 summary_online summarize(bind_rows(online_1, online_2, .id = &quot;data&quot;))</span>
<span class="co">#&gt; 8 munged_1       munge(bind_rows(local_1, online_1, .id = &quot;data&quot;))     </span>
<span class="co">#&gt; 9 munged_2       munge(bind_rows(local_2, online_2, .id = &quot;data&quot;))</span>

config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-d6a708145d7725acdca8" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-d6a708145d7725acdca8">{"x":{"nodes":{"id":["prep_work","local_1","local_2","online_1","online_2","summary_local","munged_1","summary_online","munged_2"],"imported":[false,false,false,false,false,false,false,false,false],"label":["prep_work","local_1","local_2","online_1","online_2","summary_local","munged_1","summary_online","munged_2"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[1,2,2,2,2,3,3,3,3],"x":[-1,0,0,0,0,1,1,1,1],"y":[-2.22044604925031e-16,-1,-0.333333333333333,0.333333333333333,1,-1,-0.333333333333333,0.333333333333333,1]},"edges":{"from":["prep_work","prep_work","prep_work","prep_work","local_1","local_1","local_2","local_2","online_1","online_1","online_2","online_2"],"to":["local_1","local_2","online_1","online_2","summary_local","munged_1","summary_local","munged_2","summary_online","munged_1","summary_online","munged_2"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p><br></p>
</div>
<div id="target-names" class="section level3">
<h3><span class="header-section-number">3.5.6</span> Target names</h3>
<p>All transformations have an optional <code>.id</code> argument to control the names of targets. Use it to select the grouping variables that go into the names, as well as the order they appear in the suffixes.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(param1, param2),
    <span class="dt">transform =</span> <span class="kw">map</span>(
      <span class="dt">param1 =</span> <span class="kw">c</span>(<span class="dv">123</span>, <span class="dv">456</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">9</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;xyz&quot;</span>),
      <span class="dt">.id =</span> param2
    )
  )
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command         </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;          </span>
<span class="co">#&gt; 1 data_7 get_data(123, 7)</span>
<span class="co">#&gt; 2 data_9 get_data(456, 9)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(param1, param2),
    <span class="dt">transform =</span> <span class="kw">map</span>(
      <span class="dt">param1 =</span> <span class="kw">c</span>(<span class="dv">123</span>, <span class="dv">456</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">9</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;xyz&quot;</span>),
      <span class="dt">.id =</span> <span class="kw">c</span>(param2, param1)
    )
  )
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target     command         </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;expr&gt;          </span>
<span class="co">#&gt; 1 data_7_123 get_data(123, 7)</span>
<span class="co">#&gt; 2 data_9_456 get_data(456, 9)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(param1, param2),
    <span class="dt">transform =</span> <span class="kw">map</span>(
      <span class="dt">param1 =</span> <span class="kw">c</span>(<span class="dv">123</span>, <span class="dv">456</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">9</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;xyz&quot;</span>),
      <span class="dt">.id =</span> <span class="kw">c</span>(param1, param2)
    )
  )
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target     command         </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;expr&gt;          </span>
<span class="co">#&gt; 1 data_123_7 get_data(123, 7)</span>
<span class="co">#&gt; 2 data_456_9 get_data(456, 9)</span></code></pre>
<p>Set <code>.id</code> to <code>FALSE</code> to ignore the grouping variables altogether.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(param1, param2),
    <span class="dt">transform =</span> <span class="kw">map</span>(
      <span class="dt">param1 =</span> <span class="kw">c</span>(<span class="dv">123</span>, <span class="dv">456</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">9</span>),
      <span class="dt">param2 =</span> <span class="kw">c</span>(<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;xyz&quot;</span>),
      <span class="dt">.id =</span> <span class="ot">FALSE</span>
    )
  )
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command         </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;          </span>
<span class="co">#&gt; 1 data   get_data(123, 7)</span>
<span class="co">#&gt; 2 data_2 get_data(456, 9)</span></code></pre>
<p>Finally, <code>drake</code> supports a special <code>.id_chr</code> symbol in commands to let you refer to the name of the current target as a character string.</p>
<pre class="sourceCode r"><code class="sourceCode r">as_chr &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="kw">deparse</span>(<span class="kw">substitute</span>(x))
}
plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">get_data</span>(param),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">param =</span> <span class="kw">c</span>(<span class="dv">123</span>, <span class="dv">456</span>))
  ),
  <span class="dt">keras_model =</span> <span class="kw">target</span>(
    <span class="kw">save_model_hdf5</span>(<span class="kw">fit_model</span>(data), <span class="kw">file_out</span>(<span class="op">!!</span><span class="kw">sprintf</span>(<span class="st">&quot;%s.h5&quot;</span>, .id_chr))),
    <span class="dt">transform =</span> <span class="kw">map</span>(data, <span class="dt">.id =</span> param)
  ),
  <span class="dt">result =</span> <span class="kw">target</span>(
    <span class="kw">predict</span>(<span class="kw">load_model_hdf5</span>(<span class="kw">file_in</span>(<span class="op">!!</span><span class="kw">sprintf</span>(<span class="st">&quot;%s.h5&quot;</span>, <span class="kw">as_chr</span>(keras_model))))),
    <span class="dt">transform =</span> <span class="kw">map</span>(keras_model, <span class="dt">.id =</span> param)
  )
)

plan
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   target         command                                                   </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                                                    </span>
<span class="co">#&gt; 1 data_123       get_data(123)                                            …</span>
<span class="co">#&gt; 2 data_456       get_data(456)                                            …</span>
<span class="co">#&gt; 3 keras_model_1… save_model_hdf5(fit_model(data_123), file_out(&quot;keras_mode…</span>
<span class="co">#&gt; 4 keras_model_4… save_model_hdf5(fit_model(data_456), file_out(&quot;keras_mode…</span>
<span class="co">#&gt; 5 result_123     predict(load_model_hdf5(file_in(&quot;keras_model_123.h5&quot;)))  …</span>
<span class="co">#&gt; 6 result_456     predict(load_model_hdf5(file_in(&quot;keras_model_456.h5&quot;)))  …</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan_source</span>(plan)
<span class="co">#&gt; drake_plan(</span>
<span class="co">#&gt;   data_123 = get_data(123),</span>
<span class="co">#&gt;   data_456 = get_data(456),</span>
<span class="co">#&gt;   keras_model_123 = save_model_hdf5(fit_model(data_123), file_out(&quot;keras_model_123.h5&quot;)),</span>
<span class="co">#&gt;   keras_model_456 = save_model_hdf5(fit_model(data_456), file_out(&quot;keras_model_456.h5&quot;)),</span>
<span class="co">#&gt;   result_123 = predict(load_model_hdf5(file_in(&quot;keras_model_123.h5&quot;))),</span>
<span class="co">#&gt;   result_456 = predict(load_model_hdf5(file_in(&quot;keras_model_456.h5&quot;)))</span>
<span class="co">#&gt; )</span></code></pre>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>You can turn the <code>command</code> column of your plan into a character vector (e.g. <code>plan$command &lt;- purrr::map_chr(plan$command, rlang::expr_text)</code>) and <code>drake</code> will still understand you. However, the recommended format is a list of <a href="http://adv-r.had.co.nz/Expressions.html">expressions</a>. <code>drake_plan()</code> and friends always supply <a href="http://adv-r.had.co.nz/Expressions.html">expression</a> lists.<a href="plans.html#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><code>drake_plan()</code> is the best way to create plans, but you can create plans any way you like. <code>drake</code> will understand plans you create directly using <code>data.frame()</code> or <code>tibble()</code>.<a href="plans.html#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
<div style = "background: #1C356D; color: white; padding: 10px 10px 10px 25px; font-size: 1em; width: 100%;">
  Copyright Eli Lilly and Company
</div>
            </section>

          </div>
        </div>
      </div>
<a href="walkthrough.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="projects.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ropenscilabs/drake-manual/edit/master/plans.Rmd",
"text": "Edit this chapter"
},
"history": {
"link": "https://github.com/ropenscilabs/drake-manual/commits/master/plans.Rmd",
"text": "Chapter edit history"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
