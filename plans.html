<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 6 drake plans | The drake R Package User Manual</title>
  <meta name="description" content="Chapter 6 drake plans | The drake R Package User Manual">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 6 drake plans | The drake R Package User Manual" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 drake plans | The drake R Package User Manual" />
  
  
  

<meta name="author" content="Will Landau, Kirill Müller, Alex Axthelm, Jasper Clarkberg, Lorenz Walthert">
<meta name="author" content="Copyright Eli Lilly and Company">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="mtcars.html">
<link rel="next" href="organize.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.5/visNetwork.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<script src="libs/sankey-1/sankey.js"></script>
<script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-drake-r-package"><i class="fa fa-check"></i><b>1.1</b> The drake R package</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#why-drake"><i class="fa fa-check"></i><b>1.3</b> Why drake?</a><ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#what-gets-done-stays-done."><i class="fa fa-check"></i><b>1.3.1</b> What gets done stays done.</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#reproducibility-with-confidence"><i class="fa fa-check"></i><b>1.3.2</b> Reproducibility with confidence</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#aggressively-scale-up."><i class="fa fa-check"></i><b>1.3.3</b> Aggressively scale up.</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#documentation"><i class="fa fa-check"></i><b>1.4</b> Documentation</a><ul>
<li class="chapter" data-level="1.4.1" data-path="index.html"><a href="index.html#cheat-sheet"><i class="fa fa-check"></i><b>1.4.1</b> Cheat sheet</a></li>
<li class="chapter" data-level="1.4.2" data-path="index.html"><a href="index.html#frequently-asked-questions"><i class="fa fa-check"></i><b>1.4.2</b> Frequently asked questions</a></li>
<li class="chapter" data-level="1.4.3" data-path="index.html"><a href="index.html#function-reference"><i class="fa fa-check"></i><b>1.4.3</b> Function reference</a></li>
<li class="chapter" data-level="1.4.4" data-path="index.html"><a href="index.html#tutorials"><i class="fa fa-check"></i><b>1.4.4</b> Tutorials</a></li>
<li class="chapter" data-level="1.4.5" data-path="index.html"><a href="index.html#examples"><i class="fa fa-check"></i><b>1.4.5</b> Examples</a></li>
<li class="chapter" data-level="1.4.6" data-path="index.html"><a href="index.html#presentations"><i class="fa fa-check"></i><b>1.4.6</b> Presentations</a></li>
<li class="chapter" data-level="1.4.7" data-path="index.html"><a href="index.html#real-example-projects"><i class="fa fa-check"></i><b>1.4.7</b> Real example projects</a></li>
<li class="chapter" data-level="1.4.8" data-path="index.html"><a href="index.html#context-and-history"><i class="fa fa-check"></i><b>1.4.8</b> Context and history</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#help-and-troubleshooting"><i class="fa fa-check"></i><b>1.5</b> Help and troubleshooting</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#similar-work"><i class="fa fa-check"></i><b>1.6</b> Similar work</a><ul>
<li class="chapter" data-level="1.6.1" data-path="index.html"><a href="index.html#gnu-make"><i class="fa fa-check"></i><b>1.6.1</b> GNU Make</a></li>
<li class="chapter" data-level="1.6.2" data-path="index.html"><a href="index.html#remake"><i class="fa fa-check"></i><b>1.6.2</b> Remake</a></li>
<li class="chapter" data-level="1.6.3" data-path="index.html"><a href="index.html#memoise"><i class="fa fa-check"></i><b>1.6.3</b> Memoise</a></li>
<li class="chapter" data-level="1.6.4" data-path="index.html"><a href="index.html#knitr-and-r-markdown"><i class="fa fa-check"></i><b>1.6.4</b> Knitr and R Markdown</a></li>
<li class="chapter" data-level="1.6.5" data-path="index.html"><a href="index.html#factuals-drake"><i class="fa fa-check"></i><b>1.6.5</b> Factual’s Drake</a></li>
<li class="chapter" data-level="1.6.6" data-path="index.html"><a href="index.html#other-pipeline-toolkits"><i class="fa fa-check"></i><b>1.6.6</b> Other pipeline toolkits</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i><b>1.7</b> Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Examples</b></span></li>
<li class="chapter" data-level="2" data-path="main.html"><a href="main.html"><i class="fa fa-check"></i><b>2</b> The main example</a><ul>
<li class="chapter" data-level="2.1" data-path="main.html"><a href="main.html#set-the-stage."><i class="fa fa-check"></i><b>2.1</b> Set the stage.</a></li>
<li class="chapter" data-level="2.2" data-path="main.html"><a href="main.html#make-your-results."><i class="fa fa-check"></i><b>2.2</b> Make your results.</a></li>
<li class="chapter" data-level="2.3" data-path="main.html"><a href="main.html#go-back-and-fix-things."><i class="fa fa-check"></i><b>2.3</b> Go back and fix things.</a></li>
<li class="chapter" data-level="2.4" data-path="main.html"><a href="main.html#try-it-yourself"><i class="fa fa-check"></i><b>2.4</b> Try it yourself!</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>3</b> An analysis of R package download trends</a><ul>
<li class="chapter" data-level="3.1" data-path="packages.html"><a href="packages.html#get-the-code."><i class="fa fa-check"></i><b>3.1</b> Get the code.</a></li>
<li class="chapter" data-level="3.2" data-path="packages.html"><a href="packages.html#overview"><i class="fa fa-check"></i><b>3.2</b> Overview</a></li>
<li class="chapter" data-level="3.3" data-path="packages.html"><a href="packages.html#analysis"><i class="fa fa-check"></i><b>3.3</b> Analysis</a></li>
<li class="chapter" data-level="3.4" data-path="packages.html"><a href="packages.html#other-ways-to-trigger-downloads"><i class="fa fa-check"></i><b>3.4</b> Other ways to trigger downloads</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gsp.html"><a href="gsp.html"><i class="fa fa-check"></i><b>4</b> Finding the best model of gross state product</a><ul>
<li class="chapter" data-level="4.1" data-path="gsp.html"><a href="gsp.html#get-the-code.-1"><i class="fa fa-check"></i><b>4.1</b> Get the code.</a></li>
<li class="chapter" data-level="4.2" data-path="gsp.html"><a href="gsp.html#objective-and-methods"><i class="fa fa-check"></i><b>4.2</b> Objective and methods</a></li>
<li class="chapter" data-level="4.3" data-path="gsp.html"><a href="gsp.html#data"><i class="fa fa-check"></i><b>4.3</b> Data</a></li>
<li class="chapter" data-level="4.4" data-path="gsp.html"><a href="gsp.html#analysis-1"><i class="fa fa-check"></i><b>4.4</b> Analysis</a></li>
<li class="chapter" data-level="4.5" data-path="gsp.html"><a href="gsp.html#results"><i class="fa fa-check"></i><b>4.5</b> Results</a></li>
<li class="chapter" data-level="4.6" data-path="gsp.html"><a href="gsp.html#comparison-with-gnu-make"><i class="fa fa-check"></i><b>4.6</b> Comparison with GNU Make</a></li>
<li class="chapter" data-level="4.7" data-path="gsp.html"><a href="gsp.html#references"><i class="fa fa-check"></i><b>4.7</b> References</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="mtcars.html"><a href="mtcars.html"><i class="fa fa-check"></i><b>5</b> The mtcars example and <code>drake</code> plan generation</a><ul>
<li class="chapter" data-level="5.1" data-path="mtcars.html"><a href="mtcars.html#get-the-code.-2"><i class="fa fa-check"></i><b>5.1</b> Get the code.</a></li>
<li class="chapter" data-level="5.2" data-path="mtcars.html"><a href="mtcars.html#quick-examples"><i class="fa fa-check"></i><b>5.2</b> Quick examples</a></li>
<li class="chapter" data-level="5.3" data-path="mtcars.html"><a href="mtcars.html#the-motivation-of-the-mtcars-example"><i class="fa fa-check"></i><b>5.3</b> The motivation of the mtcars example</a></li>
<li class="chapter" data-level="5.4" data-path="mtcars.html"><a href="mtcars.html#set-up-the-mtcars-example"><i class="fa fa-check"></i><b>5.4</b> Set up the mtcars example</a></li>
<li class="chapter" data-level="5.5" data-path="mtcars.html"><a href="mtcars.html#the-drake-plan"><i class="fa fa-check"></i><b>5.5</b> The <code>drake</code> plan</a></li>
<li class="chapter" data-level="5.6" data-path="mtcars.html"><a href="mtcars.html#generate-the-plan"><i class="fa fa-check"></i><b>5.6</b> Generate the plan</a><ul>
<li class="chapter" data-level="5.6.1" data-path="mtcars.html"><a href="mtcars.html#the-easy-way"><i class="fa fa-check"></i><b>5.6.1</b> The easy way</a></li>
<li class="chapter" data-level="5.6.2" data-path="mtcars.html"><a href="mtcars.html#the-old-way"><i class="fa fa-check"></i><b>5.6.2</b> The old way</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="mtcars.html"><a href="mtcars.html#run-the-workflow"><i class="fa fa-check"></i><b>5.7</b> Run the workflow</a></li>
</ul></li>
<li class="part"><span><b>II Functionality</b></span></li>
<li class="chapter" data-level="6" data-path="plans.html"><a href="plans.html"><i class="fa fa-check"></i><b>6</b> <code>drake</code> plans</a><ul>
<li class="chapter" data-level="6.1" data-path="plans.html"><a href="plans.html#what-is-a-drake-plan"><i class="fa fa-check"></i><b>6.1</b> What is a <code>drake</code> plan?</a></li>
<li class="chapter" data-level="6.2" data-path="plans.html"><a href="plans.html#plans-are-similar-to-r-scripts."><i class="fa fa-check"></i><b>6.2</b> Plans are similar to R scripts.</a></li>
<li class="chapter" data-level="6.3" data-path="plans.html"><a href="plans.html#so-why-do-we-use-plans"><i class="fa fa-check"></i><b>6.3</b> So why do we use plans?</a><ul>
<li class="chapter" data-level="6.3.1" data-path="plans.html"><a href="plans.html#plans-chop-up-the-work-into-pieces."><i class="fa fa-check"></i><b>6.3.1</b> Plans chop up the work into pieces.</a></li>
<li class="chapter" data-level="6.3.2" data-path="plans.html"><a href="plans.html#drake-uses-plans-to-schedule-you-work."><i class="fa fa-check"></i><b>6.3.2</b> <code>drake</code> uses plans to schedule you work.</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="plans.html"><a href="plans.html#special-custom-columns-in-your-plan."><i class="fa fa-check"></i><b>6.4</b> Special custom columns in your plan.</a></li>
<li class="chapter" data-level="6.5" data-path="plans.html"><a href="plans.html#large-plans"><i class="fa fa-check"></i><b>6.5</b> Large plans</a><ul>
<li class="chapter" data-level="6.5.1" data-path="plans.html"><a href="plans.html#how-to-create-large-plans"><i class="fa fa-check"></i><b>6.5.1</b> How to create large plans</a></li>
<li class="chapter" data-level="6.5.2" data-path="plans.html"><a href="plans.html#the-types-of-transformations"><i class="fa fa-check"></i><b>6.5.2</b> The types of transformations</a></li>
<li class="chapter" data-level="6.5.3" data-path="plans.html"><a href="plans.html#target-names"><i class="fa fa-check"></i><b>6.5.3</b> Target names</a></li>
<li class="chapter" data-level="6.5.4" data-path="plans.html"><a href="plans.html#grouping-variables"><i class="fa fa-check"></i><b>6.5.4</b> Grouping variables</a></li>
<li class="chapter" data-level="6.5.5" data-path="plans.html"><a href="plans.html#tags"><i class="fa fa-check"></i><b>6.5.5</b> Tags</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="plans.html"><a href="plans.html#create-large-plans-the-old-way"><i class="fa fa-check"></i><b>6.6</b> Create large plans the <em>old</em> way</a><ul>
<li class="chapter" data-level="6.6.1" data-path="plans.html"><a href="plans.html#map_plan"><i class="fa fa-check"></i><b>6.6.1</b> <code>map_plan()</code></a></li>
<li class="chapter" data-level="6.6.2" data-path="plans.html"><a href="plans.html#wildcard-templating"><i class="fa fa-check"></i><b>6.6.2</b> Wildcard templating</a></li>
<li class="chapter" data-level="6.6.3" data-path="plans.html"><a href="plans.html#wildcard-clusters"><i class="fa fa-check"></i><b>6.6.3</b> Wildcard clusters</a></li>
<li class="chapter" data-level="6.6.4" data-path="plans.html"><a href="plans.html#non-wildcard-functions"><i class="fa fa-check"></i><b>6.6.4</b> Non-wildcard functions</a></li>
<li class="chapter" data-level="6.6.5" data-path="plans.html"><a href="plans.html#custom-metaprogramming"><i class="fa fa-check"></i><b>6.6.5</b> Custom metaprogramming</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="organize.html"><a href="organize.html"><i class="fa fa-check"></i><b>7</b> How to organize the files of drake projects</a><ul>
<li class="chapter" data-level="7.1" data-path="organize.html"><a href="organize.html#examples-1"><i class="fa fa-check"></i><b>7.1</b> Examples</a></li>
<li class="chapter" data-level="7.2" data-path="organize.html"><a href="organize.html#where-do-you-put-your-code"><i class="fa fa-check"></i><b>7.2</b> Where do you put your code?</a></li>
<li class="chapter" data-level="7.3" data-path="organize.html"><a href="organize.html#your-commands-are-code-chunks-not-r-scripts"><i class="fa fa-check"></i><b>7.3</b> Your commands are code chunks, not R scripts</a></li>
<li class="chapter" data-level="7.4" data-path="organize.html"><a href="organize.html#workflows-as-r-packages"><i class="fa fa-check"></i><b>7.4</b> Workflows as R packages</a><ul>
<li class="chapter" data-level="7.4.1" data-path="organize.html"><a href="organize.html#advantages-of-putting-workflows-in-r-packages"><i class="fa fa-check"></i><b>7.4.1</b> Advantages of putting workflows in R packages</a></li>
<li class="chapter" data-level="7.4.2" data-path="organize.html"><a href="organize.html#the-problem"><i class="fa fa-check"></i><b>7.4.2</b> The problem</a></li>
<li class="chapter" data-level="7.4.3" data-path="organize.html"><a href="organize.html#the-solution"><i class="fa fa-check"></i><b>7.4.3</b> The solution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="vis.html"><a href="vis.html"><i class="fa fa-check"></i><b>8</b> Visualization with drake</a><ul>
<li class="chapter" data-level="8.0.1" data-path="vis.html"><a href="vis.html#vis_drake_graph"><i class="fa fa-check"></i><b>8.0.1</b> <code>vis_drake_graph()</code></a></li>
<li class="chapter" data-level="8.0.2" data-path="vis.html"><a href="vis.html#sankey_drake_graph"><i class="fa fa-check"></i><b>8.0.2</b> <code>sankey_drake_graph()</code></a></li>
<li class="chapter" data-level="8.0.3" data-path="vis.html"><a href="vis.html#drake_ggraph"><i class="fa fa-check"></i><b>8.0.3</b> <code>drake_ggraph()</code></a></li>
<li class="chapter" data-level="8.1" data-path="vis.html"><a href="vis.html#underlying-graph-data-node-and-edge-data-frames"><i class="fa fa-check"></i><b>8.1</b> Underlying graph data: node and edge data frames</a></li>
<li class="chapter" data-level="8.2" data-path="vis.html"><a href="vis.html#visualizing-target-status"><i class="fa fa-check"></i><b>8.2</b> Visualizing target status</a></li>
<li class="chapter" data-level="8.3" data-path="vis.html"><a href="vis.html#subgraphs"><i class="fa fa-check"></i><b>8.3</b> Subgraphs</a></li>
<li class="chapter" data-level="8.4" data-path="vis.html"><a href="vis.html#control-the-vis_drake_graph-legend."><i class="fa fa-check"></i><b>8.4</b> Control the <code>vis_drake_graph()</code> legend.</a></li>
<li class="chapter" data-level="8.5" data-path="vis.html"><a href="vis.html#clusters"><i class="fa fa-check"></i><b>8.5</b> Clusters</a></li>
<li class="chapter" data-level="8.6" data-path="vis.html"><a href="vis.html#output-files"><i class="fa fa-check"></i><b>8.6</b> Output files</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="debug.html"><a href="debug.html"><i class="fa fa-check"></i><b>9</b> Debugging and testing drake projects</a><ul>
<li class="chapter" data-level="9.1" data-path="debug.html"><a href="debug.html#dependencies"><i class="fa fa-check"></i><b>9.1</b> Dependencies</a><ul>
<li class="chapter" data-level="9.1.1" data-path="debug.html"><a href="debug.html#visualize-your-dependency-graph."><i class="fa fa-check"></i><b>9.1.1</b> Visualize your dependency graph.</a></li>
<li class="chapter" data-level="9.1.2" data-path="debug.html"><a href="debug.html#check-specific-dependency-information."><i class="fa fa-check"></i><b>9.1.2</b> Check specific dependency information.</a></li>
<li class="chapter" data-level="9.1.3" data-path="debug.html"><a href="debug.html#outdated-targets-and-missing-dependencies"><i class="fa fa-check"></i><b>9.1.3</b> Outdated targets and missing dependencies</a></li>
<li class="chapter" data-level="9.1.4" data-path="debug.html"><a href="debug.html#but-why-are-my-targets-out-of-date"><i class="fa fa-check"></i><b>9.1.4</b> But <em>why</em> are my targets out of date?</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="debug.html"><a href="debug.html#diagnose-failures."><i class="fa fa-check"></i><b>9.2</b> Diagnose failures.</a></li>
<li class="chapter" data-level="9.3" data-path="debug.html"><a href="debug.html#timeouts-and-retries"><i class="fa fa-check"></i><b>9.3</b> Timeouts and retries</a></li>
<li class="chapter" data-level="9.4" data-path="debug.html"><a href="debug.html#more-help"><i class="fa fa-check"></i><b>9.4</b> More help</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>10</b> High-performance computing</a><ul>
<li class="chapter" data-level="10.1" data-path="hpc.html"><a href="hpc.html#batch-mode-for-long-workflows"><i class="fa fa-check"></i><b>10.1</b> Batch mode for long workflows</a></li>
<li class="chapter" data-level="10.2" data-path="hpc.html"><a href="hpc.html#let-make-schedule-your-targets."><i class="fa fa-check"></i><b>10.2</b> Let <code>make()</code> schedule your targets.</a></li>
<li class="chapter" data-level="10.3" data-path="hpc.html"><a href="hpc.html#parallel-backends"><i class="fa fa-check"></i><b>10.3</b> Parallel backends</a></li>
<li class="chapter" data-level="10.4" data-path="hpc.html"><a href="hpc.html#the-clustermq-backend"><i class="fa fa-check"></i><b>10.4</b> The <code>clustermq</code> backend</a><ul>
<li class="chapter" data-level="10.4.1" data-path="hpc.html"><a href="hpc.html#persistent-workers"><i class="fa fa-check"></i><b>10.4.1</b> Persistent workers</a></li>
<li class="chapter" data-level="10.4.2" data-path="hpc.html"><a href="hpc.html#installation-1"><i class="fa fa-check"></i><b>10.4.2</b> Installation</a></li>
<li class="chapter" data-level="10.4.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine"><i class="fa fa-check"></i><b>10.4.3</b> On your local machine</a></li>
<li class="chapter" data-level="10.4.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster"><i class="fa fa-check"></i><b>10.4.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="hpc.html"><a href="hpc.html#the-future-backend"><i class="fa fa-check"></i><b>10.5</b> The <code>future</code> backend</a><ul>
<li class="chapter" data-level="10.5.1" data-path="hpc.html"><a href="hpc.html#transient-workers"><i class="fa fa-check"></i><b>10.5.1</b> Transient workers</a></li>
<li class="chapter" data-level="10.5.2" data-path="hpc.html"><a href="hpc.html#installation-2"><i class="fa fa-check"></i><b>10.5.2</b> Installation</a></li>
<li class="chapter" data-level="10.5.3" data-path="hpc.html"><a href="hpc.html#on-your-local-machine-1"><i class="fa fa-check"></i><b>10.5.3</b> On your local machine</a></li>
<li class="chapter" data-level="10.5.4" data-path="hpc.html"><a href="hpc.html#on-a-cluster-1"><i class="fa fa-check"></i><b>10.5.4</b> On a cluster</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="hpc.html"><a href="hpc.html#advanced-options"><i class="fa fa-check"></i><b>10.6</b> Advanced options</a><ul>
<li class="chapter" data-level="10.6.1" data-path="hpc.html"><a href="hpc.html#memory"><i class="fa fa-check"></i><b>10.6.1</b> Memory</a></li>
<li class="chapter" data-level="10.6.2" data-path="hpc.html"><a href="hpc.html#storage"><i class="fa fa-check"></i><b>10.6.2</b> Storage</a></li>
<li class="chapter" data-level="10.6.3" data-path="hpc.html"><a href="hpc.html#the-template-argument-for-persistent-workers"><i class="fa fa-check"></i><b>10.6.3</b> The <code>template</code> argument for persistent workers</a></li>
<li class="chapter" data-level="10.6.4" data-path="hpc.html"><a href="hpc.html#the-resources-column-for-transient-workers"><i class="fa fa-check"></i><b>10.6.4</b> The <code>resources</code> column for transient workers</a></li>
<li class="chapter" data-level="10.6.5" data-path="hpc.html"><a href="hpc.html#custom-job-schedulers"><i class="fa fa-check"></i><b>10.6.5</b> Custom job schedulers</a></li>
<li class="chapter" data-level="10.6.6" data-path="hpc.html"><a href="hpc.html#parallel-computing-within-targets"><i class="fa fa-check"></i><b>10.6.6</b> Parallel computing <em>within</em> targets</a></li>
<li class="chapter" data-level="10.6.7" data-path="hpc.html"><a href="hpc.html#hasty-mode"><i class="fa fa-check"></i><b>10.6.7</b> Hasty mode</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="triggers.html"><a href="triggers.html"><i class="fa fa-check"></i><b>11</b> Triggers: decision rules for building targets</a><ul>
<li class="chapter" data-level="11.1" data-path="triggers.html"><a href="triggers.html#what-are-triggers"><i class="fa fa-check"></i><b>11.1</b> What are triggers?</a></li>
<li class="chapter" data-level="11.2" data-path="triggers.html"><a href="triggers.html#customization"><i class="fa fa-check"></i><b>11.2</b> Customization</a></li>
<li class="chapter" data-level="11.3" data-path="triggers.html"><a href="triggers.html#alternative-trigger-modes"><i class="fa fa-check"></i><b>11.3</b> Alternative trigger modes</a></li>
<li class="chapter" data-level="11.4" data-path="triggers.html"><a href="triggers.html#consider-hasty-mode"><i class="fa fa-check"></i><b>11.4</b> Consider hasty mode</a></li>
<li class="chapter" data-level="11.5" data-path="triggers.html"><a href="triggers.html#a-more-practical-example"><i class="fa fa-check"></i><b>11.5</b> A more practical example</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="time.html"><a href="time.html"><i class="fa fa-check"></i><b>12</b> Time: logging, prediction, and strategy</a><ul>
<li class="chapter" data-level="12.1" data-path="time.html"><a href="time.html#predict-total-runtime"><i class="fa fa-check"></i><b>12.1</b> Predict total runtime</a></li>
<li class="chapter" data-level="12.2" data-path="time.html"><a href="time.html#strategize-your-high-performance-computing"><i class="fa fa-check"></i><b>12.2</b> Strategize your high-performance computing</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="store.html"><a href="store.html"><i class="fa fa-check"></i><b>13</b> Storage</a><ul>
<li class="chapter" data-level="13.1" data-path="store.html"><a href="store.html#cache-formats"><i class="fa fa-check"></i><b>13.1</b> Cache formats</a><ul>
<li class="chapter" data-level="13.1.1" data-path="store.html"><a href="store.html#rds-caches"><i class="fa fa-check"></i><b>13.1.1</b> RDS caches</a></li>
<li class="chapter" data-level="13.1.2" data-path="store.html"><a href="store.html#database-caches"><i class="fa fa-check"></i><b>13.1.2</b> Database caches</a></li>
<li class="chapter" data-level="13.1.3" data-path="store.html"><a href="store.html#environment-caches"><i class="fa fa-check"></i><b>13.1.3</b> Environment caches</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="store.html"><a href="store.html#hash-algorithms"><i class="fa fa-check"></i><b>13.2</b> Hash algorithms</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="faq.html"><a href="faq.html"><i class="fa fa-check"></i><b>A</b> Frequently-asked questions</a></li>
<li class="chapter" data-level="B" data-path="caution.html"><a href="caution.html"><i class="fa fa-check"></i><b>B</b> Cautionary notes</a><ul>
<li class="chapter" data-level="B.1" data-path="caution.html"><a href="caution.html#workflow-plans"><i class="fa fa-check"></i><b>B.1</b> Workflow plans</a><ul>
<li class="chapter" data-level="B.1.1" data-path="caution.html"><a href="caution.html#externalizing-commands-in-r-script-files"><i class="fa fa-check"></i><b>B.1.1</b> Externalizing commands in R script files</a></li>
<li class="chapter" data-level="B.1.2" data-path="caution.html"><a href="caution.html#commands-are-not-perfectly-flexible."><i class="fa fa-check"></i><b>B.1.2</b> Commands are NOT perfectly flexible.</a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="caution.html"><a href="caution.html#execution"><i class="fa fa-check"></i><b>B.2</b> Execution</a><ul>
<li class="chapter" data-level="B.2.1" data-path="caution.html"><a href="caution.html#install-drake-properly."><i class="fa fa-check"></i><b>B.2.1</b> Install <code>drake</code> properly.</a></li>
<li class="chapter" data-level="B.2.2" data-path="caution.html"><a href="caution.html#install-all-your-packages."><i class="fa fa-check"></i><b>B.2.2</b> Install all your packages.</a></li>
<li class="chapter" data-level="B.2.3" data-path="caution.html"><a href="caution.html#a-note-on-tidy-evaluation"><i class="fa fa-check"></i><b>B.2.3</b> A note on tidy evaluation</a></li>
<li class="chapter" data-level="B.2.4" data-path="caution.html"><a href="caution.html#find-and-diagnose-your-errors."><i class="fa fa-check"></i><b>B.2.4</b> Find and diagnose your errors.</a></li>
<li class="chapter" data-level="B.2.5" data-path="caution.html"><a href="caution.html#refresh-the-drake_config-list-early-and-often."><i class="fa fa-check"></i><b>B.2.5</b> Refresh the <code>drake_config()</code> list early and often.</a></li>
<li class="chapter" data-level="B.2.6" data-path="caution.html"><a href="caution.html#workflows-as-r-packages."><i class="fa fa-check"></i><b>B.2.6</b> Workflows as R packages.</a></li>
<li class="chapter" data-level="B.2.7" data-path="caution.html"><a href="caution.html#the-lazy_load-flag-does-not-work-with-parlapply-parallelism."><i class="fa fa-check"></i><b>B.2.7</b> The <code>lazy_load</code> flag does not work with <code>&quot;parLapply&quot;</code> parallelism.</a></li>
<li class="chapter" data-level="B.2.8" data-path="caution.html"><a href="caution.html#timeouts-may-be-unreliable."><i class="fa fa-check"></i><b>B.2.8</b> Timeouts may be unreliable.</a></li>
</ul></li>
<li class="chapter" data-level="B.3" data-path="caution.html"><a href="caution.html#dependencies-1"><i class="fa fa-check"></i><b>B.3</b> Dependencies</a><ul>
<li class="chapter" data-level="B.3.1" data-path="caution.html"><a href="caution.html#objects-that-contain-functions-may-rebuild-too-often"><i class="fa fa-check"></i><b>B.3.1</b> Objects that contain functions may rebuild too often</a></li>
<li class="chapter" data-level="B.3.2" data-path="caution.html"><a href="caution.html#dependencies-are-not-tracked-in-some-edge-cases."><i class="fa fa-check"></i><b>B.3.2</b> Dependencies are not tracked in some edge cases.</a></li>
<li class="chapter" data-level="B.3.3" data-path="caution.html"><a href="caution.html#dependencies-of-knitr-reports"><i class="fa fa-check"></i><b>B.3.3</b> Dependencies of <code>knitr</code> reports</a></li>
<li class="chapter" data-level="B.3.4" data-path="caution.html"><a href="caution.html#s3-and-generic-methods"><i class="fa fa-check"></i><b>B.3.4</b> S3 and generic methods</a></li>
<li class="chapter" data-level="B.3.5" data-path="caution.html"><a href="caution.html#file-outputs-in-imported-functions."><i class="fa fa-check"></i><b>B.3.5</b> File outputs in imported functions.</a></li>
<li class="chapter" data-level="B.3.6" data-path="caution.html"><a href="caution.html#functions-produced-by-vectorize"><i class="fa fa-check"></i><b>B.3.6</b> Functions produced by <code>Vectorize()</code></a></li>
<li class="chapter" data-level="B.3.7" data-path="caution.html"><a href="caution.html#compiled-code-is-not-reproducibly-tracked."><i class="fa fa-check"></i><b>B.3.7</b> Compiled code is not reproducibly tracked.</a></li>
<li class="chapter" data-level="B.3.8" data-path="caution.html"><a href="caution.html#directories-folders-are-not-reproducibly-tracked."><i class="fa fa-check"></i><b>B.3.8</b> Directories (folders) are not reproducibly tracked.</a></li>
<li class="chapter" data-level="B.3.9" data-path="caution.html"><a href="caution.html#packages-are-not-tracked-as-dependencies."><i class="fa fa-check"></i><b>B.3.9</b> Packages are not tracked as dependencies.</a></li>
</ul></li>
<li class="chapter" data-level="B.4" data-path="caution.html"><a href="caution.html#high-performance-computing"><i class="fa fa-check"></i><b>B.4</b> High-performance computing</a><ul>
<li class="chapter" data-level="B.4.1" data-path="caution.html"><a href="caution.html#calling-mclapply-within-targets"><i class="fa fa-check"></i><b>B.4.1</b> Calling <code>mclapply()</code> <em>within</em> targets</a></li>
<li class="chapter" data-level="B.4.2" data-path="caution.html"><a href="caution.html#zombie-processes"><i class="fa fa-check"></i><b>B.4.2</b> Zombie processes</a></li>
</ul></li>
<li class="chapter" data-level="B.5" data-path="caution.html"><a href="caution.html#storage-1"><i class="fa fa-check"></i><b>B.5</b> Storage</a><ul>
<li class="chapter" data-level="B.5.1" data-path="caution.html"><a href="caution.html#projects-hosted-on-dropbox-and-similar-platforms"><i class="fa fa-check"></i><b>B.5.1</b> Projects hosted on Dropbox and similar platforms</a></li>
<li class="chapter" data-level="B.5.2" data-path="caution.html"><a href="caution.html#cache-customization-is-limited"><i class="fa fa-check"></i><b>B.5.2</b> Cache customization is limited</a></li>
<li class="chapter" data-level="B.5.3" data-path="caution.html"><a href="caution.html#runtime-predictions"><i class="fa fa-check"></i><b>B.5.3</b> Runtime predictions</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The drake R Package User Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="plans" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> <code>drake</code> plans</h1>
<div id="what-is-a-drake-plan" class="section level2">
<h2><span class="header-section-number">6.1</span> What is a <code>drake</code> plan?</h2>
<p>A<code>drake</code> plan is a data frame with columns named <code>target</code> and <code>command</code>. Each target is an R object, and each command is an <a href="http://adv-r.had.co.nz/Expressions.html">expression</a> to produce it.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> The <code>drake_plan()</code> function is the best way to set up plans.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> Recall the plan from our <a href="main.html#main">previous example</a>:</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">raw_data =</span> readxl<span class="op">::</span><span class="kw">read_excel</span>(<span class="kw">file_in</span>(<span class="st">&quot;raw_data.xlsx&quot;</span>)),
  <span class="dt">data =</span> raw_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Species =</span> forcats<span class="op">::</span><span class="kw">fct_inorder</span>(Species)),
  <span class="dt">hist =</span> <span class="kw">create_plot</span>(data),
  <span class="dt">fit =</span> <span class="kw">lm</span>(Sepal.Width <span class="op">~</span><span class="st"> </span>Petal.Width <span class="op">+</span><span class="st"> </span>Species, data),
  <span class="dt">report =</span> rmarkdown<span class="op">::</span><span class="kw">render</span>(
    <span class="kw">knitr_in</span>(<span class="st">&quot;report.Rmd&quot;</span>),
    <span class="dt">output_file =</span> <span class="kw">file_out</span>(<span class="st">&quot;report.html&quot;</span>),
    <span class="dt">quiet =</span> <span class="ot">TRUE</span>
  )
)
plan
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 4 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
<p><code>drake_plan()</code> does not run the workflow, it only creates the plan. To build the actual targets, we need to run <code>make()</code>. Creating the plan is like writing an R script, and running <code>make(your_plan)</code> is like calling <a href="https://www.rdocumentation.org/packages/base/versions/3.5.2/topics/source"><code>source(&quot;your_script.R&quot;)</code></a>.</p>
</div>
<div id="plans-are-similar-to-r-scripts." class="section level2">
<h2><span class="header-section-number">6.2</span> Plans are similar to R scripts.</h2>
<p>Your <code>drake</code> plan is like a top-level R script that runs everything from end to end. In fact, you can convert back and forth between plans and scripts using functions <a href="https://ropensci.github.io/drake/reference/plan_to_code.html"><code>plan_to_code()</code></a> and <a href="https://ropensci.github.io/drake/reference/code_to_plan.html"><code>code_to_plan()</code></a> (with some <a href="https://ropensci.github.io/drake/reference/code_to_plan.html#details">caveats</a>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plan_to_code</span>(plan, <span class="st">&quot;new_script.R&quot;</span>)
<span class="co">#&gt; Loading required namespace: styler</span>
<span class="kw">cat</span>(<span class="kw">readLines</span>(<span class="st">&quot;new_script.R&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
<span class="co">#&gt; raw_data &lt;- readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))</span>
<span class="co">#&gt; data &lt;- raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))</span>
<span class="co">#&gt; fit &lt;- lm(Sepal.Width ~ Petal.Width + Species, data)</span>
<span class="co">#&gt; hist &lt;- create_plot(data)</span>
<span class="co">#&gt; report &lt;- rmarkdown::render(knitr_in(&quot;report.Rmd&quot;),</span>
<span class="co">#&gt;   output_file = file_out(&quot;report.html&quot;),</span>
<span class="co">#&gt;   quiet = TRUE</span>
<span class="co">#&gt; )</span>

<span class="kw">code_to_plan</span>(<span class="st">&quot;new_script.R&quot;</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 4 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
<p>And <a href="https://ropensci.github.io/drake/reference/plan_to_notebook.html"><code>plan_to_notebook()</code></a> turns plans into <a href="https://bookdown.org/yihui/rmarkdown/notebook.html">R notebooks</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plan_to_notebook</span>(plan, <span class="st">&quot;new_notebook.Rmd&quot;</span>)
<span class="kw">cat</span>(<span class="kw">readLines</span>(<span class="st">&quot;new_notebook.Rmd&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
<span class="co">#&gt; ---</span>
<span class="co">#&gt; title: &quot;My Notebook&quot;</span>
<span class="co">#&gt; output: html_notebook</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ```{r my_code}</span>
<span class="co">#&gt; raw_data &lt;- readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))</span>
<span class="co">#&gt; data &lt;- raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))</span>
<span class="co">#&gt; fit &lt;- lm(Sepal.Width ~ Petal.Width + Species, data)</span>
<span class="co">#&gt; hist &lt;- create_plot(data)</span>
<span class="co">#&gt; report &lt;- rmarkdown::render(knitr_in(&quot;report.Rmd&quot;),</span>
<span class="co">#&gt;   output_file = file_out(&quot;report.html&quot;),</span>
<span class="co">#&gt;   quiet = TRUE</span>
<span class="co">#&gt; )</span>
<span class="co">#&gt; ```</span>

<span class="kw">code_to_plan</span>(<span class="st">&quot;new_notebook.Rmd&quot;</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                                          </span>
<span class="co">#&gt; 1 raw_data readxl::read_excel(file_in(&quot;raw_data.xlsx&quot;))                   …</span>
<span class="co">#&gt; 2 data     raw_data %&gt;% mutate(Species = forcats::fct_inorder(Species))   …</span>
<span class="co">#&gt; 3 fit      lm(Sepal.Width ~ Petal.Width + Species, data)                  …</span>
<span class="co">#&gt; 4 hist     create_plot(data)                                              …</span>
<span class="co">#&gt; 5 report   rmarkdown::render(knitr_in(&quot;report.Rmd&quot;), output_file = file_ou…</span></code></pre>
</div>
<div id="so-why-do-we-use-plans" class="section level2">
<h2><span class="header-section-number">6.3</span> So why do we use plans?</h2>
<p>If you have ever waited more than 10 minutes for an R script to finish, then you know the frustration of having to rerun the whole thing every time you make a change. Plans make life easier.</p>
<div id="plans-chop-up-the-work-into-pieces." class="section level3">
<h3><span class="header-section-number">6.3.1</span> Plans chop up the work into pieces.</h3>
<p>Some targets may need an update while others may not. In our <a href="main.html#main">first example</a>, <code>make()</code> was smart enough to skip the data cleaning step and just rebuild the plot and report. <code>drake</code> and its plans compartmentalize the work, and this can save you from wasted effort in the long run.</p>
</div>
<div id="drake-uses-plans-to-schedule-you-work." class="section level3">
<h3><span class="header-section-number">6.3.2</span> <code>drake</code> uses plans to schedule you work.</h3>
<p><code>make()</code> automatically learns the build order of your targets and <a href="hpc.html#hpc">how to run them in parallel</a>. The underlying magic is <a href="http://adv-r.had.co.nz/Expressions.html#ast-funs"><em>static code analysis</em></a>, which automatically detects the dependencies of each target without having to run its command.</p>
<pre class="sourceCode r"><code class="sourceCode r">create_plot &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="kw">ggplot</span>(data, <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">&quot;Petal.Width&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;Species&quot;</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">20</span>)
}

<span class="kw">deps_code</span>(create_plot)
<span class="co">#&gt; $globals</span>
<span class="co">#&gt; [1] &quot;geom_histogram&quot; &quot;ggplot&quot;         &quot;aes_string&quot;</span>

<span class="kw">deps_code</span>(<span class="kw">quote</span>(<span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)))
<span class="co">#&gt; $globals</span>
<span class="co">#&gt; [1] &quot;create_plot&quot;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $namespaced</span>
<span class="co">#&gt; [1] &quot;datasets::iris&quot;</span></code></pre>
<p>Because of the dependency relationships, row order does not matter once the plan is fully defined. The following plan declares <code>file</code> before <code>plot</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">small_plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">file =</span> <span class="kw">ggsave</span>(<span class="kw">file_out</span>(<span class="st">&quot;plot.png&quot;</span>), plot, <span class="dt">width =</span> <span class="dv">7</span>, <span class="dt">height =</span> <span class="dv">5</span>),
  <span class="dt">plot =</span> <span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)
)</code></pre>
<p>But <code>file</code> actually depends on <code>plot</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">small_config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(small_plan)
<span class="kw">vis_drake_graph</span>(small_config)</code></pre>
<div id="htmlwidget-25db82eb3b31272a5d15" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-25db82eb3b31272a5d15">{"x":{"nodes":{"id":["create_plot","file","n-MRQXIYLTMV2HGOR2NFZGS4Y","p-OBWG65BOOBXGO","plot"],"imported":[true,false,true,false,false],"label":["create_plot","file","datasets::iris","file plot.png","plot"],"command":[null,"ggsave(file_out(\"plot.png\"), plot, width = 7, height = 5)",null,"ggsave(file_out(\"plot.png\"), plot, width = 7, height = 5)","create_plot(datasets::iris)"],"status":["imported","outdated","imported","outdated","outdated"],"type":["function","object","object","object","object"],"font.size":[20,20,20,20,20],"color":["#1874CD","#000000","#1874CD","#000000","#000000"],"shape":["triangle","dot","dot","square","dot"],"level":[1,3,1,4,2],"title":["function&nbsp;(data)&nbsp;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;ggplot(data,&nbsp;aes_string...","ggsave(file_out(\"plot.png\"),&nbsp;plot,&nbsp;width&nbsp;=&nbsp;7,&nbsp;...","n-MRQXIYLTMV2HGOR2NFZGS4Y","ggsave(file_out(\"plot.png\"),&nbsp;plot,&nbsp;width&nbsp;=&nbsp;7,&nbsp;...","create_plot(datasets::iris)"],"x":[-1,0,1,0,0],"y":[-1,0.333333333333333,-1,1,-0.333333333333333]},"edges":{"from":["create_plot","plot","file","n-MRQXIYLTMV2HGOR2NFZGS4Y"],"to":["plot","file","p-OBWG65BOOBXGO","plot"],"arrows":["to","to","to","to"],"smooth":[true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","File"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","square"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,5,7,8,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>So <code>make()</code> builds <code>plot</code> first.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">make</span>(small_plan)
<span class="co">#&gt; target plot</span>
<span class="co">#&gt; target file</span></code></pre>
</div>
</div>
<div id="special-custom-columns-in-your-plan." class="section level2">
<h2><span class="header-section-number">6.4</span> Special custom columns in your plan.</h2>
<p>You can add other columns besides the required <code>target</code> and <code>command</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cbind</span>(small_plan, <span class="dt">cpu =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="co">#&gt;   target                                                   command cpu</span>
<span class="co">#&gt; 1   file ggsave(file_out(&quot;plot.png&quot;), plot, width = 7, height = 5)   1</span>
<span class="co">#&gt; 2   plot                               create_plot(datasets::iris)   2</span></code></pre>
<p>Within <code>drake_plan()</code>, <code>target()</code> lets you create any custom column except <code>target</code>, <code>command</code>, and <code>transform</code>, the last of which <a href="https://ropenscilabs.github.io/drake-manual/plans.html#create-large-plans-the-easy-way">has a special meaning</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">file =</span> <span class="kw">target</span>(
    <span class="kw">ggsave</span>(<span class="kw">file_out</span>(<span class="st">&quot;plot.png&quot;</span>), plot),
    <span class="dt">elapsed =</span> <span class="dv">10</span>
  ),
  <span class="kw">create_plot</span>(datasets<span class="op">::</span>iris)
)
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   target         command                            elapsed</span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                               &lt;dbl&gt;</span>
<span class="co">#&gt; 1 file           ggsave(file_out(&quot;plot.png&quot;), plot)      10</span>
<span class="co">#&gt; 2 drake_target_1 create_plot(datasets::iris)             NA</span></code></pre>
<p>The following columns have special meanings for <code>make()</code>.</p>
<ul>
<li><code>elapsed</code> and <code>cpu</code>: number of seconds to wait for the target to build before timing out (<code>elapsed</code> for elapsed time and <code>cpu</code> for CPU time).</li>
<li><code>priority</code>: for <a href="hpc.html#hpc">parallel computing</a>, optionally rank the targets according to priority in the scheduler.</li>
<li><code>resources</code>: target-specific lists of resources for a computing cluster. See the advanced options in the <a href="hpc.html#hpc">parallel computing</a> chapter for details.</li>
<li><code>retries</code>: number of times to retry building a target in the event of an error.</li>
<li><code>trigger</code>: rule to decide whether a target needs to run. See the <a href="triggers.html#triggers">trigger chapter</a> to learn more.</li>
</ul>
</div>
<div id="large-plans" class="section level2">
<h2><span class="header-section-number">6.5</span> Large plans</h2>
<p><code>drake</code> version 7.0.0 will introduce new experimental syntax to make it easier to create plans. To try it out before the next <a href="http://cran.r-project.org">CRAN</a> release, install the <a href="https://github.com/ropensci/drake">current development version</a> from GitHub.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)
<span class="kw">library</span>(remotes)
<span class="kw">install_github</span>(<span class="st">&quot;ropensci/drake&quot;</span>)</code></pre>
<div id="how-to-create-large-plans" class="section level3">
<h3><span class="header-section-number">6.5.1</span> How to create large plans</h3>
<p>Ordinarily, <code>drake_plan()</code> requires you to write out all the targets one-by-one. This is a literal pain.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis_1_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_2_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_5_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_10_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">10</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_100_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">100</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_1000_1 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1000</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">analysis_1_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_2_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_5_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_10_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">10</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_100_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">100</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="dt">analysis_1000_2 =</span> <span class="kw">fit_model_x</span>(data, <span class="dt">mean =</span> <span class="dv">1000</span>, <span class="dt">sd =</span> <span class="dv">2</span>),
  <span class="co"># UUUGGGHH my wrists are cramping! :( ...</span>
)</code></pre>
<p>Transformations reduce typing, especially when combined with tidy evaluation (<code>!!</code>).</p>
<pre class="sourceCode r"><code class="sourceCode r">lots_of_sds &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="dv">1</span><span class="op">:</span><span class="fl">1e3</span>)

<span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">fun</span>(data, <span class="dt">mean =</span> mean_val, <span class="dt">sd =</span> sd_val),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">mean_val =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>), <span class="dt">sd_val =</span> <span class="op">!!</span>lots_of_sds)
  )
)
<span class="co">#&gt; # A tibble: 5,001 x 2</span>
<span class="co">#&gt;    target          command                       </span>
<span class="co">#&gt;    &lt;chr&gt;           &lt;expr&gt;                        </span>
<span class="co">#&gt;  1 data            get_data()                    </span>
<span class="co">#&gt;  2 analysis_2_1    fun(data, mean = 2, sd = 1)   </span>
<span class="co">#&gt;  3 analysis_5_1    fun(data, mean = 5, sd = 1)   </span>
<span class="co">#&gt;  4 analysis_10_1   fun(data, mean = 10, sd = 1)  </span>
<span class="co">#&gt;  5 analysis_100_1  fun(data, mean = 100, sd = 1) </span>
<span class="co">#&gt;  6 analysis_1000_1 fun(data, mean = 1000, sd = 1)</span>
<span class="co">#&gt;  7 analysis_2_2    fun(data, mean = 2, sd = 2)   </span>
<span class="co">#&gt;  8 analysis_5_2    fun(data, mean = 5, sd = 2)   </span>
<span class="co">#&gt;  9 analysis_10_2   fun(data, mean = 10, sd = 2)  </span>
<span class="co">#&gt; 10 analysis_100_2  fun(data, mean = 100, sd = 2) </span>
<span class="co">#&gt; # … with 4,991 more rows</span></code></pre>
<p>Behind the scenes during a transformation, <code>drake_plan()</code> creates new columns to track what is happening. You can see them with <code>trace = TRUE</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">get_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>(
    <span class="kw">analyze</span>(data, mean, sd),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="dt">sd =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   target       command             mean  sd    analysis    </span>
<span class="co">#&gt;   &lt;chr&gt;        &lt;expr&gt;              &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1 data         get_data()          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;        </span>
<span class="co">#&gt; 2 analysis_3_1 analyze(data, 3, 1) 3     1     analysis_3_1</span>
<span class="co">#&gt; 3 analysis_4_2 analyze(data, 4, 2) 4     2     analysis_4_2</span></code></pre>
<p>Because of those columns, you can chain transformations together in complex pipelines.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan1 &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">small =</span> <span class="kw">get_small_data</span>(),
  <span class="dt">large =</span> <span class="kw">get_large_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>( <span class="co"># Analyze each dataset once with a different mean.</span>
    <span class="kw">analyze</span>(data, mean),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">data =</span> <span class="kw">c</span>(small, large), <span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="co"># Calculate 2 different performance metrics on every model fit.</span>
  <span class="dt">metric =</span> <span class="kw">target</span>(
    <span class="kw">metric_fun</span>(analysis),
    <span class="co"># mse = mean squared error, mae = mean absolute error.</span>
    <span class="co"># Assume these are functions you write.</span>
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">metric_fun =</span> <span class="kw">c</span>(mse, mae), analysis)
  ),
  <span class="co"># Summarize the performance metrics for each dataset.</span>
  <span class="dt">summ_data =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> data)
  ),
  <span class="co"># Same, but for each metric type.</span>
  <span class="dt">summ_metric =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> metric_fun)
  )
)

plan1
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target                command                                           </span>
<span class="co">#&gt;    &lt;chr&gt;                 &lt;expr&gt;                                            </span>
<span class="co">#&gt;  1 small                 get_small_data()                                 …</span>
<span class="co">#&gt;  2 large                 get_large_data()                                 …</span>
<span class="co">#&gt;  3 analysis_small_1      analyze(small, 1)                                …</span>
<span class="co">#&gt;  4 analysis_large_2      analyze(large, 2)                                …</span>
<span class="co">#&gt;  5 metric_mse_analysis_… mse(analysis_large_2)                            …</span>
<span class="co">#&gt;  6 metric_mae_analysis_… mae(analysis_large_2)                            …</span>
<span class="co">#&gt;  7 metric_mse_analysis_… mse(analysis_small_1)                            …</span>
<span class="co">#&gt;  8 metric_mae_analysis_… mae(analysis_small_1)                            …</span>
<span class="co">#&gt;  9 summ_data_large       summary(list(metric_mse_analysis_large_2, metric_…</span>
<span class="co">#&gt; 10 summ_data_small       summary(list(metric_mse_analysis_small_1, metric_…</span>
<span class="co">#&gt; 11 summ_metric_mae       summary(list(metric_mae_analysis_large_2, metric_…</span>
<span class="co">#&gt; 12 summ_metric_mse       summary(list(metric_mse_analysis_large_2, metric_…</span>

config1 &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan1)
<span class="kw">vis_drake_graph</span>(config1)</code></pre>
<div id="htmlwidget-dda5858bd620d236e22c" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-dda5858bd620d236e22c">{"x":{"nodes":{"id":["analysis_large_2","analysis_small_1","large","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_small_1","small","summ_data_large","summ_data_small","summ_metric_mae","summ_metric_mse"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["analysis_large_2","analysis_small_1","large","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_small_1","small","summ_data_large","summ_data_small","summ_metric_mae","summ_metric_mse"],"command":["analyze(large, 2)","analyze(small, 1)","get_large_data()","mae(analysis_large_2)","mae(analysis_small_1)","mse(analysis_large_2)","mse(analysis_small_1)","get_small_data()","summary(list(metric_mse_analysis_large_2, metric_mae_analysis_large_2))","summary(list(metric_mse_analysis_small_1, metric_mae_analysis_small_1))","summary(list(metric_mae_analysis_large_2, metric_mae_analysis_small_1))","summary(list(metric_mse_analysis_large_2, metric_mse_analysis_small_1))"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[2,2,1,3,3,3,3,1,4,4,4,4],"title":["analyze(large,&nbsp;2)","analyze(small,&nbsp;1)","get_large_data()","mae(analysis_large_2)","mae(analysis_small_1)","mse(analysis_large_2)","mse(analysis_small_1)","get_small_data()","summary(list(metric_mse_analysis_large_2,&nbsp;metr...","summary(list(metric_mse_analysis_small_1,&nbsp;metr...","summary(list(metric_mae_analysis_large_2,&nbsp;metr...","summary(list(metric_mse_analysis_large_2,&nbsp;metr..."],"x":[-0.75,0.75,-0.75,-1,0.25,-0.25,1,0.75,-1,1,-0.25,0.25],"y":[-0.333333333333333,-0.333333333333333,-1,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,-1,1,1,1,1]},"edges":{"from":["small","large","analysis_large_2","analysis_large_2","analysis_small_1","analysis_small_1","metric_mae_analysis_large_2","metric_mae_analysis_large_2","metric_mse_analysis_large_2","metric_mse_analysis_large_2","metric_mae_analysis_small_1","metric_mae_analysis_small_1","metric_mse_analysis_small_1","metric_mse_analysis_small_1"],"to":["analysis_small_1","analysis_large_2","metric_mae_analysis_large_2","metric_mse_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","summ_data_large","summ_metric_mae","summ_data_large","summ_metric_mse","summ_data_small","summ_metric_mae","summ_data_small","summ_metric_mse"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>And you can write the transformations in any order. The following plan is equivalent to <code>plan1</code> despite the rearranged rows.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan2 &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="co"># Calculate 2 different performance metrics on every model fit.</span>
  <span class="dt">summ_metric =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> metric_fun)
  ),
  <span class="dt">metric =</span> <span class="kw">target</span>(
    <span class="kw">metric_fun</span>(analysis),
    <span class="co"># mse = mean squared error, mae = mean absolute error.</span>
    <span class="co"># Assume these are functions you write.</span>
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">metric_fun =</span> <span class="kw">c</span>(mse, mae), analysis)
  ),
  <span class="dt">small =</span> <span class="kw">get_small_data</span>(),
  <span class="dt">analysis =</span> <span class="kw">target</span>( <span class="co"># Analyze each dataset once with a different mean.</span>
    <span class="kw">analyze</span>(data, mean),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">data =</span> <span class="kw">c</span>(small, large), <span class="dt">mean =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
  ),
  <span class="co"># Summarize the performance metrics for each dataset.</span>
  <span class="dt">summ_data =</span> <span class="kw">target</span>(
    <span class="kw">summary</span>(metric),
    <span class="dt">transform =</span> <span class="kw">combine</span>(metric, <span class="dt">.by =</span> data)
  ),
  <span class="dt">large =</span> <span class="kw">get_large_data</span>()
  <span class="co"># Same, but for each metric type.</span>
)

plan2
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target                command                                           </span>
<span class="co">#&gt;    &lt;chr&gt;                 &lt;expr&gt;                                            </span>
<span class="co">#&gt;  1 summ_metric_mae       summary(list(metric_mae_analysis_large_2, metric_…</span>
<span class="co">#&gt;  2 summ_metric_mse       summary(list(metric_mse_analysis_large_2, metric_…</span>
<span class="co">#&gt;  3 metric_mse_analysis_… mse(analysis_large_2)                            …</span>
<span class="co">#&gt;  4 metric_mae_analysis_… mae(analysis_large_2)                            …</span>
<span class="co">#&gt;  5 metric_mse_analysis_… mse(analysis_small_1)                            …</span>
<span class="co">#&gt;  6 metric_mae_analysis_… mae(analysis_small_1)                            …</span>
<span class="co">#&gt;  7 small                 get_small_data()                                 …</span>
<span class="co">#&gt;  8 analysis_small_1      analyze(small, 1)                                …</span>
<span class="co">#&gt;  9 analysis_large_2      analyze(large, 2)                                …</span>
<span class="co">#&gt; 10 summ_data_large       summary(list(metric_mse_analysis_large_2, metric_…</span>
<span class="co">#&gt; 11 summ_data_small       summary(list(metric_mse_analysis_small_1, metric_…</span>
<span class="co">#&gt; 12 large                 get_large_data()                                 …</span>

config2 &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan2)
<span class="kw">vis_drake_graph</span>(config2)</code></pre>
<div id="htmlwidget-e9f90e3194077d960e00" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9f90e3194077d960e00">{"x":{"nodes":{"id":["analysis_large_2","analysis_small_1","large","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_small_1","small","summ_data_large","summ_data_small","summ_metric_mae","summ_metric_mse"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["analysis_large_2","analysis_small_1","large","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_small_1","small","summ_data_large","summ_data_small","summ_metric_mae","summ_metric_mse"],"command":["analyze(large, 2)","analyze(small, 1)","get_large_data()","mae(analysis_large_2)","mae(analysis_small_1)","mse(analysis_large_2)","mse(analysis_small_1)","get_small_data()","summary(list(metric_mse_analysis_large_2, metric_mae_analysis_large_2))","summary(list(metric_mse_analysis_small_1, metric_mae_analysis_small_1))","summary(list(metric_mae_analysis_large_2, metric_mae_analysis_small_1))","summary(list(metric_mse_analysis_large_2, metric_mse_analysis_small_1))"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[2,2,1,3,3,3,3,1,4,4,4,4],"title":["analyze(large,&nbsp;2)","analyze(small,&nbsp;1)","get_large_data()","mae(analysis_large_2)","mae(analysis_small_1)","mse(analysis_large_2)","mse(analysis_small_1)","get_small_data()","summary(list(metric_mse_analysis_large_2,&nbsp;metr...","summary(list(metric_mse_analysis_small_1,&nbsp;metr...","summary(list(metric_mae_analysis_large_2,&nbsp;metr...","summary(list(metric_mse_analysis_large_2,&nbsp;metr..."],"x":[-0.75,0.75,-0.75,-1,0.25,-0.25,1,0.75,-1,1,-0.25,0.25],"y":[-0.333333333333333,-0.333333333333333,-1,0.333333333333333,0.333333333333333,0.333333333333333,0.333333333333333,-1,1,1,1,1]},"edges":{"from":["metric_mae_analysis_large_2","metric_mae_analysis_large_2","metric_mae_analysis_small_1","metric_mae_analysis_small_1","metric_mse_analysis_large_2","metric_mse_analysis_large_2","metric_mse_analysis_small_1","metric_mse_analysis_small_1","analysis_large_2","analysis_large_2","analysis_small_1","analysis_small_1","small","large"],"to":["summ_metric_mae","summ_data_large","summ_metric_mae","summ_data_small","summ_metric_mse","summ_data_large","summ_metric_mse","summ_data_small","metric_mae_analysis_large_2","metric_mse_analysis_large_2","metric_mae_analysis_small_1","metric_mse_analysis_small_1","analysis_small_1","analysis_large_2"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="the-types-of-transformations" class="section level3">
<h3><span class="header-section-number">6.5.2</span> The types of transformations</h3>
<p><code>drake</code> supports three types of transformations: <code>map()</code>, <code>cross()</code>, and <code>combine()</code>. These are not actual functions, but you can treat them as functions when you use them in <code>drake_plan()</code>. Each transformation takes after a function from the <a href="https://www.tidyverse.org/">Tidyverse</a>.</p>
<table>
<thead>
<tr class="header">
<th><code>drake</code></th>
<th>Tidyverse analogue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>map()</code></td>
<td><code>pmap()</code> from <code>purrr</code></td>
</tr>
<tr class="even">
<td><code>cross()</code></td>
<td><code>crossing()</code> from <code>tidyr</code></td>
</tr>
<tr class="odd">
<td><code>combine()</code></td>
<td><code>summarize()</code> from <code>dplyr</code></td>
</tr>
</tbody>
</table>
<div id="map" class="section level4">
<h4><span class="header-section-number">6.5.2.1</span> <code>map()</code></h4>
<p><code>map()</code> creates a new target for each row in a grid. The grid comes from column-binding the arguments together, which means the lengths need to be conformable just as with <code>data.frame()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(nrow, ncol),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">nrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))
  )
)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_1_4  simulate_data(1, 4)</span>
<span class="co">#&gt; 2 x_2_5  simulate_data(2, 5)</span>
<span class="co">#&gt; 3 x_3_6  simulate_data(3, 6)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(nrow, ncol),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">nrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="dv">4</span>)
  )
)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_1_4  simulate_data(1, 4)</span>
<span class="co">#&gt; 2 x_2_4  simulate_data(2, 4)</span>
<span class="co">#&gt; 3 x_3_4  simulate_data(3, 4)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(nrow, ncol),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">nrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))
  )
)
<span class="co">#&gt; Error: Failed to make a grid of grouping variables for map().</span>
<span class="co">#&gt; Grouping variables in map() must have suitable lengths for coercion to a data frame.</span>
<span class="co">#&gt; Possibly uneven groupings detected in map(nrow = c(1, 2, 3), ncol = c(4, 5)):</span>
<span class="co">#&gt;   c(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;)</span>
<span class="co">#&gt;   c(&quot;4&quot;, &quot;5&quot;)</span></code></pre>
</div>
<div id="cross" class="section level4">
<h4><span class="header-section-number">6.5.2.2</span> <code>cross()</code></h4>
<p><code>cross()</code> creates a new target for each combination of argument values.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    <span class="kw">simulate_data</span>(nrow, ncol),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">nrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">ncol =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))
  )
)
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   target command            </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;             </span>
<span class="co">#&gt; 1 x_1_4  simulate_data(1, 4)</span>
<span class="co">#&gt; 2 x_2_4  simulate_data(2, 4)</span>
<span class="co">#&gt; 3 x_3_4  simulate_data(3, 4)</span>
<span class="co">#&gt; 4 x_1_5  simulate_data(1, 5)</span>
<span class="co">#&gt; 5 x_2_5  simulate_data(2, 5)</span>
<span class="co">#&gt; 6 x_3_5  simulate_data(3, 5)</span></code></pre>
</div>
<div id="combine" class="section level4">
<h4><span class="header-section-number">6.5.2.3</span> <code>combine()</code></h4>
<p>In <code>combine()</code>, you can replace symbols in a command with lists of other targets. You must tell <code>combine()</code> which symbols you wish to replace.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">larger =</span> <span class="kw">target</span>(
    <span class="co"># Turn the list of data frames into a monolithic data frame.</span>
    <span class="kw">do.call</span>(rbind, data),
    <span class="co"># Replace the symbol `data` with a list of all the targets</span>
    <span class="co"># declared by map() above.</span>
    <span class="dt">transform =</span> <span class="kw">combine</span>(data)
  )
)

plan
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target   command                                 </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                  </span>
<span class="co">#&gt; 1 data_1_3 sim_data(mean = 1, sd = 3)              </span>
<span class="co">#&gt; 2 data_2_4 sim_data(mean = 2, sd = 4)              </span>
<span class="co">#&gt; 3 larger   do.call(rbind, list(data_1_3, data_2_4))</span>

config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-270cf12dee99691b5d50" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-270cf12dee99691b5d50">{"x":{"nodes":{"id":["data_1_3","data_2_4","larger"],"imported":[false,false,false],"label":["data_1_3","data_2_4","larger"],"command":["sim_data(mean = 1, sd = 3)","sim_data(mean = 2, sd = 4)","do.call(rbind, list(data_1_3, data_2_4))"],"status":["outdated","outdated","outdated"],"type":["object","object","object"],"font.size":[20,20,20],"color":["#000000","#000000","#000000"],"shape":["dot","dot","dot"],"level":[1,1,2],"title":["sim_data(mean&nbsp;=&nbsp;1,&nbsp;sd&nbsp;=&nbsp;3)","sim_data(mean&nbsp;=&nbsp;2,&nbsp;sd&nbsp;=&nbsp;4)","do.call(rbind,&nbsp;list(data_1_3,&nbsp;data_2_4))"],"x":[-1,1,0],"y":[-1,-1,1]},"edges":{"from":["data_1_3","data_2_4"],"to":["larger","larger"],"arrows":["to","to"],"smooth":[true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>As with <code>group_by()</code> from <code>dplyr</code>, you can create a separate aggregate for each combination of levels of the arguments. Just pass a symbol or vector of symbols to the optional <code>.by</code> argument of <code>combine()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y, <span class="dt">skew =</span> z),
    <span class="dt">transform =</span> <span class="kw">cross</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="dt">z =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>))
  ),
  <span class="dt">combined =</span> <span class="kw">target</span>(
    <span class="kw">do.call</span>(rbind, data),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> <span class="kw">c</span>(x, y))
  )
)

plan
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target       command                                     </span>
<span class="co">#&gt;    &lt;chr&gt;        &lt;expr&gt;                                      </span>
<span class="co">#&gt;  1 data_1_3_5   sim_data(mean = 1, sd = 3, skew = 5)        </span>
<span class="co">#&gt;  2 data_2_3_5   sim_data(mean = 2, sd = 3, skew = 5)        </span>
<span class="co">#&gt;  3 data_1_4_5   sim_data(mean = 1, sd = 4, skew = 5)        </span>
<span class="co">#&gt;  4 data_2_4_5   sim_data(mean = 2, sd = 4, skew = 5)        </span>
<span class="co">#&gt;  5 data_1_3_6   sim_data(mean = 1, sd = 3, skew = 6)        </span>
<span class="co">#&gt;  6 data_2_3_6   sim_data(mean = 2, sd = 3, skew = 6)        </span>
<span class="co">#&gt;  7 data_1_4_6   sim_data(mean = 1, sd = 4, skew = 6)        </span>
<span class="co">#&gt;  8 data_2_4_6   sim_data(mean = 2, sd = 4, skew = 6)        </span>
<span class="co">#&gt;  9 combined_1_3 do.call(rbind, list(data_1_3_5, data_1_3_6))</span>
<span class="co">#&gt; 10 combined_2_3 do.call(rbind, list(data_2_3_5, data_2_3_6))</span>
<span class="co">#&gt; 11 combined_1_4 do.call(rbind, list(data_1_4_5, data_1_4_6))</span>
<span class="co">#&gt; 12 combined_2_4 do.call(rbind, list(data_2_4_5, data_2_4_6))</span>

config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-c76a9266172c8658d3a3" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-c76a9266172c8658d3a3">{"x":{"nodes":{"id":["combined_1_3","combined_1_4","combined_2_3","combined_2_4","data_1_3_5","data_1_3_6","data_1_4_5","data_1_4_6","data_2_3_5","data_2_3_6","data_2_4_5","data_2_4_6"],"imported":[false,false,false,false,false,false,false,false,false,false,false,false],"label":["combined_1_3","combined_1_4","combined_2_3","combined_2_4","data_1_3_5","data_1_3_6","data_1_4_5","data_1_4_6","data_2_3_5","data_2_3_6","data_2_4_5","data_2_4_6"],"command":["do.call(rbind, list(data_1_3_5, data_1_3_6))","do.call(rbind, list(data_1_4_5, data_1_4_6))","do.call(rbind, list(data_2_3_5, data_2_3_6))","do.call(rbind, list(data_2_4_5, data_2_4_6))","sim_data(mean = 1, sd = 3, skew = 5)","sim_data(mean = 1, sd = 3, skew = 6)","sim_data(mean = 1, sd = 4, skew = 5)","sim_data(mean = 1, sd = 4, skew = 6)","sim_data(mean = 2, sd = 3, skew = 5)","sim_data(mean = 2, sd = 3, skew = 6)","sim_data(mean = 2, sd = 4, skew = 5)","sim_data(mean = 2, sd = 4, skew = 6)"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[2,2,2,2,1,1,1,1,1,1,1,1],"title":["do.call(rbind,&nbsp;list(data_1_3_5,&nbsp;data_1_3_6))","do.call(rbind,&nbsp;list(data_1_4_5,&nbsp;data_1_4_6))","do.call(rbind,&nbsp;list(data_2_3_5,&nbsp;data_2_3_6))","do.call(rbind,&nbsp;list(data_2_4_5,&nbsp;data_2_4_6))","sim_data(mean&nbsp;=&nbsp;1,&nbsp;sd&nbsp;=&nbsp;3,&nbsp;skew&nbsp;=&nbsp;5)","sim_data(mean&nbsp;=&nbsp;1,&nbsp;sd&nbsp;=&nbsp;3,&nbsp;skew&nbsp;=&nbsp;6)","sim_data(mean&nbsp;=&nbsp;1,&nbsp;sd&nbsp;=&nbsp;4,&nbsp;skew&nbsp;=&nbsp;5)","sim_data(mean&nbsp;=&nbsp;1,&nbsp;sd&nbsp;=&nbsp;4,&nbsp;skew&nbsp;=&nbsp;6)","sim_data(mean&nbsp;=&nbsp;2,&nbsp;sd&nbsp;=&nbsp;3,&nbsp;skew&nbsp;=&nbsp;5)","sim_data(mean&nbsp;=&nbsp;2,&nbsp;sd&nbsp;=&nbsp;3,&nbsp;skew&nbsp;=&nbsp;6)","sim_data(mean&nbsp;=&nbsp;2,&nbsp;sd&nbsp;=&nbsp;4,&nbsp;skew&nbsp;=&nbsp;5)","sim_data(mean&nbsp;=&nbsp;2,&nbsp;sd&nbsp;=&nbsp;4,&nbsp;skew&nbsp;=&nbsp;6)"],"x":[-0.857142857142857,-0.285714285714286,0.285714285714286,0.857142857142857,-1,-0.714285714285714,-0.428571428571429,-0.142857142857143,0.142857142857143,0.428571428571429,0.714285714285714,1],"y":[1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1]},"edges":{"from":["data_1_3_5","data_2_3_5","data_1_4_5","data_2_4_5","data_1_3_6","data_2_3_6","data_1_4_6","data_2_4_6"],"to":["combined_1_3","combined_2_3","combined_1_4","combined_2_4","combined_1_3","combined_2_3","combined_1_4","combined_2_4"],"arrows":["to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>Sometimes, a list like <code>list(data_1_3, data_2_4)</code> is not enough. You may need the values of <code>x</code> and <code>y</code> that underly <code>data_1_3</code> and <code>data_2_4</code>. Solution: get the trace and the target names. We define a new plan</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">sim_data</span>(<span class="dt">mean =</span> x, <span class="dt">sd =</span> y),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))
  ),
  <span class="dt">larger =</span> <span class="kw">target</span>(
    <span class="kw">post_process</span>(data, <span class="kw">ignore</span>(plan)),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)

plan
<span class="co">#&gt; # A tibble: 3 x 6</span>
<span class="co">#&gt;   target   command                               x     y     data    larger</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                                &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; </span>
<span class="co">#&gt; 1 data_1_3 sim_data(mean = 1, sd = 3)          … 1     3     data_1… &lt;NA&gt;  </span>
<span class="co">#&gt; 2 data_2_4 sim_data(mean = 2, sd = 4)          … 2     4     data_2… &lt;NA&gt;  </span>
<span class="co">#&gt; 3 larger   post_process(list(data_1_3, data_2_4… &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;    larger</span></code></pre>
<p>and a new function</p>
<pre class="sourceCode r"><code class="sourceCode r">post_process &lt;-<span class="st"> </span><span class="cf">function</span>(data_list, plan_with_trace) {
  <span class="co"># Get the names of the targets contained in data_list.</span>
  <span class="kw">names</span>(data_list) &lt;-<span class="st"> </span><span class="kw">all.vars</span>(<span class="kw">match.call</span>()<span class="op">$</span>data_list)
  
  <span class="co"># Get the trace of those targets.</span>
  data_trace &lt;-<span class="st"> </span><span class="kw">filter</span>(plan_with_trace, target <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(data_list))
  
  <span class="co"># Do post-processing with data_list and data_trace.</span>
}</code></pre>
<p><code>match.call()</code> captures the function call itself, including the names of the symbols passed to the arguments. This is handy in a variety of similar use cases.</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) {
  this_call &lt;-<span class="st"> </span><span class="kw">match.call</span>(<span class="dt">expand.dots =</span> <span class="ot">FALSE</span>)
  <span class="kw">print</span>(this_call)
  <span class="kw">cat</span>(<span class="st">&quot;mode:&quot;</span>, <span class="kw">mode</span>(this_call), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="st">&quot;type:&quot;</span>, <span class="kw">typeof</span>(this_call), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="st">&quot;x:&quot;</span>, <span class="kw">as.character</span>(this_call<span class="op">$</span>x), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="st">&quot;y:&quot;</span>, <span class="kw">all.vars</span>(this_call<span class="op">$</span>y), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
  <span class="kw">cat</span>(<span class="st">&quot;z:&quot;</span>, <span class="kw">as.character</span>(this_call<span class="op">$</span>...<span class="op">$</span>z), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
}

<span class="kw">f</span>(<span class="dt">x =</span> a, <span class="dt">y =</span> <span class="kw">c</span>(b, c), <span class="dt">z =</span> d)
<span class="co">#&gt; f(x = a, y = c(b, c), ... = pairlist(z = d))</span>
<span class="co">#&gt; mode: call </span>
<span class="co">#&gt; type: language </span>
<span class="co">#&gt; x: a </span>
<span class="co">#&gt; y: b c </span>
<span class="co">#&gt; z: d</span></code></pre>
<p>To learn more about metaprogramming, you can consult the <a href="https://adv-r.hadley.nz/introduction-16.html">metaprogramming chapters in Advanced R</a>. For more discussion on this use case of <code>drake</code>, please see <a href="https://github.com/ropensci/drake/issues/693">this thread on GitHub</a>. Comments, questions, etc. are welcome. Please feel free to post.</p>
</div>
</div>
<div id="target-names" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Target names</h3>
<p>All three transformations have an optional <code>.id</code> argument. Set it to <code>FALSE</code> to severely shorten the target names.</p>
<pre class="sourceCode r"><code class="sourceCode r">path &lt;-<span class="st"> &quot;my/crazy/long/file_path&quot;</span>
files &lt;-<span class="st"> </span><span class="kw">file.path</span>(path, <span class="kw">c</span>(<span class="st">&quot;file1.csv&quot;</span>, <span class="st">&quot;file2.csv&quot;</span>))

files
<span class="co">#&gt; [1] &quot;my/crazy/long/file_path/file1.csv&quot; &quot;my/crazy/long/file_path/file2.csv&quot;</span>

<span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">read.csv</span>(<span class="kw">file_in</span>(file)),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">file =</span> <span class="op">!!</span>files, <span class="dt">.id =</span> <span class="ot">FALSE</span>)
  )
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command                                               </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;                                                </span>
<span class="co">#&gt; 1 data   read.csv(file_in(&quot;my/crazy/long/file_path/file1.csv&quot;))</span>
<span class="co">#&gt; 2 data.1 read.csv(file_in(&quot;my/crazy/long/file_path/file2.csv&quot;))</span></code></pre>
<p>For more suggestive names, you can select the grouping variables for the suffixes. In <code>map()</code> and <code>cross()</code>, all grouping variables are allowed except tags. In <code>combine()</code>, you can only use the symbols passed to <code>.by</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">data =</span> <span class="kw">target</span>(
    <span class="kw">subset_data</span>(<span class="kw">read.csv</span>(<span class="kw">file_in</span>(file)), <span class="dt">predictor =</span> x, <span class="dt">response =</span> y),
    <span class="dt">transform =</span> <span class="kw">cross</span>(
      <span class="dt">file =</span> <span class="op">!!</span>files,
      <span class="dt">x =</span> <span class="kw">c</span>(income, unemp),
      <span class="dt">y =</span> <span class="kw">c</span>(gdp, pop),
      <span class="dt">.id =</span> <span class="kw">c</span>(x, y)
    )
  )
)

plan<span class="op">$</span>target
<span class="co">#&gt; [1] &quot;data_income_gdp&quot;   &quot;data_income_gdp.1&quot; &quot;data_unemp_gdp&quot;   </span>
<span class="co">#&gt; [4] &quot;data_unemp_gdp.1&quot;  &quot;data_income_pop&quot;   &quot;data_income_pop.1&quot;</span>
<span class="co">#&gt; [7] &quot;data_unemp_pop&quot;    &quot;data_unemp_pop.1&quot;</span>

plan
<span class="co">#&gt; # A tibble: 8 x 2</span>
<span class="co">#&gt;   target          command                                                  </span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;expr&gt;                                                   </span>
<span class="co">#&gt; 1 data_income_gdp subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 2 data_income_gd… subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 3 data_unemp_gdp  subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 4 data_unemp_gdp… subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 5 data_income_pop subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 6 data_income_po… subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 7 data_unemp_pop  subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span>
<span class="co">#&gt; 8 data_unemp_pop… subset_data(read.csv(file_in(&quot;my/crazy/long/file_path/fi…</span></code></pre>
</div>
<div id="grouping-variables" class="section level3">
<h3><span class="header-section-number">6.5.4</span> Grouping variables</h3>
<p>A grouping variable is an argument to <code>map()</code>, <code>cross()</code>, or <code>combine()</code> that identifies a sub-collection of target names. Grouping variables can be either literals or symbols. Symbols can be scalars or vectors, and you can pass them to transformations with or without argument names.</p>
<div id="literal-arguments" class="section level4">
<h4><span class="header-section-number">6.5.4.1</span> Literal arguments</h4>
<p>When you pass a grouping variable of literals, you must use an explicit argument name. One does not simply write <code>map(c(1, 2))</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_2    sqrt(2)</span></code></pre>
<p>And if you supply integer sequences the usual way, you may notice some rows are missing.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)))
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_3    sqrt(3)</span></code></pre>
<p>Tidy evaluation and <code>as.numeric()</code> make sure all the data points show up.</p>
<pre class="sourceCode r"><code class="sourceCode r">y_vals &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>y_vals)))
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt; </span>
<span class="co">#&gt; 1 x_1    sqrt(1)</span>
<span class="co">#&gt; 2 x_2    sqrt(2)</span>
<span class="co">#&gt; 3 x_3    sqrt(3)</span></code></pre>
<p>Character vectors usually work without a hitch, and quotes are converted into dots to make valid target names.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))))
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target command      </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;       </span>
<span class="co">#&gt; 1 x_.a.  get_data(&quot;a&quot;)</span>
<span class="co">#&gt; 2 x_.b.  get_data(&quot;b&quot;)</span>
<span class="co">#&gt; 3 x_.c.  get_data(&quot;c&quot;)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r">y_vals &lt;-<span class="st"> </span>letters
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>y_vals)))
<span class="co">#&gt; # A tibble: 26 x 2</span>
<span class="co">#&gt;    target command      </span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;expr&gt;       </span>
<span class="co">#&gt;  1 x_.a.  get_data(&quot;a&quot;)</span>
<span class="co">#&gt;  2 x_.b.  get_data(&quot;b&quot;)</span>
<span class="co">#&gt;  3 x_.c.  get_data(&quot;c&quot;)</span>
<span class="co">#&gt;  4 x_.d.  get_data(&quot;d&quot;)</span>
<span class="co">#&gt;  5 x_.e.  get_data(&quot;e&quot;)</span>
<span class="co">#&gt;  6 x_.f.  get_data(&quot;f&quot;)</span>
<span class="co">#&gt;  7 x_.g.  get_data(&quot;g&quot;)</span>
<span class="co">#&gt;  8 x_.h.  get_data(&quot;h&quot;)</span>
<span class="co">#&gt;  9 x_.i.  get_data(&quot;i&quot;)</span>
<span class="co">#&gt; 10 x_.j.  get_data(&quot;j&quot;)</span>
<span class="co">#&gt; # … with 16 more rows</span></code></pre>
</div>
<div id="named-symbol-arguments" class="section level4">
<h4><span class="header-section-number">6.5.4.2</span> Named symbol arguments</h4>
<p>Symbols passed with explicit argument names define new groupings of existing targets on the fly, and only the <code>map()</code> and <code>cross()</code> transformations can accept them this ways. To generate long symbol lists, use the <code>syms()</code> function from the <code>rlang</code> package. Remember to use the tidy evaluation operator <code>!!</code> inside the transformation.</p>
<pre class="sourceCode r"><code class="sourceCode r">vals &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">syms</span>(letters)
<span class="kw">drake_plan</span>(<span class="dt">x =</span> <span class="kw">target</span>(<span class="kw">get_data</span>(y), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="op">!!</span>vals)))
<span class="co">#&gt; # A tibble: 26 x 2</span>
<span class="co">#&gt;    target command    </span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;expr&gt;     </span>
<span class="co">#&gt;  1 x_a    get_data(a)</span>
<span class="co">#&gt;  2 x_b    get_data(b)</span>
<span class="co">#&gt;  3 x_c    get_data(c)</span>
<span class="co">#&gt;  4 x_d    get_data(d)</span>
<span class="co">#&gt;  5 x_e    get_data(e)</span>
<span class="co">#&gt;  6 x_f    get_data(f)</span>
<span class="co">#&gt;  7 x_g    get_data(g)</span>
<span class="co">#&gt;  8 x_h    get_data(h)</span>
<span class="co">#&gt;  9 x_i    get_data(i)</span>
<span class="co">#&gt; 10 x_j    get_data(j)</span>
<span class="co">#&gt; # … with 16 more rows</span></code></pre>
<p>The new groupings carry over to downstream targets by default, which you can see with <code>trace = TRUE</code>. Below, the rows for targets <code>w_x</code> and <code>w_y</code> have entries in the and <code>z</code> column.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">10</span>))),
  <span class="dt">y =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="dv">1</span>))),
  <span class="dt">z =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(val), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">w =</span> <span class="kw">target</span>(val <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">transform =</span> <span class="kw">map</span>(val)),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   target command                  val   z     w    </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;                   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x      abs(mean(rnorm(10)))     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 2 y      abs(mean(rnorm(100, 1))) &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 3 z_x    sqrt(x)                  x     z_x   &lt;NA&gt; </span>
<span class="co">#&gt; 4 z_y    sqrt(y)                  y     z_y   &lt;NA&gt; </span>
<span class="co">#&gt; 5 w_x    x + 1                    x     z_x   w_x  </span>
<span class="co">#&gt; 6 w_y    y + 1                    y     z_y   w_y</span></code></pre>
<p>However, this is <em>incorrect</em> because <code>w</code> does not depend on <code>z_x</code> or <code>z_y</code>. So for <code>w</code>, you should write <code>map(val = c(x, y))</code> instead of <code>map(val)</code> to tell <code>drake</code> to clear the trace. Then, you will see <code>NA</code>s in the <code>z</code> column for <code>w_x</code> and <code>w_y</code>, which is right and proper.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">10</span>))),
  <span class="dt">y =</span> <span class="kw">abs</span>(<span class="kw">mean</span>(<span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="dv">1</span>))),
  <span class="dt">z =</span> <span class="kw">target</span>(<span class="kw">sqrt</span>(val), <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">w =</span> <span class="kw">target</span>(val <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">val =</span> <span class="kw">c</span>(x, y))),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   target command                  val   w     z    </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;                   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x      abs(mean(rnorm(10)))     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 2 y      abs(mean(rnorm(100, 1))) &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 3 z_x    sqrt(x)                  x     &lt;NA&gt;  z_x  </span>
<span class="co">#&gt; 4 z_y    sqrt(y)                  y     &lt;NA&gt;  z_y  </span>
<span class="co">#&gt; 5 w_x    x + 1                    x     w_x   &lt;NA&gt; </span>
<span class="co">#&gt; 6 w_y    y + 1                    y     w_y   &lt;NA&gt;</span></code></pre>
</div>
</div>
<div id="tags" class="section level3">
<h3><span class="header-section-number">6.5.5</span> Tags</h3>
<p>Tags are special optional grouping variables. They are ignored while the transformation is happening and then added to the plan to help subsequent transformations. There are two types of tags:</p>
<ol style="list-style-type: decimal">
<li>In-tags, which contain the target name you start with, and</li>
<li>Out-tags, which contain the target names generated by the transformations.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">x =</span> <span class="kw">target</span>(
    command,
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> from, <span class="dt">.tag_out =</span> <span class="kw">c</span>(to, out))
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
<span class="co">#&gt; # A tibble: 2 x 7</span>
<span class="co">#&gt;   target command y     x     from  to    out  </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 x_1    command 1     x_1   x     x_1   x_1  </span>
<span class="co">#&gt; 2 x_2    command 2     x_2   x     x_2   x_2</span></code></pre>
<p>Subsequent transformations can use tags as grouping variables and add to existing tags.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">prep_work =</span> <span class="kw">do_prep_work</span>(),
  <span class="dt">local =</span> <span class="kw">target</span>(
    <span class="kw">get_local_data</span>(n, prep_work),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> data_source, <span class="dt">.tag_out =</span> data)
  ),
  <span class="dt">online =</span> <span class="kw">target</span>(
    <span class="kw">get_online_data</span>(n, prep_work, <span class="dt">port =</span> <span class="st">&quot;8080&quot;</span>),
    <span class="dt">transform =</span> <span class="kw">map</span>(<span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">.tag_in =</span> data_source, <span class="dt">.tag_out =</span> data)
  ),
  <span class="dt">summary =</span> <span class="kw">target</span>(
    <span class="kw">summarize</span>(data),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> data_source)
  ),
  <span class="dt">summ_num =</span> <span class="kw">target</span>(
    <span class="kw">summarize</span>(data),
    <span class="dt">transform =</span> <span class="kw">combine</span>(data, <span class="dt">.by =</span> n)
  )
)

plan
<span class="co">#&gt; # A tibble: 9 x 2</span>
<span class="co">#&gt;   target         command                                     </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;expr&gt;                                      </span>
<span class="co">#&gt; 1 prep_work      do_prep_work()                              </span>
<span class="co">#&gt; 2 local_1        get_local_data(1, prep_work)                </span>
<span class="co">#&gt; 3 local_2        get_local_data(2, prep_work)                </span>
<span class="co">#&gt; 4 online_1       get_online_data(1, prep_work, port = &quot;8080&quot;)</span>
<span class="co">#&gt; 5 online_2       get_online_data(2, prep_work, port = &quot;8080&quot;)</span>
<span class="co">#&gt; 6 summary_local  summarize(list(local_1, local_2))           </span>
<span class="co">#&gt; 7 summary_online summarize(list(online_1, online_2))         </span>
<span class="co">#&gt; 8 summ_num_1     summarize(list(local_1, online_1))          </span>
<span class="co">#&gt; 9 summ_num_2     summarize(list(local_2, online_2))</span>

config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(config)</code></pre>
<div id="htmlwidget-9832503ab331c471346d" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-9832503ab331c471346d">{"x":{"nodes":{"id":["local_1","local_2","online_1","online_2","prep_work","summ_num_1","summ_num_2","summary_local","summary_online"],"imported":[false,false,false,false,false,false,false,false,false],"label":["local_1","local_2","online_1","online_2","prep_work","summ_num_1","summ_num_2","summary_local","summary_online"],"command":["get_local_data(1, prep_work)","get_local_data(2, prep_work)","get_online_data(1, prep_work, port = \"8080\")","get_online_data(2, prep_work, port = \"8080\")","do_prep_work()","summarize(list(local_1, online_1))","summarize(list(local_2, online_2))","summarize(list(local_1, local_2))","summarize(list(online_1, online_2))"],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["object","object","object","object","object","object","object","object","object"],"font.size":[20,20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["dot","dot","dot","dot","dot","dot","dot","dot","dot"],"level":[2,2,2,2,1,3,3,3,3],"title":["get_local_data(1,&nbsp;prep_work)","get_local_data(2,&nbsp;prep_work)","get_online_data(1,&nbsp;prep_work,&nbsp;port&nbsp;=&nbsp;\"8080\")","get_online_data(2,&nbsp;prep_work,&nbsp;port&nbsp;=&nbsp;\"8080\")","do_prep_work()","summarize(list(local_1,&nbsp;online_1))","summarize(list(local_2,&nbsp;online_2))","summarize(list(local_1,&nbsp;local_2))","summarize(list(online_1,&nbsp;online_2))"],"x":[-1,-0.25,0.25,1,0,-0.25,0.25,-1,1],"y":[0,0,0,0,-1,1,1,1,1]},"edges":{"from":["prep_work","prep_work","prep_work","prep_work","local_1","local_1","local_2","local_2","online_1","online_1","online_2","online_2"],"to":["local_1","local_2","online_1","online_2","summary_local","summ_num_1","summary_local","summ_num_2","summary_online","summ_num_1","summary_online","summ_num_2"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Object"],"color":["#000000","#888888"],"shape":["dot","dot"],"font.color":["black","black"],"font.size":[20,20],"id":[2,7]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p><br></p>
</div>
</div>
<div id="create-large-plans-the-old-way" class="section level2">
<h2><span class="header-section-number">6.6</span> Create large plans the <em>old</em> way</h2>
<p><code>drake</code> provides several older utility that increase the flexibility of plan creation.</p>
<ul>
<li><code>drake_plan()</code></li>
<li><code>map_plan()</code></li>
<li><code>evaluate_plan()</code></li>
<li><code>expand_plan()</code></li>
<li><code>gather_by()</code></li>
<li><code>reduce_by()</code></li>
<li><code>gather_plan()</code></li>
<li><code>reduce_plan()</code></li>
</ul>
<div id="map_plan" class="section level3">
<h3><span class="header-section-number">6.6.1</span> <code>map_plan()</code></h3>
<p><a href="https://github.com/tidyverse/purrr"><code>purrr</code></a>-like functional programming is like looping, but cleaner. The idea is to iterate the same computation over multiple different data points. You write a function to do something once, and a <a href="https://purrr.tidyverse.org/reference/map.html"><code>map()</code></a>-like helper invokes it on each point in your dataset. <code>drake</code>’s version of <a href="https://purrr.tidyverse.org/reference/map.html"><code>map()</code></a> — or more precisely, <a href="https://purrr.tidyverse.org/reference/map2.html"><code>pmap_df()</code></a> — is <a href="https://ropensci.github.io/drake/reference/map_plan.html"><code>map_plan()</code></a>.</p>
<p>In the following example, we want to know how well each pair covariates in the <a href="https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html"><code>mtcars</code> dataset</a> can predict fuel efficiency (in miles per gallon). We will try multiple pairs of covariates using the same statistical analysis, so it is a great time for <code>drake</code>-flavored functional programming with <code>map_plan()</code>.</p>
<p>As with its cousin, <a href="https://purrr.tidyverse.org/reference/map2.html"><code>pmap_df()</code></a>, <a href="https://ropensci.github.io/drake/reference/map_plan.html"><code>map_plan()</code></a> needs</p>
<ol style="list-style-type: decimal">
<li>A function.</li>
<li>A grid of function arguments.</li>
</ol>
<p>Our function fits a fuel efficiency model given a <em>single</em> pair of covariate names <code>x1</code> and <code>x2</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">my_model_fit &lt;-<span class="st"> </span><span class="cf">function</span>(x1, x2, data){
  <span class="kw">lm</span>(<span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;mpg ~&quot;</span>, x1, <span class="st">&quot;+&quot;</span>, x2)), <span class="dt">data =</span> data)
}</code></pre>
<p>Our grid of function arguments is a data frame of possible values for <code>x1</code>, <code>x2</code>, and <code>data</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">covariates &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(mtcars), <span class="st">&quot;mpg&quot;</span>) <span class="co"># Exclude the response variable.</span>
args &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">combn</span>(covariates, <span class="dv">2</span>)) <span class="co"># Take all possible pairs.</span>
<span class="kw">colnames</span>(args) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>) <span class="co"># The column names must be the argument names of my_model_fit()</span>
args &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw">as_tibble</span>(args) <span class="co"># Tibbles are so nice.</span>
args<span class="op">$</span>data &lt;-<span class="st"> &quot;mtcars&quot;</span>

args
<span class="co">#&gt; # A tibble: 45 x 3</span>
<span class="co">#&gt;    x1    x2    data  </span>
<span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; </span>
<span class="co">#&gt;  1 cyl   disp  mtcars</span>
<span class="co">#&gt;  2 cyl   hp    mtcars</span>
<span class="co">#&gt;  3 cyl   drat  mtcars</span>
<span class="co">#&gt;  4 cyl   wt    mtcars</span>
<span class="co">#&gt;  5 cyl   qsec  mtcars</span>
<span class="co">#&gt;  6 cyl   vs    mtcars</span>
<span class="co">#&gt;  7 cyl   am    mtcars</span>
<span class="co">#&gt;  8 cyl   gear  mtcars</span>
<span class="co">#&gt;  9 cyl   carb  mtcars</span>
<span class="co">#&gt; 10 disp  hp    mtcars</span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre>
<p>Each row of <code>args</code> corresponds to a call to <code>my_model_fit()</code>. To actually write out all those function calls, we use <code>map_plan()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">map_plan</span>(args, my_model_fit)
<span class="co">#&gt; # A tibble: 45 x 2</span>
<span class="co">#&gt;    target                command                                           </span>
<span class="co">#&gt;    &lt;chr&gt;                 &lt;expr&gt;                                            </span>
<span class="co">#&gt;  1 my_model_fit_501e051c my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;disp&quot;, data = &quot;mtc…</span>
<span class="co">#&gt;  2 my_model_fit_d5de1d57 my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;hp&quot;, data = &quot;mtcar…</span>
<span class="co">#&gt;  3 my_model_fit_eac6cd8b my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;drat&quot;, data = &quot;mtc…</span>
<span class="co">#&gt;  4 my_model_fit_3900ef48 my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;wt&quot;, data = &quot;mtcar…</span>
<span class="co">#&gt;  5 my_model_fit_a2d797f6 my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;qsec&quot;, data = &quot;mtc…</span>
<span class="co">#&gt;  6 my_model_fit_f5c0ac7a my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;vs&quot;, data = &quot;mtcar…</span>
<span class="co">#&gt;  7 my_model_fit_507d2929 my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;am&quot;, data = &quot;mtcar…</span>
<span class="co">#&gt;  8 my_model_fit_b5f9a8a3 my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;gear&quot;, data = &quot;mtc…</span>
<span class="co">#&gt;  9 my_model_fit_8c4c5d9d my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;carb&quot;, data = &quot;mtc…</span>
<span class="co">#&gt; 10 my_model_fit_f9bb916e my_model_fit(x1 = &quot;disp&quot;, x2 = &quot;hp&quot;, data = &quot;mtca…</span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre>
<p>We now have a plan, but it has a couple issues.</p>
<ol style="list-style-type: decimal">
<li>The <code>data</code> argument should be a symbol. In other words, we want <code>my_model_fit(data = mtcars)</code>, not <code>my_model_fit(data = &quot;mtcars&quot;)</code>. So we use the <a href="https://rlang.r-lib.org/reference/sym.html"><code>syms()</code></a> function from the <a href="https://github.com/r-lib/rlang"><code>rlang</code></a> package turn <code>args$data</code> into a list of symbols.</li>
<li>The default argument names are ugly, so we can add a new <code>&quot;id&quot;</code> column to <code>args</code> (or select one with the <code>id</code> argument of <code>map_plan()</code>).</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fixes (1)</span>
args<span class="op">$</span>data &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">syms</span>(args<span class="op">$</span>data)

<span class="co"># Alternative if each element of `args$data` is code with multiple symbols:</span>
<span class="co"># args$data &lt;- purrr::map(args$data, rlang::parse_expr)</span>

<span class="co"># Fixes (2)</span>
args<span class="op">$</span>id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;fit_&quot;</span>, args<span class="op">$</span>x1, <span class="st">&quot;_&quot;</span>, args<span class="op">$</span>x2)

args
<span class="co">#&gt; # A tibble: 45 x 4</span>
<span class="co">#&gt;    x1    x2    data   id          </span>
<span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt; &lt;list&gt; &lt;chr&gt;       </span>
<span class="co">#&gt;  1 cyl   disp  &lt;sym&gt;  fit_cyl_disp</span>
<span class="co">#&gt;  2 cyl   hp    &lt;sym&gt;  fit_cyl_hp  </span>
<span class="co">#&gt;  3 cyl   drat  &lt;sym&gt;  fit_cyl_drat</span>
<span class="co">#&gt;  4 cyl   wt    &lt;sym&gt;  fit_cyl_wt  </span>
<span class="co">#&gt;  5 cyl   qsec  &lt;sym&gt;  fit_cyl_qsec</span>
<span class="co">#&gt;  6 cyl   vs    &lt;sym&gt;  fit_cyl_vs  </span>
<span class="co">#&gt;  7 cyl   am    &lt;sym&gt;  fit_cyl_am  </span>
<span class="co">#&gt;  8 cyl   gear  &lt;sym&gt;  fit_cyl_gear</span>
<span class="co">#&gt;  9 cyl   carb  &lt;sym&gt;  fit_cyl_carb</span>
<span class="co">#&gt; 10 disp  hp    &lt;sym&gt;  fit_disp_hp </span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre>
<p>Much better.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">map_plan</span>(args, my_model_fit)
plan
<span class="co">#&gt; # A tibble: 45 x 2</span>
<span class="co">#&gt;    target       command                                             </span>
<span class="co">#&gt;    &lt;chr&gt;        &lt;expr&gt;                                              </span>
<span class="co">#&gt;  1 fit_cyl_disp my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;disp&quot;, data = mtcars)</span>
<span class="co">#&gt;  2 fit_cyl_hp   my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;hp&quot;, data = mtcars)  </span>
<span class="co">#&gt;  3 fit_cyl_drat my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;drat&quot;, data = mtcars)</span>
<span class="co">#&gt;  4 fit_cyl_wt   my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;wt&quot;, data = mtcars)  </span>
<span class="co">#&gt;  5 fit_cyl_qsec my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;qsec&quot;, data = mtcars)</span>
<span class="co">#&gt;  6 fit_cyl_vs   my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;vs&quot;, data = mtcars)  </span>
<span class="co">#&gt;  7 fit_cyl_am   my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;am&quot;, data = mtcars)  </span>
<span class="co">#&gt;  8 fit_cyl_gear my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;gear&quot;, data = mtcars)</span>
<span class="co">#&gt;  9 fit_cyl_carb my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;carb&quot;, data = mtcars)</span>
<span class="co">#&gt; 10 fit_disp_hp  my_model_fit(x1 = &quot;disp&quot;, x2 = &quot;hp&quot;, data = mtcars) </span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre>
<p>We may also want to retain information about the constituent function arguments of each target. With <code>map_plan(trace = TRUE)</code>, we can append the columns of <code>args</code> alongside the usual <code>&quot;target&quot;</code> and <code>&quot;command&quot;</code> columns of our plan.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">map_plan</span>(args, my_model_fit, <span class="dt">trace =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; # A tibble: 45 x 6</span>
<span class="co">#&gt;    target     command                           x1    x2    data  id       </span>
<span class="co">#&gt;    &lt;chr&gt;      &lt;expr&gt;                            &lt;chr&gt; &lt;chr&gt; &lt;exp&gt; &lt;chr&gt;    </span>
<span class="co">#&gt;  1 fit_cyl_d… my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;d… cyl   disp  mtca… fit_cyl_…</span>
<span class="co">#&gt;  2 fit_cyl_hp my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;h… cyl   hp    mtca… fit_cyl_…</span>
<span class="co">#&gt;  3 fit_cyl_d… my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;d… cyl   drat  mtca… fit_cyl_…</span>
<span class="co">#&gt;  4 fit_cyl_wt my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;w… cyl   wt    mtca… fit_cyl_…</span>
<span class="co">#&gt;  5 fit_cyl_q… my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;q… cyl   qsec  mtca… fit_cyl_…</span>
<span class="co">#&gt;  6 fit_cyl_vs my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;v… cyl   vs    mtca… fit_cyl_…</span>
<span class="co">#&gt;  7 fit_cyl_am my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;a… cyl   am    mtca… fit_cyl_…</span>
<span class="co">#&gt;  8 fit_cyl_g… my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;g… cyl   gear  mtca… fit_cyl_…</span>
<span class="co">#&gt;  9 fit_cyl_c… my_model_fit(x1 = &quot;cyl&quot;, x2 = &quot;c… cyl   carb  mtca… fit_cyl_…</span>
<span class="co">#&gt; 10 fit_disp_… my_model_fit(x1 = &quot;disp&quot;, x2 = &quot;… disp  hp    mtca… fit_disp…</span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre>
<p>In any case, we can now fit our models.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make</span>(plan, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</code></pre>
<p>And inspect the output.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">readd</span>(fit_cyl_disp)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = as.formula(paste(&quot;mpg ~&quot;, x1, &quot;+&quot;, x2)), data = data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)          cyl         disp  </span>
<span class="co">#&gt;    34.66099     -1.58728     -0.02058</span></code></pre>
</div>
<div id="wildcard-templating" class="section level3">
<h3><span class="header-section-number">6.6.2</span> Wildcard templating</h3>
<p>In <code>drake</code>, you can write plans with wildcards. These wildcards are placeholders for text in commands. By iterating over the possible values of a wildcard, you can easily generate plans with thousands of targets. Let’s say you are running a simulation study, and you need to generate sets of random numbers from different distributions.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rt</span>(<span class="dv">1000</span>, <span class="dt">df =</span> <span class="dv">5</span>),
  <span class="dt">normal =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)
)</code></pre>
<p>If you need to generate many datasets with different means, you may wish to write out each target individually.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rt</span>(<span class="dv">1000</span>, <span class="dt">df =</span> <span class="dv">5</span>),
  <span class="dt">normal_0 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_1 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_2 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_3 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">3</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_4 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">4</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_5 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">5</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_6 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">6</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_7 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">7</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_8 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">8</span>, <span class="dt">sd =</span> <span class="dv">1</span>),
  <span class="dt">normal_9 =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="dv">9</span>, <span class="dt">sd =</span> <span class="dv">1</span>)
)</code></pre>
<p>But writing all that code manually is a pain and prone to human error. Instead, use <code>evaluate_plan()</code></p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rt</span>(<span class="dv">1000</span>, <span class="dt">df =</span> <span class="dv">5</span>),
  <span class="dt">normal =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> mean__, <span class="dt">sd =</span> <span class="dv">1</span>)
)
<span class="kw">evaluate_plan</span>(plan, <span class="dt">wildcard =</span> <span class="st">&quot;mean__&quot;</span>, <span class="dt">values =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">9</span>)
<span class="co">#&gt; # A tibble: 11 x 2</span>
<span class="co">#&gt;    target   command                      </span>
<span class="co">#&gt;    &lt;chr&gt;    &lt;expr&gt;                       </span>
<span class="co">#&gt;  1 t        rt(1000, df = 5)             </span>
<span class="co">#&gt;  2 normal_0 runif(1000, mean = 0, sd = 1)</span>
<span class="co">#&gt;  3 normal_1 runif(1000, mean = 1, sd = 1)</span>
<span class="co">#&gt;  4 normal_2 runif(1000, mean = 2, sd = 1)</span>
<span class="co">#&gt;  5 normal_3 runif(1000, mean = 3, sd = 1)</span>
<span class="co">#&gt;  6 normal_4 runif(1000, mean = 4, sd = 1)</span>
<span class="co">#&gt;  7 normal_5 runif(1000, mean = 5, sd = 1)</span>
<span class="co">#&gt;  8 normal_6 runif(1000, mean = 6, sd = 1)</span>
<span class="co">#&gt;  9 normal_7 runif(1000, mean = 7, sd = 1)</span>
<span class="co">#&gt; 10 normal_8 runif(1000, mean = 8, sd = 1)</span>
<span class="co">#&gt; 11 normal_9 runif(1000, mean = 9, sd = 1)</span></code></pre>
<p>You can specify multiple wildcards at once. If multiple wildcards appear in the same command, you will get a new target for each unique combination of values.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rt</span>(<span class="dv">1000</span>, <span class="dt">df =</span> df__),
  <span class="dt">normal =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> mean__, <span class="dt">sd =</span> sd__)
)
<span class="kw">evaluate_plan</span>(
  plan,
  <span class="dt">rules =</span> <span class="kw">list</span>(
    <span class="dt">mean__ =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),
    <span class="dt">sd__ =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>),
    <span class="dt">df__ =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>
  )
)
<span class="co">#&gt; # A tibble: 7 x 2</span>
<span class="co">#&gt;   target     command                      </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;expr&gt;                       </span>
<span class="co">#&gt; 1 t_5        rt(1000, df = 5)             </span>
<span class="co">#&gt; 2 t_6        rt(1000, df = 6)             </span>
<span class="co">#&gt; 3 t_7        rt(1000, df = 7)             </span>
<span class="co">#&gt; 4 normal_0_3 runif(1000, mean = 0, sd = 3)</span>
<span class="co">#&gt; 5 normal_0_4 runif(1000, mean = 0, sd = 4)</span>
<span class="co">#&gt; 6 normal_1_3 runif(1000, mean = 1, sd = 3)</span>
<span class="co">#&gt; 7 normal_1_4 runif(1000, mean = 1, sd = 4)</span></code></pre>
<p>Wildcards for <code>evaluate_plan()</code> do not need to have the double-underscore suffix. Any valid symbol will do.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rt</span>(<span class="dv">1000</span>, <span class="dt">df =</span> .DF.),
  <span class="dt">normal =</span> <span class="kw">runif</span>(<span class="dv">1000</span>, <span class="dt">mean =</span> <span class="st">`</span><span class="dt">{MEAN}</span><span class="st">`</span>, <span class="dt">sd =</span> ..sd)
)
<span class="kw">evaluate_plan</span>(
  plan,
  <span class="dt">rules =</span> <span class="kw">list</span>(
    <span class="st">&quot;`{MEAN}`&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),
    <span class="dt">..sd =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>),
    <span class="dt">.DF. =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>
  )
)
<span class="co">#&gt; # A tibble: 7 x 2</span>
<span class="co">#&gt;   target     command                      </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;expr&gt;                       </span>
<span class="co">#&gt; 1 t_5        rt(1000, df = 5)             </span>
<span class="co">#&gt; 2 t_6        rt(1000, df = 6)             </span>
<span class="co">#&gt; 3 t_7        rt(1000, df = 7)             </span>
<span class="co">#&gt; 4 normal_0_3 runif(1000, mean = 0, sd = 3)</span>
<span class="co">#&gt; 5 normal_0_4 runif(1000, mean = 0, sd = 4)</span>
<span class="co">#&gt; 6 normal_1_3 runif(1000, mean = 1, sd = 3)</span>
<span class="co">#&gt; 7 normal_1_4 runif(1000, mean = 1, sd = 4)</span></code></pre>
<p>Set <code>expand</code> to <code>FALSE</code> to disable expansion.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">t  =</span> <span class="kw">rpois</span>(samples__, <span class="dt">lambda =</span> mean__),
  <span class="dt">normal =</span> <span class="kw">runif</span>(samples__, <span class="dt">mean =</span> mean__)
)
<span class="kw">evaluate_plan</span>(
  plan,
  <span class="dt">rules =</span> <span class="kw">list</span>(
    <span class="dt">samples__ =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">100</span>),
    <span class="dt">mean__ =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)
  ),
  <span class="dt">expand =</span> <span class="ot">FALSE</span>
)
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target command              </span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;expr&gt;               </span>
<span class="co">#&gt; 1 t      rpois(50, lambda = 1)</span>
<span class="co">#&gt; 2 normal runif(100, mean = 5)</span></code></pre>
<p>Wildcard templating can sometimes be tricky. For example, suppose your project is to analyze school data, and your workflow checks several metrics of several schools. The idea is to write a <code>drake</code> plan with your metrics and let the wildcard templating expand over the available schools.</p>
<pre class="sourceCode r"><code class="sourceCode r">hard_plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">credits =</span> <span class="kw">check_credit_hours</span>(school__),
  <span class="dt">students =</span> <span class="kw">check_students</span>(school__),
  <span class="dt">grads =</span> <span class="kw">check_graduations</span>(school__),
  <span class="dt">public_funds =</span> <span class="kw">check_public_funding</span>(school__)
)

<span class="kw">evaluate_plan</span>(
  hard_plan,
  <span class="dt">rules =</span> <span class="kw">list</span>(<span class="dt">school__ =</span> <span class="kw">c</span>(<span class="st">&quot;schoolA&quot;</span>, <span class="st">&quot;schoolB&quot;</span>, <span class="st">&quot;schoolC&quot;</span>))
)
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;    target               command                      </span>
<span class="co">#&gt;    &lt;chr&gt;                &lt;expr&gt;                       </span>
<span class="co">#&gt;  1 credits_schoolA      check_credit_hours(schoolA)  </span>
<span class="co">#&gt;  2 credits_schoolB      check_credit_hours(schoolB)  </span>
<span class="co">#&gt;  3 credits_schoolC      check_credit_hours(schoolC)  </span>
<span class="co">#&gt;  4 students_schoolA     check_students(schoolA)      </span>
<span class="co">#&gt;  5 students_schoolB     check_students(schoolB)      </span>
<span class="co">#&gt;  6 students_schoolC     check_students(schoolC)      </span>
<span class="co">#&gt;  7 grads_schoolA        check_graduations(schoolA)   </span>
<span class="co">#&gt;  8 grads_schoolB        check_graduations(schoolB)   </span>
<span class="co">#&gt;  9 grads_schoolC        check_graduations(schoolC)   </span>
<span class="co">#&gt; 10 public_funds_schoolA check_public_funding(schoolA)</span>
<span class="co">#&gt; 11 public_funds_schoolB check_public_funding(schoolB)</span>
<span class="co">#&gt; 12 public_funds_schoolC check_public_funding(schoolC)</span></code></pre>
<p>But what if some metrics do not make sense? For example, what if <code>schoolC</code> is a completely privately-funded school? With no public funds, <code>check_public_funds(schoolC)</code> may quit in error if we are not careful. This is where setting up <code>drake</code> plans requires a little creativity. In this case, we recommend that you use two wildcards: one for all the schools and another for just the public schools. The new plan has no twelfth row.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan_template &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">school =</span> <span class="kw">get_school_data</span>(<span class="st">&quot;school__&quot;</span>),
  <span class="dt">credits =</span> <span class="kw">check_credit_hours</span>(all_schools__),
  <span class="dt">students =</span> <span class="kw">check_students</span>(all_schools__),
  <span class="dt">grads =</span> <span class="kw">check_graduations</span>(all_schools__),
  <span class="dt">public_funds =</span> <span class="kw">check_public_funding</span>(public_schools__)
)
<span class="kw">evaluate_plan</span>(
  <span class="dt">plan =</span> plan_template,
  <span class="dt">rules =</span> <span class="kw">list</span>(
    <span class="dt">school__ =</span> <span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>),
    <span class="dt">all_schools__ =</span>  <span class="kw">c</span>(<span class="st">&quot;school_A&quot;</span>, <span class="st">&quot;school_B&quot;</span>, <span class="st">&quot;school_C&quot;</span>),
    <span class="dt">public_schools__ =</span> <span class="kw">c</span>(<span class="st">&quot;school_A&quot;</span>, <span class="st">&quot;school_B&quot;</span>)
  )
)
<span class="co">#&gt; # A tibble: 14 x 2</span>
<span class="co">#&gt;    target                command                       </span>
<span class="co">#&gt;    &lt;chr&gt;                 &lt;expr&gt;                        </span>
<span class="co">#&gt;  1 school_A              get_school_data(&quot;A&quot;)          </span>
<span class="co">#&gt;  2 school_B              get_school_data(&quot;B&quot;)          </span>
<span class="co">#&gt;  3 school_C              get_school_data(&quot;C&quot;)          </span>
<span class="co">#&gt;  4 credits_school_A      check_credit_hours(school_A)  </span>
<span class="co">#&gt;  5 credits_school_B      check_credit_hours(school_B)  </span>
<span class="co">#&gt;  6 credits_school_C      check_credit_hours(school_C)  </span>
<span class="co">#&gt;  7 students_school_A     check_students(school_A)      </span>
<span class="co">#&gt;  8 students_school_B     check_students(school_B)      </span>
<span class="co">#&gt;  9 students_school_C     check_students(school_C)      </span>
<span class="co">#&gt; 10 grads_school_A        check_graduations(school_A)   </span>
<span class="co">#&gt; 11 grads_school_B        check_graduations(school_B)   </span>
<span class="co">#&gt; 12 grads_school_C        check_graduations(school_C)   </span>
<span class="co">#&gt; 13 public_funds_school_A check_public_funding(school_A)</span>
<span class="co">#&gt; 14 public_funds_school_B check_public_funding(school_B)</span></code></pre>
<p>Thanks to <a href="https://github.com/AlexAxthelm">Alex Axthelm</a> for this use case in <a href="https://github.com/ropensci/drake/issues/235">issue 235</a>.</p>
</div>
<div id="wildcard-clusters" class="section level3">
<h3><span class="header-section-number">6.6.3</span> Wildcard clusters</h3>
<p>With <code>evaluate_plan(trace = TRUE)</code>, you can generate columns that show how the targets were generated from the wildcards.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan_template &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">school =</span> <span class="kw">get_school_data</span>(<span class="st">&quot;school__&quot;</span>),
  <span class="dt">credits =</span> <span class="kw">check_credit_hours</span>(all_schools__),
  <span class="dt">students =</span> <span class="kw">check_students</span>(all_schools__),
  <span class="dt">grads =</span> <span class="kw">check_graduations</span>(all_schools__),
  <span class="dt">public_funds =</span> <span class="kw">check_public_funding</span>(public_schools__)
)
plan &lt;-<span class="st"> </span><span class="kw">evaluate_plan</span>(
  <span class="dt">plan =</span> plan_template,
  <span class="dt">rules =</span> <span class="kw">list</span>(
    <span class="dt">school__ =</span> <span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>),
    <span class="dt">all_schools__ =</span>  <span class="kw">c</span>(<span class="st">&quot;school_A&quot;</span>, <span class="st">&quot;school_B&quot;</span>, <span class="st">&quot;school_C&quot;</span>),
    <span class="dt">public_schools__ =</span> <span class="kw">c</span>(<span class="st">&quot;school_A&quot;</span>, <span class="st">&quot;school_B&quot;</span>)
  ),
  <span class="dt">trace =</span> <span class="ot">TRUE</span>
)
plan
<span class="co">#&gt; # A tibble: 14 x 8</span>
<span class="co">#&gt;    target command school__ school___from all_schools__ all_schools___f…</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;expr&gt;  &lt;chr&gt;    &lt;chr&gt;         &lt;chr&gt;         &lt;chr&gt;           </span>
<span class="co">#&gt;  1 schoo… get_sc… A        school        &lt;NA&gt;          &lt;NA&gt;            </span>
<span class="co">#&gt;  2 schoo… get_sc… B        school        &lt;NA&gt;          &lt;NA&gt;            </span>
<span class="co">#&gt;  3 schoo… get_sc… C        school        &lt;NA&gt;          &lt;NA&gt;            </span>
<span class="co">#&gt;  4 credi… check_… &lt;NA&gt;     &lt;NA&gt;          school_A      credits         </span>
<span class="co">#&gt;  5 credi… check_… &lt;NA&gt;     &lt;NA&gt;          school_B      credits         </span>
<span class="co">#&gt;  6 credi… check_… &lt;NA&gt;     &lt;NA&gt;          school_C      credits         </span>
<span class="co">#&gt;  7 stude… check_… &lt;NA&gt;     &lt;NA&gt;          school_A      students        </span>
<span class="co">#&gt;  8 stude… check_… &lt;NA&gt;     &lt;NA&gt;          school_B      students        </span>
<span class="co">#&gt;  9 stude… check_… &lt;NA&gt;     &lt;NA&gt;          school_C      students        </span>
<span class="co">#&gt; 10 grads… check_… &lt;NA&gt;     &lt;NA&gt;          school_A      grads           </span>
<span class="co">#&gt; 11 grads… check_… &lt;NA&gt;     &lt;NA&gt;          school_B      grads           </span>
<span class="co">#&gt; 12 grads… check_… &lt;NA&gt;     &lt;NA&gt;          school_C      grads           </span>
<span class="co">#&gt; 13 publi… check_… &lt;NA&gt;     &lt;NA&gt;          &lt;NA&gt;          &lt;NA&gt;            </span>
<span class="co">#&gt; 14 publi… check_… &lt;NA&gt;     &lt;NA&gt;          &lt;NA&gt;          &lt;NA&gt;            </span>
<span class="co">#&gt; # … with 2 more variables: public_schools__ &lt;chr&gt;,</span>
<span class="co">#&gt; #   public_schools___from &lt;chr&gt;</span></code></pre>
<p>And then when you visualize the dependency graph, you can cluster nodes based on the wildcard info.</p>
<pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span><span class="kw">drake_config</span>(plan)
<span class="kw">vis_drake_graph</span>(
  config,
  <span class="dt">group =</span> <span class="st">&quot;all_schools__&quot;</span>,
  <span class="dt">clusters =</span> <span class="kw">c</span>(<span class="st">&quot;school_A&quot;</span>, <span class="st">&quot;school_B&quot;</span>, <span class="st">&quot;school_C&quot;</span>)
)</code></pre>
<div id="htmlwidget-e3d93e3147390cf9f7b2" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-e3d93e3147390cf9f7b2">{"x":{"nodes":{"id":["check_credit_hours","check_graduations","check_public_funding","check_students","get_school_data","public_funds_school_A","public_funds_school_B","school_A","school_B","school_C","all_schools__: school_A","all_schools__: school_B","all_schools__: school_C"],"imported":[true,true,true,true,true,false,false,false,false,false,false,false,false],"label":["check_credit_hours","check_graduations","check_public_funding","check_students","get_school_data","public_funds_school_A","public_funds_school_B","school_A","school_B","school_C","all_schools__: school_A","all_schools__: school_B","all_schools__: school_C"],"command":[null,null,null,null,null,"check_public_funding(school_A)","check_public_funding(school_B)","get_school_data(\"A\")","get_school_data(\"B\")","get_school_data(\"C\")","check_credit_hours(school_A)","check_credit_hours(school_B)","check_credit_hours(school_C)"],"school__":[null,null,null,null,null,null,null,"A","B","C",null,null,null],"school___from":[null,null,null,null,null,null,null,"school","school","school",null,null,null],"all_schools__":[null,null,null,null,null,null,null,null,null,null,"school_A","school_B","school_C"],"all_schools___from":[null,null,null,null,null,null,null,null,null,null,"credits","credits","credits"],"public_schools__":[null,null,null,null,null,"school_A","school_B",null,null,null,null,null,null],"public_schools___from":[null,null,null,null,null,"public_funds","public_funds",null,null,null,null,null,null],"status":["imported","imported","imported","imported","imported","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"type":["function","function","function","function","function","object","object","object","object","object","cluster","cluster","cluster"],"font.size":[20,20,20,20,20,20,20,20,20,20,20,20,20],"color":["#1874CD","#1874CD","#1874CD","#1874CD","#1874CD","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"shape":["triangle","triangle","triangle","triangle","triangle","dot","dot","dot","dot","dot","diamond","diamond","diamond"],"level":[1,1,1,1,1,3,3,2,2,2,3,3,3],"title":["function&nbsp;()&nbsp;<br>{<br>}","function&nbsp;()&nbsp;<br>{<br>}","function&nbsp;()&nbsp;<br>{<br>}","function&nbsp;()&nbsp;<br>{<br>}","function&nbsp;()&nbsp;<br>{<br>}","check_public_funding(school_A)","check_public_funding(school_B)","get_school_data(\"A\")","get_school_data(\"B\")","get_school_data(\"C\")","credits_school_A, grads_school_A, students_sch...","credits_school_B, grads_school_B, students_sch...","credits_school_C, grads_school_C, students_sch..."],"x":[-0.523809523809524,-1,1,-0.80952380952381,0.238095238095238,0.80952380952381,1,-0.238095238095238,0.714285714285714,0.333333333333333,-1,-0.428571428571429,0.333333333333333],"y":[-1,-1,-1,-1,-1,1,1,0,0,0,1,1,1]},"edges":{"from":["check_graduations","check_graduations","check_graduations","get_school_data","get_school_data","get_school_data","check_credit_hours","check_credit_hours","check_credit_hours","check_students","check_students","check_students","check_public_funding","check_public_funding","school_A","school_A","school_B","school_B","school_C"],"to":["all_schools__: school_A","all_schools__: school_B","all_schools__: school_C","school_A","school_B","school_C","all_schools__: school_A","all_schools__: school_B","all_schools__: school_C","all_schools__: school_A","all_schools__: school_B","all_schools__: school_C","public_funds_school_A","public_funds_school_B","all_schools__: school_A","public_funds_school_A","all_schools__: school_B","public_funds_school_B","all_schools__: school_C"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","Function","Cluster"],"color":["#000000","#1874CD","#888888","#888888","#888888"],"shape":["dot","dot","dot","triangle","diamond"],"font.color":["black","black","black","black","black"],"font.size":[20,20,20,20,20],"id":[2,5,7,8,10]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>See the <a href="vis.html#vis">visualization guide</a> for more details.</p>
</div>
<div id="non-wildcard-functions" class="section level3">
<h3><span class="header-section-number">6.6.4</span> Non-wildcard functions</h3>
<div id="expand_plan" class="section level4">
<h4><span class="header-section-number">6.6.4.1</span> <code>expand_plan()</code></h4>
<p>Sometimes, you just want multiple replicates of the same targets.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">fake_data =</span> <span class="kw">simulate_from_model</span>(),
  <span class="dt">bootstrapped_data =</span> <span class="kw">bootstrap_from_real_data</span>(real_data)
)
<span class="kw">expand_plan</span>(plan, <span class="dt">values =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)
<span class="co">#&gt; # A tibble: 6 x 2</span>
<span class="co">#&gt;   target              command                            </span>
<span class="co">#&gt;   &lt;chr&gt;               &lt;expr&gt;                             </span>
<span class="co">#&gt; 1 fake_data_1         simulate_from_model()              </span>
<span class="co">#&gt; 2 fake_data_2         simulate_from_model()              </span>
<span class="co">#&gt; 3 fake_data_3         simulate_from_model()              </span>
<span class="co">#&gt; 4 bootstrapped_data_1 bootstrap_from_real_data(real_data)</span>
<span class="co">#&gt; 5 bootstrapped_data_2 bootstrap_from_real_data(real_data)</span>
<span class="co">#&gt; 6 bootstrapped_data_3 bootstrap_from_real_data(real_data)</span></code></pre>
</div>
<div id="gather_plan-and-gather_by" class="section level4">
<h4><span class="header-section-number">6.6.4.2</span> <code>gather_plan()</code> and <code>gather_by()</code></h4>
<p>Other times, you want to combine multiple targets into one.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">small =</span> <span class="kw">data.frame</span>(<span class="dt">type =</span> <span class="st">&quot;small&quot;</span>, <span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="dv">25</span>), <span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="dv">25</span>)),
  <span class="dt">large =</span> <span class="kw">data.frame</span>(<span class="dt">type =</span> <span class="st">&quot;large&quot;</span>, <span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="dv">1000</span>), <span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="dv">1000</span>))
)
<span class="kw">gather_plan</span>(plan, <span class="dt">target =</span> <span class="st">&quot;combined&quot;</span>)
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   target   command                           </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                            </span>
<span class="co">#&gt; 1 combined list(small = small, large = large)</span></code></pre>
<p>In this case, <code>small</code> and <code>large</code> are data frames, so it may be more convenient to combine the rows together.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">gather_plan</span>(plan, <span class="dt">target =</span> <span class="st">&quot;combined&quot;</span>, <span class="dt">gather =</span> <span class="st">&quot;rbind&quot;</span>)
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   target   command                            </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;                             </span>
<span class="co">#&gt; 1 combined rbind(small = small, large = large)</span></code></pre>
<p>See also <code>gather_by()</code> to gather multiple groups of targets based on other columns in the plan (e.g. from <code>evaluate_plan(trace = TRUE)</code>).</p>
</div>
<div id="reduce_plan-and-reduce_by" class="section level4">
<h4><span class="header-section-number">6.6.4.3</span> <code>reduce_plan()</code> and <code>reduce_by()</code></h4>
<p><code>reduce_plan()</code> is similar to <code>gather_plan()</code>, but it allows you to combine multiple targets together in pairs. This is useful if combining everything at once requires too much time or computer memory, or if you want to parallelize the aggregation.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">drake_plan</span>(
  <span class="dt">a =</span> <span class="dv">1</span>,
  <span class="dt">b =</span> <span class="dv">2</span>,
  <span class="dt">c =</span> <span class="dv">3</span>,
  <span class="dt">d =</span> <span class="dv">4</span>
)
<span class="kw">reduce_plan</span>(plan)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target   command            </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;             </span>
<span class="co">#&gt; 1 target_1 a + b              </span>
<span class="co">#&gt; 2 target_2 c + d              </span>
<span class="co">#&gt; 3 target   target_1 + target_2</span></code></pre>
<p>You can control how each pair of targets gets combined.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">reduce_plan</span>(plan, <span class="dt">begin =</span> <span class="st">&quot;c(&quot;</span>, <span class="dt">op =</span> <span class="st">&quot;, &quot;</span>, <span class="dt">end =</span> <span class="st">&quot;)&quot;</span>)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   target   command              </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;expr&gt;               </span>
<span class="co">#&gt; 1 target_1 c(a, b)              </span>
<span class="co">#&gt; 2 target_2 c(c, d)              </span>
<span class="co">#&gt; 3 target   c(target_1, target_2)</span></code></pre>
<p>See also <code>reduce_by()</code> to do reductions on multiple groups of targets based on other columns in the plan (e.g. from <code>evaluate_plan(trace = TRUE)</code>).</p>
</div>
</div>
<div id="custom-metaprogramming" class="section level3">
<h3><span class="header-section-number">6.6.5</span> Custom metaprogramming</h3>
<p>The <code>drake</code> plan is just a data frame. There is nothing magic about it, and you can create it any way you want. With your own custom metaprogramming, you don’t even need the <code>drake_plan()</code> function.</p>
<p>The following example could more easily be implemented with <code>map_plan()</code>, but we use other techniques to demonstrate the versatility of custom metaprogramming. Let’s consider a file-based example workflow. Here, our targets execute Linux commands to process input files and create output files.</p>
<pre><code>cat in1.txt > out1.txt
cat in2.txt > out2.txt
</code></pre>
<p>The <a href="https://github.com/tidyverse/glue"><code>glue</code></a> package can automatically generate these Linux commands.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(glue)
<span class="kw">glue_data</span>(
  <span class="kw">list</span>(
    <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">&quot;in1.txt&quot;</span>, <span class="st">&quot;in2.txt&quot;</span>), 
    <span class="dt">outputs =</span> <span class="kw">c</span>(<span class="st">&quot;out1.txt&quot;</span>, <span class="st">&quot;out2.txt&quot;</span>)
  ),
  <span class="st">&quot;cat {inputs} &gt; {outputs}&quot;</span>
)
<span class="co">#&gt; cat in1.txt &gt; out1.txt</span>
<span class="co">#&gt; cat in2.txt &gt; out2.txt</span></code></pre>
<p>Our <code>drake</code> commands will use <code>system()</code> to execute the Linux commands that <a href="https://github.com/tidyverse/glue"><code>glue</code></a> generates. Technically, we could use <code>drake_plan()</code> if we wanted.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">drake_plan</span>(
  <span class="kw">glue_data</span>(
    <span class="kw">list</span>(
      <span class="dt">inputs =</span> <span class="kw">file_in</span>(<span class="kw">c</span>(<span class="st">&quot;in1.txt&quot;</span>, <span class="st">&quot;in2.txt&quot;</span>)), 
      <span class="dt">outputs =</span> <span class="kw">file_out</span>(<span class="kw">c</span>(<span class="st">&quot;out1.txt&quot;</span>, <span class="st">&quot;out2.txt&quot;</span>))
    ),
    <span class="st">&quot;cat {inputs} &gt; {outputs}&quot;</span>
  ) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">lapply</span>(<span class="dt">FUN =</span> system)
)
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   target        command                                                    </span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;expr&gt;                                                     </span>
<span class="co">#&gt; 1 drake_target… glue_data(list(inputs = file_in(c(&quot;in1.txt&quot;, &quot;in2.txt&quot;)), …</span></code></pre>
<p>But what if we want to <em>generate</em> these <a href="https://github.com/tidyverse/glue"><code>glue</code></a> commands instead of writing them literally in our plan? This is a job for custom metaprogramming with <a href="https://www.youtube.com/watch?v=nERXS3ssntw">tidy evaluation</a>. First, we create a function to generate the <code>drake</code> command of an arbitrary target.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rlang) <span class="co"># for tidy evaluation</span>
write_command &lt;-<span class="st"> </span><span class="cf">function</span>(cmd, <span class="dt">inputs =</span> <span class="ot">NULL</span> , <span class="dt">outputs =</span> <span class="ot">NULL</span>){
  inputs &lt;-<span class="st"> </span><span class="kw">enexpr</span>(inputs)
  outputs &lt;-<span class="st"> </span><span class="kw">enexpr</span>(outputs)
  <span class="kw">expr</span>({
    <span class="kw">glue_data</span>(
      <span class="kw">list</span>(
        <span class="dt">inputs =</span> <span class="kw">file_in</span>(<span class="op">!!</span>inputs),
        <span class="dt">outputs =</span> <span class="kw">file_out</span>(<span class="op">!!</span>outputs)
      ),
      <span class="op">!!</span>cmd
    ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">lapply</span>(<span class="dt">FUN =</span> system)
  }) <span class="op">%&gt;%</span>
<span class="st">    </span>expr_text
}

<span class="kw">write_command</span>(
  <span class="dt">cmd =</span> <span class="st">&quot;cat {inputs} &gt; {outputs}&quot;</span>,
  <span class="dt">inputs =</span> <span class="kw">c</span>(<span class="st">&quot;in1.txt&quot;</span>, <span class="st">&quot;in2.txt&quot;</span>),
  <span class="dt">outputs =</span> <span class="kw">c</span>(<span class="st">&quot;out1.txt&quot;</span>, <span class="st">&quot;out2.txt&quot;</span>)
) <span class="op">%&gt;%</span>
<span class="st">  </span>cat
<span class="co">#&gt; {</span>
<span class="co">#&gt;     glue_data(list(inputs = file_in(c(&quot;in1.txt&quot;, &quot;in2.txt&quot;)), </span>
<span class="co">#&gt;         outputs = file_out(c(&quot;out1.txt&quot;, &quot;out2.txt&quot;))), &quot;cat {inputs} &gt; {outputs}&quot;) %&gt;% </span>
<span class="co">#&gt;         lapply(FUN = system)</span>
<span class="co">#&gt; }</span></code></pre>
<p>Then, we lay out all the arguments we will pass to <code>write_command()</code>. Here, each row corresponds to a separate target.</p>
<pre class="sourceCode r"><code class="sourceCode r">meta_plan &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>cmd, <span class="op">~</span>inputs, <span class="op">~</span>outputs,
  <span class="st">&quot;cat {inputs} &gt; {outputs}&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;in1.txt&quot;</span>, <span class="st">&quot;in2.txt&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;out1.txt&quot;</span>, <span class="st">&quot;out2.txt&quot;</span>),
  <span class="st">&quot;cat {inputs} {inputs} &gt; {outputs}&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;out1.txt&quot;</span>, <span class="st">&quot;out2.txt&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;out3.txt&quot;</span>, <span class="st">&quot;out4.txt&quot;</span>)
) <span class="op">%&gt;%</span>
<span class="st">  </span>print
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   cmd                               inputs    outputs  </span>
<span class="co">#&gt;   &lt;chr&gt;                             &lt;list&gt;    &lt;list&gt;   </span>
<span class="co">#&gt; 1 cat {inputs} &gt; {outputs}          &lt;chr [2]&gt; &lt;chr [2]&gt;</span>
<span class="co">#&gt; 2 cat {inputs} {inputs} &gt; {outputs} &lt;chr [2]&gt; &lt;chr [2]&gt;</span></code></pre>
<p>Finally, we create our <code>drake</code> plan without any built-in <code>drake</code> functions.</p>
<pre class="sourceCode r"><code class="sourceCode r">plan &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">target =</span> <span class="kw">paste0</span>(<span class="st">&quot;target_&quot;</span>, <span class="kw">seq_len</span>(<span class="kw">nrow</span>(meta_plan))),
  <span class="dt">command =</span> <span class="kw">pmap_chr</span>(meta_plan, write_command)
) <span class="op">%&gt;%</span>
<span class="st">  </span>print
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;                                                           </span>
<span class="co">#&gt; 1 target_1 &quot;{\n    glue_data(list(inputs = file_in(c(\&quot;in1.txt\&quot;, \&quot;in2.tx…</span>
<span class="co">#&gt; 2 target_2 &quot;{\n    glue_data(list(inputs = file_in(c(\&quot;out1.txt\&quot;, \&quot;out2.…</span>
<span class="kw">writeLines</span>(<span class="st">&quot;in1&quot;</span>, <span class="st">&quot;in1.txt&quot;</span>)
<span class="kw">writeLines</span>(<span class="st">&quot;in2&quot;</span>, <span class="st">&quot;in2.txt&quot;</span>)
<span class="kw">vis_drake_graph</span>(<span class="kw">drake_config</span>(plan))</code></pre>
<div id="htmlwidget-ff72399370c1bb4b860b" style="width:576px;height:576px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ff72399370c1bb4b860b">{"x":{"nodes":{"id":["p-N52XIMJOOR4HI","p-N52XIMROOR4HI","p-N52XIMZOOR4HI","p-N52XINBOOR4HI","p-NFXDCLTUPB2A","p-NFXDELTUPB2A","target_1","target_2"],"imported":[false,false,false,false,true,true,false,false],"label":["file out1.txt","file out2.txt","file out3.txt","file out4.txt","file in1.txt","file in2.txt","target_1","target_2"],"command":["{     glue_data(list(inputs = file_in(c(\"in1.txt\", \"in2.txt\")),          outputs = file_out(c(\"out1.txt\", \"out2.txt\"))), \"cat {inputs} > {outputs}\") %>%          lapply(FUN = system) }","{     glue_data(list(inputs = file_in(c(\"in1.txt\", \"in2.txt\")),          outputs = file_out(c(\"out1.txt\", \"out2.txt\"))), \"cat {inputs} > {outputs}\") %>%          lapply(FUN = system) }","{     glue_data(list(inputs = file_in(c(\"out1.txt\", \"out2.txt\")),          outputs = file_out(c(\"out3.txt\", \"out4.txt\"))), \"cat {inputs} {inputs} > {outputs}\") %>%          lapply(FUN = system) }","{     glue_data(list(inputs = file_in(c(\"out1.txt\", \"out2.txt\")),          outputs = file_out(c(\"out3.txt\", \"out4.txt\"))), \"cat {inputs} {inputs} > {outputs}\") %>%          lapply(FUN = system) }",null,null,"{     glue_data(list(inputs = file_in(c(\"in1.txt\", \"in2.txt\")),          outputs = file_out(c(\"out1.txt\", \"out2.txt\"))), \"cat {inputs} > {outputs}\") %>%          lapply(FUN = system) }","{     glue_data(list(inputs = file_in(c(\"out1.txt\", \"out2.txt\")),          outputs = file_out(c(\"out3.txt\", \"out4.txt\"))), \"cat {inputs} {inputs} > {outputs}\") %>%          lapply(FUN = system) }"],"status":["outdated","outdated","outdated","outdated","imported","imported","outdated","outdated"],"type":["object","object","object","object","file","file","object","object"],"font.size":[20,20,20,20,20,20,20,20],"color":["#000000","#000000","#000000","#000000","#1874CD","#1874CD","#000000","#000000"],"shape":["square","square","square","square","square","square","dot","dot"],"level":[3,3,5,5,1,1,2,4],"title":["{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"in1.t...","{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"in1.t...","{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"out1....","{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"out1....","in1","in2","{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"in1.t...","{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue_data(list(inputs&nbsp;=&nbsp;file_in(c(\"out1...."],"x":[-1,0.333333333333333,0.333333333333333,1,0.333333333333333,1,0.333333333333333,0.333333333333333],"y":[0,0,1,1,-1,-1,-0.5,0.5]},"edges":{"from":["p-NFXDELTUPB2A","p-NFXDCLTUPB2A","target_1","target_1","target_1","p-N52XIMJOOR4HI","p-N52XIMROOR4HI","target_2","target_2"],"to":["target_1","target_1","p-N52XIMJOOR4HI","p-N52XIMROOR4HI","target_2","target_2","target_2","p-N52XIMZOOR4HI","p-N52XINBOOR4HI"],"arrows":["to","to","to","to","to","to","to","to","to"],"smooth":[true,true,true,true,true,true,true,true,true]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}},"edges":{"smooth":false},"physics":{"stabilization":false},"interaction":{"navigationButtons":true}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)"},"main":{"text":"Dependency graph","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":false,"hoverNearest":false,"degree":1,"algorithm":"all","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"left","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Imported","Object","File"],"color":["#000000","#1874CD","#888888","#888888"],"shape":["dot","dot","dot","square"],"font.color":["black","black","black","black"],"font.size":[20,20,20,20],"id":[2,5,7,9]},"nodesToDataframe":true},"igraphlayout":{"type":"square"},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p>Alternatively, you could use <code>as.call()</code> instead of tidy evaluation to generate your plan. Use <code>as.call()</code> to construct calls to <code>file_in()</code>, <code>file_out()</code>, and custom functions in your commands.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(purrr) <span class="co"># pmap_chr() is particularly useful here.</span>

<span class="co"># A function that will be called in your commands.</span>
command_function &lt;-<span class="st"> </span><span class="cf">function</span>(cmd, inputs, outputs){
  <span class="kw">glue_data</span>(
    <span class="kw">list</span>(
      <span class="dt">inputs =</span> inputs,
      <span class="dt">outputs =</span> outputs
    ),
    cmd
  ) <span class="op">%&gt;%</span>
<span class="st">    </span>purrr<span class="op">::</span><span class="kw">walk</span>(system)
}

<span class="co"># A function to generate quoted calls to command_function(),</span>
<span class="co"># which in turn contain quoted calls to file_in() and file_out().</span>
write_command &lt;-<span class="st"> </span><span class="cf">function</span>(...){
  args &lt;-<span class="st"> </span><span class="kw">list</span>(...)
  args<span class="op">$</span>inputs &lt;-<span class="st"> </span><span class="kw">as.call</span>(<span class="kw">list</span>(<span class="kw">quote</span>(file_in), args<span class="op">$</span>inputs))
  args<span class="op">$</span>outputs &lt;-<span class="st"> </span><span class="kw">as.call</span>(<span class="kw">list</span>(<span class="kw">quote</span>(file_out), args<span class="op">$</span>outputs))
  <span class="kw">c</span>(<span class="kw">quote</span>(command_function), args) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as.call</span>() <span class="op">%&gt;%</span>
<span class="st">    </span>rlang<span class="op">::</span><span class="kw">expr_text</span>()
}

plan &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">target =</span> <span class="kw">paste0</span>(<span class="st">&quot;target_&quot;</span>, <span class="kw">seq_len</span>(<span class="kw">nrow</span>(meta_plan))),
  <span class="dt">command =</span> <span class="kw">pmap_chr</span>(meta_plan, write_command)
) <span class="op">%&gt;%</span>
<span class="st">  </span>print
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   target   command                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;                                                           </span>
<span class="co">#&gt; 1 target_1 &quot;command_function(cmd = \&quot;cat {inputs} &gt; {outputs}\&quot;, inputs = …</span>
<span class="co">#&gt; 2 target_2 &quot;command_function(cmd = \&quot;cat {inputs} {inputs} &gt; {outputs}\&quot;, …</span></code></pre>
<p>Metaprogramming gets much simpler if you do not need to construct literal calls to <code>file_in()</code>, <code>file_out()</code>, etc. in your commands. The construction of <code>model_plan</code> in the <a href="gsp.html#gsp">gross state product exmaple</a> is an example.</p>
<p>Thanks to <a href="https://github.com/cfhammill">Chris Hammill</a> for <a href="https://github.com/ropensci/drake/issues/451">presenting this scenario and contributing to the solution</a>.</p>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>You can turn the <code>command</code> column of your plan into a character vector (e.g. <code>plan$command &lt;- purrr::map_chr(plan$command, rlang::expr_text)</code>) and <code>drake</code> will still understand you. However, the recommended format is a list of <a href="http://adv-r.had.co.nz/Expressions.html">expressions</a>. <code>drake_plan()</code> and friends always supply <a href="http://adv-r.had.co.nz/Expressions.html">expression</a> lists.<a href="plans.html#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><code>drake_plan()</code> is the best way to create plans, but you can create plans any way you like. <code>drake</code> will understand plans you create directly using <code>data.frame()</code> or <code>tibble()</code>.<a href="plans.html#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
<div style = "background: #1C356D; color: white; padding: 10px 10px 10px 25px; font-size: 1em; width: 100%;">
  Copyright Eli Lilly and Company
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mtcars.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="organize.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
